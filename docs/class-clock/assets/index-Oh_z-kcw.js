(function(){const h=document.createElement("link").relList;if(h&&h.supports&&h.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))m(s);new MutationObserver(s=>{for(const e of s)if(e.type==="childList")for(const n of e.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&m(n)}).observe(document,{childList:!0,subtree:!0});function d(s){const e={};return s.integrity&&(e.integrity=s.integrity),s.referrerPolicy&&(e.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?e.credentials="include":s.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function m(s){if(s.ep)return;s.ep=!0;const e=d(s);fetch(s.href,e)}})();function qe(){return{clockDisplayArea:document.getElementById("clock-display-area"),timeEl:document.getElementById("time"),dateEl:document.getElementById("date"),scheduleCirclesDisplayEl:document.getElementById("schedule-circles-display"),periodContainerEl:document.getElementById("period-container"),periodLabelEl:document.getElementById("period-label"),progressBarEl:document.getElementById("progress-bar"),progressEl:document.getElementById("progress"),timeLeftEl:document.getElementById("time-left"),sandBarsContainerEl:document.getElementById("sand-bars-container"),sandBarsCanvas:document.getElementById("sand-bars-canvas"),waterFillContainerEl:document.getElementById("water-fill-container"),waterFillCanvas:document.getElementById("water-fill-canvas"),alertModal:document.getElementById("alert-modal"),alertModalTitle:document.getElementById("modal-title"),alertModalBody:document.getElementById("modal-body"),closeModalBtn:document.querySelector("#alert-modal .close-modal-btn"),menuToggle:document.getElementById("menu-toggle"),settingsMenu:document.getElementById("settings-menu"),menuResizer:document.getElementById("menu-resizer"),settingsNav:document.getElementById("settings-nav"),tabsContainer:document.getElementById("tabs"),tabContentsContainer:document.getElementById("tab-contents"),appearanceTab:document.getElementById("appearance-tab"),scheduleAlertsTab:document.getElementById("schedule-alerts-tab"),displayElementsChecklist:document.getElementById("display-elements-checklist"),fontSelect:document.getElementById("pref-font"),dateFontSizeInput:document.getElementById("pref-date-font"),timeFontSizeInput:document.getElementById("pref-time-font"),labelFontSizeInput:document.getElementById("pref-schedule-label-font"),timeLeftFontSizeInput:document.getElementById("pref-time-left-font"),progressHeightInput:document.getElementById("pref-progress-height"),resetAppearanceBtn:document.getElementById("reset-appearance-defaults"),resetSchemesBtn:document.getElementById("reset-schemes-defaults"),colorSchemeTabsContainer:document.getElementById("colour-scheme-tabs"),colorSchemeContentContainer:document.getElementById("colour-scheme-content"),scheduleTableBody:document.querySelector("#schedule-table tbody"),addScheduleRowBtn:document.getElementById("add-schedule-row"),deleteScheduleRowBtn:document.getElementById("delete-schedule-row"),timeSyncSection:document.getElementById("time-sync-section"),syncToBellBtn:document.getElementById("sync-to-bell"),offsetMinDownBtn:document.getElementById("offset-min-down"),offsetMinUpBtn:document.getElementById("offset-min-up"),offsetSecDownBtn:document.getElementById("offset-sec-down"),offsetSecUpBtn:document.getElementById("offset-sec-up"),resetOffsetBtn:document.getElementById("reset-offset"),currentOffsetDisplay:document.getElementById("current-offset")}}let B={};function Je(){B=qe(),console.log("DOM Cache Updated",B)}const X={getTodayTime:function(i){if(!i||!/^\d{2}:\d{2}$/.test(i)){const s=new Date;return s.setSeconds(0,0),s}const[h,d]=i.split(":").map(Number),m=new Date;return m.setHours(h,d,0,0),m},formatTime:function(i){let h=i.getHours();const d=i.getMinutes(),m=h>=12?"PM":"AM";return h=h%12||12,`${h}:${d<10?"0"+d:d} ${m}`},formatDate:function(i){const h={weekday:"long",month:"long",day:"numeric"};return i.toLocaleDateString(void 0,h)},showFeedback:function(i,h,d=!0){i&&(i.textContent=h,i.classList.remove("success","error"),i.classList.add(d?"success":"error"),i.style.display="block",setTimeout(()=>{i&&(i.style.display="none")},3e3))},showButtonFeedback:function(i,h="Saved!",d=1500){if(!i)return;const m=i.textContent;i.textContent=h,i.classList.add("button-success"),i.disabled=!0,setTimeout(()=>{i&&(i.textContent=m,i.classList.remove("button-success"),i.disabled=!1)},d)},lightenColor:function(i,h){if(!i||(i=i.replace(/^#/,""),i.length!==6))return"#cccccc";try{let d=parseInt(i.substring(0,2),16),m=parseInt(i.substring(2,4),16),s=parseInt(i.substring(4,6),16);d=Math.min(255,Math.floor(d*(1+h/100))),m=Math.min(255,Math.floor(m*(1+h/100))),s=Math.min(255,Math.floor(s*(1+h/100)));const e=d.toString(16).padStart(2,"0"),n=m.toString(16).padStart(2,"0"),r=s.toString(16).padStart(2,"0");return`#${e}${n}${r}`}catch(d){return console.error("Error lightening color:",i,d),"#cccccc"}}};function le(){const i=y.preferences&&y.preferences.timeOffsetMs?Number(y.preferences.timeOffsetMs):0,h=new Date;return new Date(h.getTime()+i)}const k={currentPeriodLabel:null,currentPeriodIndex:null,activeVisualAlertInterval:null,activeVisualAlertTimeout:null,originalBodyStyles:{},selectedScheduleRowIndex:null,isResizingMenu:!1,dragStartIndex:null,SAND_COLORS:["#fba1bd","#dfb37a","#8aca91","#54cce2","#b6b6fd"],physicsCheckIntervalId:null,physicsCheckIntervalMs:100,physicsParticlesAdded:0,visualMaxParticlesPerSegment:0,totalParticlesForPeriod:0};var Fe=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Xe(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Se={exports:{}};var Qe=Se.exports,De;function Ye(){return De||(De=1,(function(i,h){(function(m,s){i.exports=s()})(Qe,function(){return(function(d){var m={};function s(e){if(m[e])return m[e].exports;var n=m[e]={i:e,l:!1,exports:{}};return d[e].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=d,s.c=m,s.d=function(e,n,r){s.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},s.r=function(e){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,n){if(n&1&&(e=s(e)),n&8||n&4&&typeof e=="object"&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),n&2&&typeof e!="string")for(var a in e)s.d(r,a,(function(u){return e[u]}).bind(null,a));return r},s.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(n,"a",n),n},s.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},s.p="",s(s.s=20)})([(function(d,m){var s={};d.exports=s,(function(){s._baseDelta=1e3/60,s._nextId=0,s._seed=0,s._nowStartTime=+new Date,s._warnedOnce={},s._decomp=null,s.extend=function(n,r){var a,u;typeof r=="boolean"?(a=2,u=r):(a=1,u=!0);for(var f=a;f<arguments.length;f++){var g=arguments[f];if(g)for(var l in g)u&&g[l]&&g[l].constructor===Object&&(!n[l]||n[l].constructor===Object)?(n[l]=n[l]||{},s.extend(n[l],u,g[l])):n[l]=g[l]}return n},s.clone=function(n,r){return s.extend({},r,n)},s.keys=function(n){if(Object.keys)return Object.keys(n);var r=[];for(var a in n)r.push(a);return r},s.values=function(n){var r=[];if(Object.keys){for(var a=Object.keys(n),u=0;u<a.length;u++)r.push(n[a[u]]);return r}for(var f in n)r.push(n[f]);return r},s.get=function(n,r,a,u){r=r.split(".").slice(a,u);for(var f=0;f<r.length;f+=1)n=n[r[f]];return n},s.set=function(n,r,a,u,f){var g=r.split(".").slice(u,f);return s.get(n,r,0,-1)[g[g.length-1]]=a,a},s.shuffle=function(n){for(var r=n.length-1;r>0;r--){var a=Math.floor(s.random()*(r+1)),u=n[r];n[r]=n[a],n[a]=u}return n},s.choose=function(n){return n[Math.floor(s.random()*n.length)]},s.isElement=function(n){return typeof HTMLElement<"u"?n instanceof HTMLElement:!!(n&&n.nodeType&&n.nodeName)},s.isArray=function(n){return Object.prototype.toString.call(n)==="[object Array]"},s.isFunction=function(n){return typeof n=="function"},s.isPlainObject=function(n){return typeof n=="object"&&n.constructor===Object},s.isString=function(n){return toString.call(n)==="[object String]"},s.clamp=function(n,r,a){return n<r?r:n>a?a:n},s.sign=function(n){return n<0?-1:1},s.now=function(){if(typeof window<"u"&&window.performance){if(window.performance.now)return window.performance.now();if(window.performance.webkitNow)return window.performance.webkitNow()}return Date.now?Date.now():new Date-s._nowStartTime},s.random=function(n,r){return n=typeof n<"u"?n:0,r=typeof r<"u"?r:1,n+e()*(r-n)};var e=function(){return s._seed=(s._seed*9301+49297)%233280,s._seed/233280};s.colorToNumber=function(n){return n=n.replace("#",""),n.length==3&&(n=n.charAt(0)+n.charAt(0)+n.charAt(1)+n.charAt(1)+n.charAt(2)+n.charAt(2)),parseInt(n,16)},s.logLevel=1,s.log=function(){console&&s.logLevel>0&&s.logLevel<=3&&console.log.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},s.info=function(){console&&s.logLevel>0&&s.logLevel<=2&&console.info.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},s.warn=function(){console&&s.logLevel>0&&s.logLevel<=3&&console.warn.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},s.warnOnce=function(){var n=Array.prototype.slice.call(arguments).join(" ");s._warnedOnce[n]||(s.warn(n),s._warnedOnce[n]=!0)},s.deprecated=function(n,r,a){n[r]=s.chain(function(){s.warnOnce("ðŸ”… deprecated ðŸ”…",a)},n[r])},s.nextId=function(){return s._nextId++},s.indexOf=function(n,r){if(n.indexOf)return n.indexOf(r);for(var a=0;a<n.length;a++)if(n[a]===r)return a;return-1},s.map=function(n,r){if(n.map)return n.map(r);for(var a=[],u=0;u<n.length;u+=1)a.push(r(n[u]));return a},s.topologicalSort=function(n){var r=[],a=[],u=[];for(var f in n)!a[f]&&!u[f]&&s._topologicalSort(f,a,u,n,r);return r},s._topologicalSort=function(n,r,a,u,f){var g=u[n]||[];a[n]=!0;for(var l=0;l<g.length;l+=1){var t=g[l];a[t]||r[t]||s._topologicalSort(t,r,a,u,f)}a[n]=!1,r[n]=!0,f.push(n)},s.chain=function(){for(var n=[],r=0;r<arguments.length;r+=1){var a=arguments[r];a._chained?n.push.apply(n,a._chained):n.push(a)}var u=function(){for(var f,g=new Array(arguments.length),l=0,t=arguments.length;l<t;l++)g[l]=arguments[l];for(l=0;l<n.length;l+=1){var o=n[l].apply(f,g);typeof o<"u"&&(f=o)}return f};return u._chained=n,u},s.chainPathBefore=function(n,r,a){return s.set(n,r,s.chain(a,s.get(n,r)))},s.chainPathAfter=function(n,r,a){return s.set(n,r,s.chain(s.get(n,r),a))},s.setDecomp=function(n){s._decomp=n},s.getDecomp=function(){var n=s._decomp;try{!n&&typeof window<"u"&&(n=window.decomp),!n&&typeof Fe<"u"&&(n=Fe.decomp)}catch{n=null}return n}})()}),(function(d,m){var s={};d.exports=s,(function(){s.create=function(e){var n={min:{x:0,y:0},max:{x:0,y:0}};return e&&s.update(n,e),n},s.update=function(e,n,r){e.min.x=1/0,e.max.x=-1/0,e.min.y=1/0,e.max.y=-1/0;for(var a=0;a<n.length;a++){var u=n[a];u.x>e.max.x&&(e.max.x=u.x),u.x<e.min.x&&(e.min.x=u.x),u.y>e.max.y&&(e.max.y=u.y),u.y<e.min.y&&(e.min.y=u.y)}r&&(r.x>0?e.max.x+=r.x:e.min.x+=r.x,r.y>0?e.max.y+=r.y:e.min.y+=r.y)},s.contains=function(e,n){return n.x>=e.min.x&&n.x<=e.max.x&&n.y>=e.min.y&&n.y<=e.max.y},s.overlaps=function(e,n){return e.min.x<=n.max.x&&e.max.x>=n.min.x&&e.max.y>=n.min.y&&e.min.y<=n.max.y},s.translate=function(e,n){e.min.x+=n.x,e.max.x+=n.x,e.min.y+=n.y,e.max.y+=n.y},s.shift=function(e,n){var r=e.max.x-e.min.x,a=e.max.y-e.min.y;e.min.x=n.x,e.max.x=n.x+r,e.min.y=n.y,e.max.y=n.y+a}})()}),(function(d,m){var s={};d.exports=s,(function(){s.create=function(e,n){return{x:e||0,y:n||0}},s.clone=function(e){return{x:e.x,y:e.y}},s.magnitude=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},s.magnitudeSquared=function(e){return e.x*e.x+e.y*e.y},s.rotate=function(e,n,r){var a=Math.cos(n),u=Math.sin(n);r||(r={});var f=e.x*a-e.y*u;return r.y=e.x*u+e.y*a,r.x=f,r},s.rotateAbout=function(e,n,r,a){var u=Math.cos(n),f=Math.sin(n);a||(a={});var g=r.x+((e.x-r.x)*u-(e.y-r.y)*f);return a.y=r.y+((e.x-r.x)*f+(e.y-r.y)*u),a.x=g,a},s.normalise=function(e){var n=s.magnitude(e);return n===0?{x:0,y:0}:{x:e.x/n,y:e.y/n}},s.dot=function(e,n){return e.x*n.x+e.y*n.y},s.cross=function(e,n){return e.x*n.y-e.y*n.x},s.cross3=function(e,n,r){return(n.x-e.x)*(r.y-e.y)-(n.y-e.y)*(r.x-e.x)},s.add=function(e,n,r){return r||(r={}),r.x=e.x+n.x,r.y=e.y+n.y,r},s.sub=function(e,n,r){return r||(r={}),r.x=e.x-n.x,r.y=e.y-n.y,r},s.mult=function(e,n){return{x:e.x*n,y:e.y*n}},s.div=function(e,n){return{x:e.x/n,y:e.y/n}},s.perp=function(e,n){return n=n===!0?-1:1,{x:n*-e.y,y:n*e.x}},s.neg=function(e){return{x:-e.x,y:-e.y}},s.angle=function(e,n){return Math.atan2(n.y-e.y,n.x-e.x)},s._temp=[s.create(),s.create(),s.create(),s.create(),s.create(),s.create()]})()}),(function(d,m,s){var e={};d.exports=e;var n=s(2),r=s(0);(function(){e.create=function(a,u){for(var f=[],g=0;g<a.length;g++){var l=a[g],t={x:l.x,y:l.y,index:g,body:u,isInternal:!1};f.push(t)}return f},e.fromPath=function(a,u){var f=/L?\s*([-\d.e]+)[\s,]*([-\d.e]+)*/ig,g=[];return a.replace(f,function(l,t,o){g.push({x:parseFloat(t),y:parseFloat(o)})}),e.create(g,u)},e.centre=function(a){for(var u=e.area(a,!0),f={x:0,y:0},g,l,t,o=0;o<a.length;o++)t=(o+1)%a.length,g=n.cross(a[o],a[t]),l=n.mult(n.add(a[o],a[t]),g),f=n.add(f,l);return n.div(f,6*u)},e.mean=function(a){for(var u={x:0,y:0},f=0;f<a.length;f++)u.x+=a[f].x,u.y+=a[f].y;return n.div(u,a.length)},e.area=function(a,u){for(var f=0,g=a.length-1,l=0;l<a.length;l++)f+=(a[g].x-a[l].x)*(a[g].y+a[l].y),g=l;return u?f/2:Math.abs(f)/2},e.inertia=function(a,u){for(var f=0,g=0,l=a,t,o,c=0;c<l.length;c++)o=(c+1)%l.length,t=Math.abs(n.cross(l[o],l[c])),f+=t*(n.dot(l[o],l[o])+n.dot(l[o],l[c])+n.dot(l[c],l[c])),g+=t;return u/6*(f/g)},e.translate=function(a,u,f){f=typeof f<"u"?f:1;var g=a.length,l=u.x*f,t=u.y*f,o;for(o=0;o<g;o++)a[o].x+=l,a[o].y+=t;return a},e.rotate=function(a,u,f){if(u!==0){var g=Math.cos(u),l=Math.sin(u),t=f.x,o=f.y,c=a.length,p,x,M,E;for(E=0;E<c;E++)p=a[E],x=p.x-t,M=p.y-o,p.x=t+(x*g-M*l),p.y=o+(x*l+M*g);return a}},e.contains=function(a,u){for(var f=u.x,g=u.y,l=a.length,t=a[l-1],o,c=0;c<l;c++){if(o=a[c],(f-t.x)*(o.y-t.y)+(g-t.y)*(t.x-o.x)>0)return!1;t=o}return!0},e.scale=function(a,u,f,g){if(u===1&&f===1)return a;g=g||e.centre(a);for(var l,t,o=0;o<a.length;o++)l=a[o],t=n.sub(l,g),a[o].x=g.x+t.x*u,a[o].y=g.y+t.y*f;return a},e.chamfer=function(a,u,f,g,l){typeof u=="number"?u=[u]:u=u||[8],f=typeof f<"u"?f:-1,g=g||2,l=l||14;for(var t=[],o=0;o<a.length;o++){var c=a[o-1>=0?o-1:a.length-1],p=a[o],x=a[(o+1)%a.length],M=u[o<u.length?o:u.length-1];if(M===0){t.push(p);continue}var E=n.normalise({x:p.y-c.y,y:c.x-p.x}),T=n.normalise({x:x.y-p.y,y:p.x-x.x}),v=Math.sqrt(2*Math.pow(M,2)),S=n.mult(r.clone(E),M),P=n.normalise(n.mult(n.add(E,T),.5)),C=n.sub(p,n.mult(P,v)),I=f;f===-1&&(I=Math.pow(M,.32)*1.75),I=r.clamp(I,g,l),I%2===1&&(I+=1);for(var w=Math.acos(n.dot(E,T)),b=w/I,A=0;A<I;A++)t.push(n.add(n.rotate(S,b*A),C))}return t},e.clockwiseSort=function(a){var u=e.mean(a);return a.sort(function(f,g){return n.angle(u,f)-n.angle(u,g)}),a},e.isConvex=function(a){var u=0,f=a.length,g,l,t,o;if(f<3)return null;for(g=0;g<f;g++)if(l=(g+1)%f,t=(g+2)%f,o=(a[l].x-a[g].x)*(a[t].y-a[l].y),o-=(a[l].y-a[g].y)*(a[t].x-a[l].x),o<0?u|=1:o>0&&(u|=2),u===3)return!1;return u!==0?!0:null},e.hull=function(a){var u=[],f=[],g,l;for(a=a.slice(0),a.sort(function(t,o){var c=t.x-o.x;return c!==0?c:t.y-o.y}),l=0;l<a.length;l+=1){for(g=a[l];f.length>=2&&n.cross3(f[f.length-2],f[f.length-1],g)<=0;)f.pop();f.push(g)}for(l=a.length-1;l>=0;l-=1){for(g=a[l];u.length>=2&&n.cross3(u[u.length-2],u[u.length-1],g)<=0;)u.pop();u.push(g)}return u.pop(),f.pop(),u.concat(f)}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(3),r=s(2),a=s(7),u=s(0),f=s(1),g=s(11);(function(){e._timeCorrection=!0,e._inertiaScale=4,e._nextCollidingGroupId=1,e._nextNonCollidingGroupId=-1,e._nextCategory=1,e._baseDelta=1e3/60,e.create=function(t){var o={id:u.nextId(),type:"body",label:"Body",parts:[],plugin:{},angle:0,vertices:n.fromPath("L 0 0 L 40 0 L 40 40 L 0 40"),position:{x:0,y:0},force:{x:0,y:0},torque:0,positionImpulse:{x:0,y:0},constraintImpulse:{x:0,y:0,angle:0},totalContacts:0,speed:0,angularSpeed:0,velocity:{x:0,y:0},angularVelocity:0,isSensor:!1,isStatic:!1,isSleeping:!1,motion:0,sleepThreshold:60,density:.001,restitution:0,friction:.1,frictionStatic:.5,frictionAir:.01,collisionFilter:{category:1,mask:4294967295,group:0},slop:.05,timeScale:1,render:{visible:!0,opacity:1,strokeStyle:null,fillStyle:null,lineWidth:null,sprite:{xScale:1,yScale:1,xOffset:0,yOffset:0}},events:null,bounds:null,chamfer:null,circleRadius:0,positionPrev:null,anglePrev:0,parent:null,axes:null,area:0,mass:0,inertia:0,deltaTime:16.666666666666668,_original:null},c=u.extend(o,t);return l(c,t),c},e.nextGroup=function(t){return t?e._nextNonCollidingGroupId--:e._nextCollidingGroupId++},e.nextCategory=function(){return e._nextCategory=e._nextCategory<<1,e._nextCategory};var l=function(t,o){o=o||{},e.set(t,{bounds:t.bounds||f.create(t.vertices),positionPrev:t.positionPrev||r.clone(t.position),anglePrev:t.anglePrev||t.angle,vertices:t.vertices,parts:t.parts||[t],isStatic:t.isStatic,isSleeping:t.isSleeping,parent:t.parent||t}),n.rotate(t.vertices,t.angle,t.position),g.rotate(t.axes,t.angle),f.update(t.bounds,t.vertices,t.velocity),e.set(t,{axes:o.axes||t.axes,area:o.area||t.area,mass:o.mass||t.mass,inertia:o.inertia||t.inertia});var c=t.isStatic?"#14151f":u.choose(["#f19648","#f5d259","#f55a3c","#063e7b","#ececd1"]),p=t.isStatic?"#555":"#ccc",x=t.isStatic&&t.render.fillStyle===null?1:0;t.render.fillStyle=t.render.fillStyle||c,t.render.strokeStyle=t.render.strokeStyle||p,t.render.lineWidth=t.render.lineWidth||x,t.render.sprite.xOffset+=-(t.bounds.min.x-t.position.x)/(t.bounds.max.x-t.bounds.min.x),t.render.sprite.yOffset+=-(t.bounds.min.y-t.position.y)/(t.bounds.max.y-t.bounds.min.y)};e.set=function(t,o,c){var p;typeof o=="string"&&(p=o,o={},o[p]=c);for(p in o)if(Object.prototype.hasOwnProperty.call(o,p))switch(c=o[p],p){case"isStatic":e.setStatic(t,c);break;case"isSleeping":a.set(t,c);break;case"mass":e.setMass(t,c);break;case"density":e.setDensity(t,c);break;case"inertia":e.setInertia(t,c);break;case"vertices":e.setVertices(t,c);break;case"position":e.setPosition(t,c);break;case"angle":e.setAngle(t,c);break;case"velocity":e.setVelocity(t,c);break;case"angularVelocity":e.setAngularVelocity(t,c);break;case"speed":e.setSpeed(t,c);break;case"angularSpeed":e.setAngularSpeed(t,c);break;case"parts":e.setParts(t,c);break;case"centre":e.setCentre(t,c);break;default:t[p]=c}},e.setStatic=function(t,o){for(var c=0;c<t.parts.length;c++){var p=t.parts[c];p.isStatic=o,o?(p._original={restitution:p.restitution,friction:p.friction,mass:p.mass,inertia:p.inertia,density:p.density,inverseMass:p.inverseMass,inverseInertia:p.inverseInertia},p.restitution=0,p.friction=1,p.mass=p.inertia=p.density=1/0,p.inverseMass=p.inverseInertia=0,p.positionPrev.x=p.position.x,p.positionPrev.y=p.position.y,p.anglePrev=p.angle,p.angularVelocity=0,p.speed=0,p.angularSpeed=0,p.motion=0):p._original&&(p.restitution=p._original.restitution,p.friction=p._original.friction,p.mass=p._original.mass,p.inertia=p._original.inertia,p.density=p._original.density,p.inverseMass=p._original.inverseMass,p.inverseInertia=p._original.inverseInertia,p._original=null)}},e.setMass=function(t,o){var c=t.inertia/(t.mass/6);t.inertia=c*(o/6),t.inverseInertia=1/t.inertia,t.mass=o,t.inverseMass=1/t.mass,t.density=t.mass/t.area},e.setDensity=function(t,o){e.setMass(t,o*t.area),t.density=o},e.setInertia=function(t,o){t.inertia=o,t.inverseInertia=1/t.inertia},e.setVertices=function(t,o){o[0].body===t?t.vertices=o:t.vertices=n.create(o,t),t.axes=g.fromVertices(t.vertices),t.area=n.area(t.vertices),e.setMass(t,t.density*t.area);var c=n.centre(t.vertices);n.translate(t.vertices,c,-1),e.setInertia(t,e._inertiaScale*n.inertia(t.vertices,t.mass)),n.translate(t.vertices,t.position),f.update(t.bounds,t.vertices,t.velocity)},e.setParts=function(t,o,c){var p;for(o=o.slice(0),t.parts.length=0,t.parts.push(t),t.parent=t,p=0;p<o.length;p++){var x=o[p];x!==t&&(x.parent=t,t.parts.push(x))}if(t.parts.length!==1){if(c=typeof c<"u"?c:!0,c){var M=[];for(p=0;p<o.length;p++)M=M.concat(o[p].vertices);n.clockwiseSort(M);var E=n.hull(M),T=n.centre(E);e.setVertices(t,E),n.translate(t.vertices,T)}var v=e._totalProperties(t);t.area=v.area,t.parent=t,t.position.x=v.centre.x,t.position.y=v.centre.y,t.positionPrev.x=v.centre.x,t.positionPrev.y=v.centre.y,e.setMass(t,v.mass),e.setInertia(t,v.inertia),e.setPosition(t,v.centre)}},e.setCentre=function(t,o,c){c?(t.positionPrev.x+=o.x,t.positionPrev.y+=o.y,t.position.x+=o.x,t.position.y+=o.y):(t.positionPrev.x=o.x-(t.position.x-t.positionPrev.x),t.positionPrev.y=o.y-(t.position.y-t.positionPrev.y),t.position.x=o.x,t.position.y=o.y)},e.setPosition=function(t,o,c){var p=r.sub(o,t.position);c?(t.positionPrev.x=t.position.x,t.positionPrev.y=t.position.y,t.velocity.x=p.x,t.velocity.y=p.y,t.speed=r.magnitude(p)):(t.positionPrev.x+=p.x,t.positionPrev.y+=p.y);for(var x=0;x<t.parts.length;x++){var M=t.parts[x];M.position.x+=p.x,M.position.y+=p.y,n.translate(M.vertices,p),f.update(M.bounds,M.vertices,t.velocity)}},e.setAngle=function(t,o,c){var p=o-t.angle;c?(t.anglePrev=t.angle,t.angularVelocity=p,t.angularSpeed=Math.abs(p)):t.anglePrev+=p;for(var x=0;x<t.parts.length;x++){var M=t.parts[x];M.angle+=p,n.rotate(M.vertices,p,t.position),g.rotate(M.axes,p),f.update(M.bounds,M.vertices,t.velocity),x>0&&r.rotateAbout(M.position,p,t.position,M.position)}},e.setVelocity=function(t,o){var c=t.deltaTime/e._baseDelta;t.positionPrev.x=t.position.x-o.x*c,t.positionPrev.y=t.position.y-o.y*c,t.velocity.x=(t.position.x-t.positionPrev.x)/c,t.velocity.y=(t.position.y-t.positionPrev.y)/c,t.speed=r.magnitude(t.velocity)},e.getVelocity=function(t){var o=e._baseDelta/t.deltaTime;return{x:(t.position.x-t.positionPrev.x)*o,y:(t.position.y-t.positionPrev.y)*o}},e.getSpeed=function(t){return r.magnitude(e.getVelocity(t))},e.setSpeed=function(t,o){e.setVelocity(t,r.mult(r.normalise(e.getVelocity(t)),o))},e.setAngularVelocity=function(t,o){var c=t.deltaTime/e._baseDelta;t.anglePrev=t.angle-o*c,t.angularVelocity=(t.angle-t.anglePrev)/c,t.angularSpeed=Math.abs(t.angularVelocity)},e.getAngularVelocity=function(t){return(t.angle-t.anglePrev)*e._baseDelta/t.deltaTime},e.getAngularSpeed=function(t){return Math.abs(e.getAngularVelocity(t))},e.setAngularSpeed=function(t,o){e.setAngularVelocity(t,u.sign(e.getAngularVelocity(t))*o)},e.translate=function(t,o,c){e.setPosition(t,r.add(t.position,o),c)},e.rotate=function(t,o,c,p){if(!c)e.setAngle(t,t.angle+o,p);else{var x=Math.cos(o),M=Math.sin(o),E=t.position.x-c.x,T=t.position.y-c.y;e.setPosition(t,{x:c.x+(E*x-T*M),y:c.y+(E*M+T*x)},p),e.setAngle(t,t.angle+o,p)}},e.scale=function(t,o,c,p){var x=0,M=0;p=p||t.position;for(var E=0;E<t.parts.length;E++){var T=t.parts[E];n.scale(T.vertices,o,c,p),T.axes=g.fromVertices(T.vertices),T.area=n.area(T.vertices),e.setMass(T,t.density*T.area),n.translate(T.vertices,{x:-T.position.x,y:-T.position.y}),e.setInertia(T,e._inertiaScale*n.inertia(T.vertices,T.mass)),n.translate(T.vertices,{x:T.position.x,y:T.position.y}),E>0&&(x+=T.area,M+=T.inertia),T.position.x=p.x+(T.position.x-p.x)*o,T.position.y=p.y+(T.position.y-p.y)*c,f.update(T.bounds,T.vertices,t.velocity)}t.parts.length>1&&(t.area=x,t.isStatic||(e.setMass(t,t.density*x),e.setInertia(t,M))),t.circleRadius&&(o===c?t.circleRadius*=o:t.circleRadius=null)},e.update=function(t,o){o=(typeof o<"u"?o:1e3/60)*t.timeScale;var c=o*o,p=e._timeCorrection?o/(t.deltaTime||o):1,x=1-t.frictionAir*(o/u._baseDelta),M=(t.position.x-t.positionPrev.x)*p,E=(t.position.y-t.positionPrev.y)*p;t.velocity.x=M*x+t.force.x/t.mass*c,t.velocity.y=E*x+t.force.y/t.mass*c,t.positionPrev.x=t.position.x,t.positionPrev.y=t.position.y,t.position.x+=t.velocity.x,t.position.y+=t.velocity.y,t.deltaTime=o,t.angularVelocity=(t.angle-t.anglePrev)*x*p+t.torque/t.inertia*c,t.anglePrev=t.angle,t.angle+=t.angularVelocity;for(var T=0;T<t.parts.length;T++){var v=t.parts[T];n.translate(v.vertices,t.velocity),T>0&&(v.position.x+=t.velocity.x,v.position.y+=t.velocity.y),t.angularVelocity!==0&&(n.rotate(v.vertices,t.angularVelocity,t.position),g.rotate(v.axes,t.angularVelocity),T>0&&r.rotateAbout(v.position,t.angularVelocity,t.position,v.position)),f.update(v.bounds,v.vertices,t.velocity)}},e.updateVelocities=function(t){var o=e._baseDelta/t.deltaTime,c=t.velocity;c.x=(t.position.x-t.positionPrev.x)*o,c.y=(t.position.y-t.positionPrev.y)*o,t.speed=Math.sqrt(c.x*c.x+c.y*c.y),t.angularVelocity=(t.angle-t.anglePrev)*o,t.angularSpeed=Math.abs(t.angularVelocity)},e.applyForce=function(t,o,c){var p={x:o.x-t.position.x,y:o.y-t.position.y};t.force.x+=c.x,t.force.y+=c.y,t.torque+=p.x*c.y-p.y*c.x},e._totalProperties=function(t){for(var o={mass:0,area:0,inertia:0,centre:{x:0,y:0}},c=t.parts.length===1?0:1;c<t.parts.length;c++){var p=t.parts[c],x=p.mass!==1/0?p.mass:1;o.mass+=x,o.area+=p.area,o.inertia+=p.inertia,o.centre=r.add(o.centre,r.mult(p.position,x))}return o.centre=r.div(o.centre,o.mass),o}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(0);(function(){e.on=function(r,a,u){for(var f=a.split(" "),g,l=0;l<f.length;l++)g=f[l],r.events=r.events||{},r.events[g]=r.events[g]||[],r.events[g].push(u);return u},e.off=function(r,a,u){if(!a){r.events={};return}typeof a=="function"&&(u=a,a=n.keys(r.events).join(" "));for(var f=a.split(" "),g=0;g<f.length;g++){var l=r.events[f[g]],t=[];if(u&&l)for(var o=0;o<l.length;o++)l[o]!==u&&t.push(l[o]);r.events[f[g]]=t}},e.trigger=function(r,a,u){var f,g,l,t,o=r.events;if(o&&n.keys(o).length>0){u||(u={}),f=a.split(" ");for(var c=0;c<f.length;c++)if(g=f[c],l=o[g],l){t=n.clone(u,!1),t.name=g,t.source=r;for(var p=0;p<l.length;p++)l[p].apply(r,[t])}}}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(5),r=s(0),a=s(1),u=s(4);(function(){e.create=function(f){return r.extend({id:r.nextId(),type:"composite",parent:null,isModified:!1,bodies:[],constraints:[],composites:[],label:"Composite",plugin:{},cache:{allBodies:null,allConstraints:null,allComposites:null}},f)},e.setModified=function(f,g,l,t){if(f.isModified=g,g&&f.cache&&(f.cache.allBodies=null,f.cache.allConstraints=null,f.cache.allComposites=null),l&&f.parent&&e.setModified(f.parent,g,l,t),t)for(var o=0;o<f.composites.length;o++){var c=f.composites[o];e.setModified(c,g,l,t)}},e.add=function(f,g){var l=[].concat(g);n.trigger(f,"beforeAdd",{object:g});for(var t=0;t<l.length;t++){var o=l[t];switch(o.type){case"body":if(o.parent!==o){r.warn("Composite.add: skipped adding a compound body part (you must add its parent instead)");break}e.addBody(f,o);break;case"constraint":e.addConstraint(f,o);break;case"composite":e.addComposite(f,o);break;case"mouseConstraint":e.addConstraint(f,o.constraint);break}}return n.trigger(f,"afterAdd",{object:g}),f},e.remove=function(f,g,l){var t=[].concat(g);n.trigger(f,"beforeRemove",{object:g});for(var o=0;o<t.length;o++){var c=t[o];switch(c.type){case"body":e.removeBody(f,c,l);break;case"constraint":e.removeConstraint(f,c,l);break;case"composite":e.removeComposite(f,c,l);break;case"mouseConstraint":e.removeConstraint(f,c.constraint);break}}return n.trigger(f,"afterRemove",{object:g}),f},e.addComposite=function(f,g){return f.composites.push(g),g.parent=f,e.setModified(f,!0,!0,!1),f},e.removeComposite=function(f,g,l){var t=r.indexOf(f.composites,g);if(t!==-1&&e.removeCompositeAt(f,t),l)for(var o=0;o<f.composites.length;o++)e.removeComposite(f.composites[o],g,!0);return f},e.removeCompositeAt=function(f,g){return f.composites.splice(g,1),e.setModified(f,!0,!0,!1),f},e.addBody=function(f,g){return f.bodies.push(g),e.setModified(f,!0,!0,!1),f},e.removeBody=function(f,g,l){var t=r.indexOf(f.bodies,g);if(t!==-1&&e.removeBodyAt(f,t),l)for(var o=0;o<f.composites.length;o++)e.removeBody(f.composites[o],g,!0);return f},e.removeBodyAt=function(f,g){return f.bodies.splice(g,1),e.setModified(f,!0,!0,!1),f},e.addConstraint=function(f,g){return f.constraints.push(g),e.setModified(f,!0,!0,!1),f},e.removeConstraint=function(f,g,l){var t=r.indexOf(f.constraints,g);if(t!==-1&&e.removeConstraintAt(f,t),l)for(var o=0;o<f.composites.length;o++)e.removeConstraint(f.composites[o],g,!0);return f},e.removeConstraintAt=function(f,g){return f.constraints.splice(g,1),e.setModified(f,!0,!0,!1),f},e.clear=function(f,g,l){if(l)for(var t=0;t<f.composites.length;t++)e.clear(f.composites[t],g,!0);return g?f.bodies=f.bodies.filter(function(o){return o.isStatic}):f.bodies.length=0,f.constraints.length=0,f.composites.length=0,e.setModified(f,!0,!0,!1),f},e.allBodies=function(f){if(f.cache&&f.cache.allBodies)return f.cache.allBodies;for(var g=[].concat(f.bodies),l=0;l<f.composites.length;l++)g=g.concat(e.allBodies(f.composites[l]));return f.cache&&(f.cache.allBodies=g),g},e.allConstraints=function(f){if(f.cache&&f.cache.allConstraints)return f.cache.allConstraints;for(var g=[].concat(f.constraints),l=0;l<f.composites.length;l++)g=g.concat(e.allConstraints(f.composites[l]));return f.cache&&(f.cache.allConstraints=g),g},e.allComposites=function(f){if(f.cache&&f.cache.allComposites)return f.cache.allComposites;for(var g=[].concat(f.composites),l=0;l<f.composites.length;l++)g=g.concat(e.allComposites(f.composites[l]));return f.cache&&(f.cache.allComposites=g),g},e.get=function(f,g,l){var t,o;switch(l){case"body":t=e.allBodies(f);break;case"constraint":t=e.allConstraints(f);break;case"composite":t=e.allComposites(f).concat(f);break}return t?(o=t.filter(function(c){return c.id.toString()===g.toString()}),o.length===0?null:o[0]):null},e.move=function(f,g,l){return e.remove(f,g),e.add(l,g),f},e.rebase=function(f){for(var g=e.allBodies(f).concat(e.allConstraints(f)).concat(e.allComposites(f)),l=0;l<g.length;l++)g[l].id=r.nextId();return f},e.translate=function(f,g,l){for(var t=l?e.allBodies(f):f.bodies,o=0;o<t.length;o++)u.translate(t[o],g);return f},e.rotate=function(f,g,l,t){for(var o=Math.cos(g),c=Math.sin(g),p=t?e.allBodies(f):f.bodies,x=0;x<p.length;x++){var M=p[x],E=M.position.x-l.x,T=M.position.y-l.y;u.setPosition(M,{x:l.x+(E*o-T*c),y:l.y+(E*c+T*o)}),u.rotate(M,g)}return f},e.scale=function(f,g,l,t,o){for(var c=o?e.allBodies(f):f.bodies,p=0;p<c.length;p++){var x=c[p],M=x.position.x-t.x,E=x.position.y-t.y;u.setPosition(x,{x:t.x+M*g,y:t.y+E*l}),u.scale(x,g,l)}return f},e.bounds=function(f){for(var g=e.allBodies(f),l=[],t=0;t<g.length;t+=1){var o=g[t];l.push(o.bounds.min,o.bounds.max)}return a.create(l)}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(4),r=s(5),a=s(0);(function(){e._motionWakeThreshold=.18,e._motionSleepThreshold=.08,e._minBias=.9,e.update=function(u,f){for(var g=f/a._baseDelta,l=e._motionSleepThreshold,t=0;t<u.length;t++){var o=u[t],c=n.getSpeed(o),p=n.getAngularSpeed(o),x=c*c+p*p;if(o.force.x!==0||o.force.y!==0){e.set(o,!1);continue}var M=Math.min(o.motion,x),E=Math.max(o.motion,x);o.motion=e._minBias*M+(1-e._minBias)*E,o.sleepThreshold>0&&o.motion<l?(o.sleepCounter+=1,o.sleepCounter>=o.sleepThreshold/g&&e.set(o,!0)):o.sleepCounter>0&&(o.sleepCounter-=1)}},e.afterCollisions=function(u){for(var f=e._motionSleepThreshold,g=0;g<u.length;g++){var l=u[g];if(l.isActive){var t=l.collision,o=t.bodyA.parent,c=t.bodyB.parent;if(!(o.isSleeping&&c.isSleeping||o.isStatic||c.isStatic)&&(o.isSleeping||c.isSleeping)){var p=o.isSleeping&&!o.isStatic?o:c,x=p===o?c:o;!p.isStatic&&x.motion>f&&e.set(p,!1)}}}},e.set=function(u,f){var g=u.isSleeping;f?(u.isSleeping=!0,u.sleepCounter=u.sleepThreshold,u.positionImpulse.x=0,u.positionImpulse.y=0,u.positionPrev.x=u.position.x,u.positionPrev.y=u.position.y,u.anglePrev=u.angle,u.speed=0,u.angularSpeed=0,u.motion=0,g||r.trigger(u,"sleepStart")):(u.isSleeping=!1,u.sleepCounter=0,g&&r.trigger(u,"sleepEnd"))}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(3),r=s(9);(function(){var a=[],u={overlap:0,axis:null},f={overlap:0,axis:null};e.create=function(g,l){return{pair:null,collided:!1,bodyA:g,bodyB:l,parentA:g.parent,parentB:l.parent,depth:0,normal:{x:0,y:0},tangent:{x:0,y:0},penetration:{x:0,y:0},supports:[]}},e.collides=function(g,l,t){if(e._overlapAxes(u,g.vertices,l.vertices,g.axes),u.overlap<=0||(e._overlapAxes(f,l.vertices,g.vertices,l.axes),f.overlap<=0))return null;var o=t&&t.table[r.id(g,l)],c;o?c=o.collision:(c=e.create(g,l),c.collided=!0,c.bodyA=g.id<l.id?g:l,c.bodyB=g.id<l.id?l:g,c.parentA=c.bodyA.parent,c.parentB=c.bodyB.parent),g=c.bodyA,l=c.bodyB;var p;u.overlap<f.overlap?p=u:p=f;var x=c.normal,M=c.supports,E=p.axis,T=E.x,v=E.y;T*(l.position.x-g.position.x)+v*(l.position.y-g.position.y)<0?(x.x=T,x.y=v):(x.x=-T,x.y=-v),c.tangent.x=-x.y,c.tangent.y=x.x,c.depth=p.overlap,c.penetration.x=x.x*c.depth,c.penetration.y=x.y*c.depth;var S=e._findSupports(g,l,x,1),P=0;if(n.contains(g.vertices,S[0])&&(M[P++]=S[0]),n.contains(g.vertices,S[1])&&(M[P++]=S[1]),P<2){var C=e._findSupports(l,g,x,-1);n.contains(l.vertices,C[0])&&(M[P++]=C[0]),P<2&&n.contains(l.vertices,C[1])&&(M[P++]=C[1])}return P===0&&(M[P++]=S[0]),M.length=P,c},e._overlapAxes=function(g,l,t,o){var c=l.length,p=t.length,x=l[0].x,M=l[0].y,E=t[0].x,T=t[0].y,v=o.length,S=Number.MAX_VALUE,P=0,C,I,w,b,A,D;for(A=0;A<v;A++){var O=o[A],R=O.x,z=O.y,N=x*R+M*z,H=E*R+T*z,q=N,J=H;for(D=1;D<c;D+=1)b=l[D].x*R+l[D].y*z,b>q?q=b:b<N&&(N=b);for(D=1;D<p;D+=1)b=t[D].x*R+t[D].y*z,b>J?J=b:b<H&&(H=b);if(I=q-H,w=J-N,C=I<w?I:w,C<S&&(S=C,P=A,C<=0))break}g.axis=o[P],g.overlap=S},e._projectToAxis=function(g,l,t){for(var o=l[0].x*t.x+l[0].y*t.y,c=o,p=1;p<l.length;p+=1){var x=l[p].x*t.x+l[p].y*t.y;x>c?c=x:x<o&&(o=x)}g.min=o,g.max=c},e._findSupports=function(g,l,t,o){var c=l.vertices,p=c.length,x=g.position.x,M=g.position.y,E=t.x*o,T=t.y*o,v=Number.MAX_VALUE,S,P,C,I,w;for(w=0;w<p;w+=1)P=c[w],I=E*(x-P.x)+T*(M-P.y),I<v&&(v=I,S=P);return C=c[(p+S.index-1)%p],v=E*(x-C.x)+T*(M-C.y),P=c[(S.index+1)%p],E*(x-P.x)+T*(M-P.y)<v?(a[0]=S,a[1]=P,a):(a[0]=S,a[1]=C,a)}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(16);(function(){e.create=function(r,a){var u=r.bodyA,f=r.bodyB,g={id:e.id(u,f),bodyA:u,bodyB:f,collision:r,contacts:[],activeContacts:[],separation:0,isActive:!0,confirmedActive:!0,isSensor:u.isSensor||f.isSensor,timeCreated:a,timeUpdated:a,inverseMass:0,friction:0,frictionStatic:0,restitution:0,slop:0};return e.update(g,r,a),g},e.update=function(r,a,u){var f=r.contacts,g=a.supports,l=r.activeContacts,t=a.parentA,o=a.parentB,c=t.vertices.length;r.isActive=!0,r.timeUpdated=u,r.collision=a,r.separation=a.depth,r.inverseMass=t.inverseMass+o.inverseMass,r.friction=t.friction<o.friction?t.friction:o.friction,r.frictionStatic=t.frictionStatic>o.frictionStatic?t.frictionStatic:o.frictionStatic,r.restitution=t.restitution>o.restitution?t.restitution:o.restitution,r.slop=t.slop>o.slop?t.slop:o.slop,a.pair=r,l.length=0;for(var p=0;p<g.length;p++){var x=g[p],M=x.body===t?x.index:c+x.index,E=f[M];E?l.push(E):l.push(f[M]=n.create(x))}},e.setActive=function(r,a,u){a?(r.isActive=!0,r.timeUpdated=u):(r.isActive=!1,r.activeContacts.length=0)},e.id=function(r,a){return r.id<a.id?"A"+r.id+"B"+a.id:"A"+a.id+"B"+r.id}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(3),r=s(2),a=s(7),u=s(1),f=s(11),g=s(0);(function(){e._warming=.4,e._torqueDampen=1,e._minLength=1e-6,e.create=function(l){var t=l;t.bodyA&&!t.pointA&&(t.pointA={x:0,y:0}),t.bodyB&&!t.pointB&&(t.pointB={x:0,y:0});var o=t.bodyA?r.add(t.bodyA.position,t.pointA):t.pointA,c=t.bodyB?r.add(t.bodyB.position,t.pointB):t.pointB,p=r.magnitude(r.sub(o,c));t.length=typeof t.length<"u"?t.length:p,t.id=t.id||g.nextId(),t.label=t.label||"Constraint",t.type="constraint",t.stiffness=t.stiffness||(t.length>0?1:.7),t.damping=t.damping||0,t.angularStiffness=t.angularStiffness||0,t.angleA=t.bodyA?t.bodyA.angle:t.angleA,t.angleB=t.bodyB?t.bodyB.angle:t.angleB,t.plugin={};var x={visible:!0,lineWidth:2,strokeStyle:"#ffffff",type:"line",anchors:!0};return t.length===0&&t.stiffness>.1?(x.type="pin",x.anchors=!1):t.stiffness<.9&&(x.type="spring"),t.render=g.extend(x,t.render),t},e.preSolveAll=function(l){for(var t=0;t<l.length;t+=1){var o=l[t],c=o.constraintImpulse;o.isStatic||c.x===0&&c.y===0&&c.angle===0||(o.position.x+=c.x,o.position.y+=c.y,o.angle+=c.angle)}},e.solveAll=function(l,t){for(var o=g.clamp(t/g._baseDelta,0,1),c=0;c<l.length;c+=1){var p=l[c],x=!p.bodyA||p.bodyA&&p.bodyA.isStatic,M=!p.bodyB||p.bodyB&&p.bodyB.isStatic;(x||M)&&e.solve(l[c],o)}for(c=0;c<l.length;c+=1)p=l[c],x=!p.bodyA||p.bodyA&&p.bodyA.isStatic,M=!p.bodyB||p.bodyB&&p.bodyB.isStatic,!x&&!M&&e.solve(l[c],o)},e.solve=function(l,t){var o=l.bodyA,c=l.bodyB,p=l.pointA,x=l.pointB;if(!(!o&&!c)){o&&!o.isStatic&&(r.rotate(p,o.angle-l.angleA,p),l.angleA=o.angle),c&&!c.isStatic&&(r.rotate(x,c.angle-l.angleB,x),l.angleB=c.angle);var M=p,E=x;if(o&&(M=r.add(o.position,p)),c&&(E=r.add(c.position,x)),!(!M||!E)){var T=r.sub(M,E),v=r.magnitude(T);v<e._minLength&&(v=e._minLength);var S=(v-l.length)/v,P=l.stiffness>=1||l.length===0,C=P?l.stiffness*t:l.stiffness*t*t,I=l.damping*t,w=r.mult(T,S*C),b=(o?o.inverseMass:0)+(c?c.inverseMass:0),A=(o?o.inverseInertia:0)+(c?c.inverseInertia:0),D=b+A,O,R,z,N,H;if(I>0){var q=r.create();z=r.div(T,v),H=r.sub(c&&r.sub(c.position,c.positionPrev)||q,o&&r.sub(o.position,o.positionPrev)||q),N=r.dot(z,H)}o&&!o.isStatic&&(R=o.inverseMass/b,o.constraintImpulse.x-=w.x*R,o.constraintImpulse.y-=w.y*R,o.position.x-=w.x*R,o.position.y-=w.y*R,I>0&&(o.positionPrev.x-=I*z.x*N*R,o.positionPrev.y-=I*z.y*N*R),O=r.cross(p,w)/D*e._torqueDampen*o.inverseInertia*(1-l.angularStiffness),o.constraintImpulse.angle-=O,o.angle-=O),c&&!c.isStatic&&(R=c.inverseMass/b,c.constraintImpulse.x+=w.x*R,c.constraintImpulse.y+=w.y*R,c.position.x+=w.x*R,c.position.y+=w.y*R,I>0&&(c.positionPrev.x+=I*z.x*N*R,c.positionPrev.y+=I*z.y*N*R),O=r.cross(x,w)/D*e._torqueDampen*c.inverseInertia*(1-l.angularStiffness),c.constraintImpulse.angle+=O,c.angle+=O)}}},e.postSolveAll=function(l){for(var t=0;t<l.length;t++){var o=l[t],c=o.constraintImpulse;if(!(o.isStatic||c.x===0&&c.y===0&&c.angle===0)){a.set(o,!1);for(var p=0;p<o.parts.length;p++){var x=o.parts[p];n.translate(x.vertices,c),p>0&&(x.position.x+=c.x,x.position.y+=c.y),c.angle!==0&&(n.rotate(x.vertices,c.angle,o.position),f.rotate(x.axes,c.angle),p>0&&r.rotateAbout(x.position,c.angle,o.position,x.position)),u.update(x.bounds,x.vertices,o.velocity)}c.angle*=e._warming,c.x*=e._warming,c.y*=e._warming}}},e.pointAWorld=function(l){return{x:(l.bodyA?l.bodyA.position.x:0)+(l.pointA?l.pointA.x:0),y:(l.bodyA?l.bodyA.position.y:0)+(l.pointA?l.pointA.y:0)}},e.pointBWorld=function(l){return{x:(l.bodyB?l.bodyB.position.x:0)+(l.pointB?l.pointB.x:0),y:(l.bodyB?l.bodyB.position.y:0)+(l.pointB?l.pointB.y:0)}}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(2),r=s(0);(function(){e.fromVertices=function(a){for(var u={},f=0;f<a.length;f++){var g=(f+1)%a.length,l=n.normalise({x:a[g].y-a[f].y,y:a[f].x-a[g].x}),t=l.y===0?1/0:l.x/l.y;t=t.toFixed(3).toString(),u[t]=l}return r.values(u)},e.rotate=function(a,u){if(u!==0)for(var f=Math.cos(u),g=Math.sin(u),l=0;l<a.length;l++){var t=a[l],o;o=t.x*f-t.y*g,t.y=t.x*g+t.y*f,t.x=o}}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(3),r=s(0),a=s(4),u=s(1),f=s(2);(function(){e.rectangle=function(g,l,t,o,c){c=c||{};var p={label:"Rectangle Body",position:{x:g,y:l},vertices:n.fromPath("L 0 0 L "+t+" 0 L "+t+" "+o+" L 0 "+o)};if(c.chamfer){var x=c.chamfer;p.vertices=n.chamfer(p.vertices,x.radius,x.quality,x.qualityMin,x.qualityMax),delete c.chamfer}return a.create(r.extend({},p,c))},e.trapezoid=function(g,l,t,o,c,p){p=p||{},c*=.5;var x=(1-c*2)*t,M=t*c,E=M+x,T=E+M,v;c<.5?v="L 0 0 L "+M+" "+-o+" L "+E+" "+-o+" L "+T+" 0":v="L 0 0 L "+E+" "+-o+" L "+T+" 0";var S={label:"Trapezoid Body",position:{x:g,y:l},vertices:n.fromPath(v)};if(p.chamfer){var P=p.chamfer;S.vertices=n.chamfer(S.vertices,P.radius,P.quality,P.qualityMin,P.qualityMax),delete p.chamfer}return a.create(r.extend({},S,p))},e.circle=function(g,l,t,o,c){o=o||{};var p={label:"Circle Body",circleRadius:t};c=c||25;var x=Math.ceil(Math.max(10,Math.min(c,t)));return x%2===1&&(x+=1),e.polygon(g,l,x,t,r.extend({},p,o))},e.polygon=function(g,l,t,o,c){if(c=c||{},t<3)return e.circle(g,l,o,c);for(var p=2*Math.PI/t,x="",M=p*.5,E=0;E<t;E+=1){var T=M+E*p,v=Math.cos(T)*o,S=Math.sin(T)*o;x+="L "+v.toFixed(3)+" "+S.toFixed(3)+" "}var P={label:"Polygon Body",position:{x:g,y:l},vertices:n.fromPath(x)};if(c.chamfer){var C=c.chamfer;P.vertices=n.chamfer(P.vertices,C.radius,C.quality,C.qualityMin,C.qualityMax),delete c.chamfer}return a.create(r.extend({},P,c))},e.fromVertices=function(g,l,t,o,c,p,x,M){var E=r.getDecomp(),T,v,S,P,C,I,w,b,A,D,O;for(T=!!(E&&E.quickDecomp),o=o||{},S=[],c=typeof c<"u"?c:!1,p=typeof p<"u"?p:.01,x=typeof x<"u"?x:10,M=typeof M<"u"?M:.01,r.isArray(t[0])||(t=[t]),D=0;D<t.length;D+=1)if(I=t[D],P=n.isConvex(I),C=!P,C&&!T&&r.warnOnce("Bodies.fromVertices: Install the 'poly-decomp' library and use Common.setDecomp or provide 'decomp' as a global to decompose concave vertices."),P||!T)P?I=n.clockwiseSort(I):I=n.hull(I),S.push({position:{x:g,y:l},vertices:I});else{var R=I.map(function(Z){return[Z.x,Z.y]});E.makeCCW(R),p!==!1&&E.removeCollinearPoints(R,p),M!==!1&&E.removeDuplicatePoints&&E.removeDuplicatePoints(R,M);var z=E.quickDecomp(R);for(w=0;w<z.length;w++){var N=z[w],H=N.map(function(Z){return{x:Z[0],y:Z[1]}});x>0&&n.area(H)<x||S.push({position:n.centre(H),vertices:H})}}for(w=0;w<S.length;w++)S[w]=a.create(r.extend(S[w],o));if(c){var q=5;for(w=0;w<S.length;w++){var J=S[w];for(b=w+1;b<S.length;b++){var _=S[b];if(u.overlaps(J.bounds,_.bounds)){var $=J.vertices,K=_.vertices;for(A=0;A<J.vertices.length;A++)for(O=0;O<_.vertices.length;O++){var Y=f.magnitudeSquared(f.sub($[(A+1)%$.length],K[O])),ne=f.magnitudeSquared(f.sub($[A],K[(O+1)%K.length]));Y<q&&ne<q&&($[A].isInternal=!0,K[O].isInternal=!0)}}}}}return S.length>1?(v=a.create(r.extend({parts:S.slice(0)},o)),a.setPosition(v,{x:g,y:l}),v):S[0]}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(0),r=s(8);(function(){e.create=function(a){var u={bodies:[],pairs:null};return n.extend(u,a)},e.setBodies=function(a,u){a.bodies=u.slice(0)},e.clear=function(a){a.bodies=[]},e.collisions=function(a){var u=[],f=a.pairs,g=a.bodies,l=g.length,t=e.canCollide,o=r.collides,c,p;for(g.sort(e._compareBoundsX),c=0;c<l;c++){var x=g[c],M=x.bounds,E=x.bounds.max.x,T=x.bounds.max.y,v=x.bounds.min.y,S=x.isStatic||x.isSleeping,P=x.parts.length,C=P===1;for(p=c+1;p<l;p++){var I=g[p],w=I.bounds;if(w.min.x>E)break;if(!(T<w.min.y||v>w.max.y)&&!(S&&(I.isStatic||I.isSleeping))&&t(x.collisionFilter,I.collisionFilter)){var b=I.parts.length;if(C&&b===1){var A=o(x,I,f);A&&u.push(A)}else for(var D=P>1?1:0,O=b>1?1:0,R=D;R<P;R++)for(var z=x.parts[R],M=z.bounds,N=O;N<b;N++){var H=I.parts[N],w=H.bounds;if(!(M.min.x>w.max.x||M.max.x<w.min.x||M.max.y<w.min.y||M.min.y>w.max.y)){var A=o(z,H,f);A&&u.push(A)}}}}}return u},e.canCollide=function(a,u){return a.group===u.group&&a.group!==0?a.group>0:(a.mask&u.category)!==0&&(u.mask&a.category)!==0},e._compareBoundsX=function(a,u){return a.bounds.min.x-u.bounds.min.x}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(0);(function(){e.create=function(r){var a={};return r||n.log("Mouse.create: element was undefined, defaulting to document.body","warn"),a.element=r||document.body,a.absolute={x:0,y:0},a.position={x:0,y:0},a.mousedownPosition={x:0,y:0},a.mouseupPosition={x:0,y:0},a.offset={x:0,y:0},a.scale={x:1,y:1},a.wheelDelta=0,a.button=-1,a.pixelRatio=parseInt(a.element.getAttribute("data-pixel-ratio"),10)||1,a.sourceEvents={mousemove:null,mousedown:null,mouseup:null,mousewheel:null},a.mousemove=function(u){var f=e._getRelativeMousePosition(u,a.element,a.pixelRatio),g=u.changedTouches;g&&(a.button=0,u.preventDefault()),a.absolute.x=f.x,a.absolute.y=f.y,a.position.x=a.absolute.x*a.scale.x+a.offset.x,a.position.y=a.absolute.y*a.scale.y+a.offset.y,a.sourceEvents.mousemove=u},a.mousedown=function(u){var f=e._getRelativeMousePosition(u,a.element,a.pixelRatio),g=u.changedTouches;g?(a.button=0,u.preventDefault()):a.button=u.button,a.absolute.x=f.x,a.absolute.y=f.y,a.position.x=a.absolute.x*a.scale.x+a.offset.x,a.position.y=a.absolute.y*a.scale.y+a.offset.y,a.mousedownPosition.x=a.position.x,a.mousedownPosition.y=a.position.y,a.sourceEvents.mousedown=u},a.mouseup=function(u){var f=e._getRelativeMousePosition(u,a.element,a.pixelRatio),g=u.changedTouches;g&&u.preventDefault(),a.button=-1,a.absolute.x=f.x,a.absolute.y=f.y,a.position.x=a.absolute.x*a.scale.x+a.offset.x,a.position.y=a.absolute.y*a.scale.y+a.offset.y,a.mouseupPosition.x=a.position.x,a.mouseupPosition.y=a.position.y,a.sourceEvents.mouseup=u},a.mousewheel=function(u){a.wheelDelta=Math.max(-1,Math.min(1,u.wheelDelta||-u.detail)),u.preventDefault()},e.setElement(a,a.element),a},e.setElement=function(r,a){r.element=a,a.addEventListener("mousemove",r.mousemove),a.addEventListener("mousedown",r.mousedown),a.addEventListener("mouseup",r.mouseup),a.addEventListener("mousewheel",r.mousewheel),a.addEventListener("DOMMouseScroll",r.mousewheel),a.addEventListener("touchmove",r.mousemove),a.addEventListener("touchstart",r.mousedown),a.addEventListener("touchend",r.mouseup)},e.clearSourceEvents=function(r){r.sourceEvents.mousemove=null,r.sourceEvents.mousedown=null,r.sourceEvents.mouseup=null,r.sourceEvents.mousewheel=null,r.wheelDelta=0},e.setOffset=function(r,a){r.offset.x=a.x,r.offset.y=a.y,r.position.x=r.absolute.x*r.scale.x+r.offset.x,r.position.y=r.absolute.y*r.scale.y+r.offset.y},e.setScale=function(r,a){r.scale.x=a.x,r.scale.y=a.y,r.position.x=r.absolute.x*r.scale.x+r.offset.x,r.position.y=r.absolute.y*r.scale.y+r.offset.y},e._getRelativeMousePosition=function(r,a,u){var f=a.getBoundingClientRect(),g=document.documentElement||document.body.parentNode||document.body,l=window.pageXOffset!==void 0?window.pageXOffset:g.scrollLeft,t=window.pageYOffset!==void 0?window.pageYOffset:g.scrollTop,o=r.changedTouches,c,p;return o?(c=o[0].pageX-f.left-l,p=o[0].pageY-f.top-t):(c=r.pageX-f.left-l,p=r.pageY-f.top-t),{x:c/(a.clientWidth/(a.width||a.clientWidth)*u),y:p/(a.clientHeight/(a.height||a.clientHeight)*u)}}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(0);(function(){e._registry={},e.register=function(r){if(e.isPlugin(r)||n.warn("Plugin.register:",e.toString(r),"does not implement all required fields."),r.name in e._registry){var a=e._registry[r.name],u=e.versionParse(r.version).number,f=e.versionParse(a.version).number;u>f?(n.warn("Plugin.register:",e.toString(a),"was upgraded to",e.toString(r)),e._registry[r.name]=r):u<f?n.warn("Plugin.register:",e.toString(a),"can not be downgraded to",e.toString(r)):r!==a&&n.warn("Plugin.register:",e.toString(r),"is already registered to different plugin object")}else e._registry[r.name]=r;return r},e.resolve=function(r){return e._registry[e.dependencyParse(r).name]},e.toString=function(r){return typeof r=="string"?r:(r.name||"anonymous")+"@"+(r.version||r.range||"0.0.0")},e.isPlugin=function(r){return r&&r.name&&r.version&&r.install},e.isUsed=function(r,a){return r.used.indexOf(a)>-1},e.isFor=function(r,a){var u=r.for&&e.dependencyParse(r.for);return!r.for||a.name===u.name&&e.versionSatisfies(a.version,u.range)},e.use=function(r,a){if(r.uses=(r.uses||[]).concat(a||[]),r.uses.length===0){n.warn("Plugin.use:",e.toString(r),"does not specify any dependencies to install.");return}for(var u=e.dependencies(r),f=n.topologicalSort(u),g=[],l=0;l<f.length;l+=1)if(f[l]!==r.name){var t=e.resolve(f[l]);if(!t){g.push("âŒ "+f[l]);continue}e.isUsed(r,t.name)||(e.isFor(t,r)||(n.warn("Plugin.use:",e.toString(t),"is for",t.for,"but installed on",e.toString(r)+"."),t._warned=!0),t.install?t.install(r):(n.warn("Plugin.use:",e.toString(t),"does not specify an install function."),t._warned=!0),t._warned?(g.push("ðŸ”¶ "+e.toString(t)),delete t._warned):g.push("âœ… "+e.toString(t)),r.used.push(t.name))}g.length>0&&n.info(g.join("  "))},e.dependencies=function(r,a){var u=e.dependencyParse(r),f=u.name;if(a=a||{},!(f in a)){r=e.resolve(r)||r,a[f]=n.map(r.uses||[],function(l){e.isPlugin(l)&&e.register(l);var t=e.dependencyParse(l),o=e.resolve(l);return o&&!e.versionSatisfies(o.version,t.range)?(n.warn("Plugin.dependencies:",e.toString(o),"does not satisfy",e.toString(t),"used by",e.toString(u)+"."),o._warned=!0,r._warned=!0):o||(n.warn("Plugin.dependencies:",e.toString(l),"used by",e.toString(u),"could not be resolved."),r._warned=!0),t.name});for(var g=0;g<a[f].length;g+=1)e.dependencies(a[f][g],a);return a}},e.dependencyParse=function(r){if(n.isString(r)){var a=/^[\w-]+(@(\*|[\^~]?\d+\.\d+\.\d+(-[0-9A-Za-z-+]+)?))?$/;return a.test(r)||n.warn("Plugin.dependencyParse:",r,"is not a valid dependency string."),{name:r.split("@")[0],range:r.split("@")[1]||"*"}}return{name:r.name,range:r.range||r.version}},e.versionParse=function(r){var a=/^(\*)|(\^|~|>=|>)?\s*((\d+)\.(\d+)\.(\d+))(-[0-9A-Za-z-+]+)?$/;a.test(r)||n.warn("Plugin.versionParse:",r,"is not a valid version or range.");var u=a.exec(r),f=Number(u[4]),g=Number(u[5]),l=Number(u[6]);return{isRange:!!(u[1]||u[2]),version:u[3],range:r,operator:u[1]||u[2]||"",major:f,minor:g,patch:l,parts:[f,g,l],prerelease:u[7],number:f*1e8+g*1e4+l}},e.versionSatisfies=function(r,a){a=a||"*";var u=e.versionParse(a),f=e.versionParse(r);if(u.isRange){if(u.operator==="*"||r==="*")return!0;if(u.operator===">")return f.number>u.number;if(u.operator===">=")return f.number>=u.number;if(u.operator==="~")return f.major===u.major&&f.minor===u.minor&&f.patch>=u.patch;if(u.operator==="^")return u.major>0?f.major===u.major&&f.number>=u.number:u.minor>0?f.minor===u.minor&&f.patch>=u.patch:f.patch===u.patch}return r===a||r==="*"}})()}),(function(d,m){var s={};d.exports=s,(function(){s.create=function(e){return{vertex:e,normalImpulse:0,tangentImpulse:0}}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(7),r=s(18),a=s(13),u=s(19),f=s(5),g=s(6),l=s(10),t=s(0),o=s(4);(function(){e.create=function(c){c=c||{};var p={positionIterations:6,velocityIterations:4,constraintIterations:2,enableSleeping:!1,events:[],plugin:{},gravity:{x:0,y:1,scale:.001},timing:{timestamp:0,timeScale:1,lastDelta:0,lastElapsed:0}},x=t.extend(p,c);return x.world=c.world||g.create({label:"World"}),x.pairs=c.pairs||u.create(),x.detector=c.detector||a.create(),x.grid={buckets:[]},x.world.gravity=x.gravity,x.broadphase=x.grid,x.metrics={},x},e.update=function(c,p){var x=t.now(),M=c.world,E=c.detector,T=c.pairs,v=c.timing,S=v.timestamp,P;p=typeof p<"u"?p:t._baseDelta,p*=v.timeScale,v.timestamp+=p,v.lastDelta=p;var C={timestamp:v.timestamp,delta:p};f.trigger(c,"beforeUpdate",C);var I=g.allBodies(M),w=g.allConstraints(M);for(M.isModified&&(a.setBodies(E,I),g.setModified(M,!1,!1,!0)),c.enableSleeping&&n.update(I,p),e._bodiesApplyGravity(I,c.gravity),p>0&&e._bodiesUpdate(I,p),l.preSolveAll(I),P=0;P<c.constraintIterations;P++)l.solveAll(w,p);l.postSolveAll(I),E.pairs=c.pairs;var b=a.collisions(E);u.update(T,b,S),c.enableSleeping&&n.afterCollisions(T.list),T.collisionStart.length>0&&f.trigger(c,"collisionStart",{pairs:T.collisionStart});var A=t.clamp(20/c.positionIterations,0,1);for(r.preSolvePosition(T.list),P=0;P<c.positionIterations;P++)r.solvePosition(T.list,p,A);for(r.postSolvePosition(I),l.preSolveAll(I),P=0;P<c.constraintIterations;P++)l.solveAll(w,p);for(l.postSolveAll(I),r.preSolveVelocity(T.list),P=0;P<c.velocityIterations;P++)r.solveVelocity(T.list,p);return e._bodiesUpdateVelocities(I),T.collisionActive.length>0&&f.trigger(c,"collisionActive",{pairs:T.collisionActive}),T.collisionEnd.length>0&&f.trigger(c,"collisionEnd",{pairs:T.collisionEnd}),e._bodiesClearForces(I),f.trigger(c,"afterUpdate",C),c.timing.lastElapsed=t.now()-x,c},e.merge=function(c,p){if(t.extend(c,p),p.world){c.world=p.world,e.clear(c);for(var x=g.allBodies(c.world),M=0;M<x.length;M++){var E=x[M];n.set(E,!1),E.id=t.nextId()}}},e.clear=function(c){u.clear(c.pairs),a.clear(c.detector)},e._bodiesClearForces=function(c){for(var p=c.length,x=0;x<p;x++){var M=c[x];M.force.x=0,M.force.y=0,M.torque=0}},e._bodiesApplyGravity=function(c,p){var x=typeof p.scale<"u"?p.scale:.001,M=c.length;if(!(p.x===0&&p.y===0||x===0))for(var E=0;E<M;E++){var T=c[E];T.isStatic||T.isSleeping||(T.force.y+=T.mass*p.y*x,T.force.x+=T.mass*p.x*x)}},e._bodiesUpdate=function(c,p){for(var x=c.length,M=0;M<x;M++){var E=c[M];E.isStatic||E.isSleeping||o.update(E,p)}},e._bodiesUpdateVelocities=function(c){for(var p=c.length,x=0;x<p;x++)o.updateVelocities(c[x])}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(3),r=s(0),a=s(1);(function(){e._restingThresh=2,e._restingThreshTangent=Math.sqrt(6),e._positionDampen=.9,e._positionWarming=.8,e._frictionNormalMultiplier=5,e._frictionMaxStatic=Number.MAX_VALUE,e.preSolvePosition=function(u){var f,g,l,t=u.length;for(f=0;f<t;f++)g=u[f],g.isActive&&(l=g.activeContacts.length,g.collision.parentA.totalContacts+=l,g.collision.parentB.totalContacts+=l)},e.solvePosition=function(u,f,g){var l,t,o,c,p,x,M,E,T=e._positionDampen*(g||1),v=r.clamp(f/r._baseDelta,0,1),S=u.length;for(l=0;l<S;l++)t=u[l],!(!t.isActive||t.isSensor)&&(o=t.collision,c=o.parentA,p=o.parentB,x=o.normal,t.separation=x.x*(p.positionImpulse.x+o.penetration.x-c.positionImpulse.x)+x.y*(p.positionImpulse.y+o.penetration.y-c.positionImpulse.y));for(l=0;l<S;l++)t=u[l],!(!t.isActive||t.isSensor)&&(o=t.collision,c=o.parentA,p=o.parentB,x=o.normal,E=t.separation-t.slop*v,(c.isStatic||p.isStatic)&&(E*=2),c.isStatic||c.isSleeping||(M=T/c.totalContacts,c.positionImpulse.x+=x.x*E*M,c.positionImpulse.y+=x.y*E*M),p.isStatic||p.isSleeping||(M=T/p.totalContacts,p.positionImpulse.x-=x.x*E*M,p.positionImpulse.y-=x.y*E*M))},e.postSolvePosition=function(u){for(var f=e._positionWarming,g=u.length,l=n.translate,t=a.update,o=0;o<g;o++){var c=u[o],p=c.positionImpulse,x=p.x,M=p.y,E=c.velocity;if(c.totalContacts=0,x!==0||M!==0){for(var T=0;T<c.parts.length;T++){var v=c.parts[T];l(v.vertices,p),t(v.bounds,v.vertices,E),v.position.x+=x,v.position.y+=M}c.positionPrev.x+=x,c.positionPrev.y+=M,x*E.x+M*E.y<0?(p.x=0,p.y=0):(p.x*=f,p.y*=f)}}},e.preSolveVelocity=function(u){var f=u.length,g,l;for(g=0;g<f;g++){var t=u[g];if(!(!t.isActive||t.isSensor)){var o=t.activeContacts,c=o.length,p=t.collision,x=p.parentA,M=p.parentB,E=p.normal,T=p.tangent;for(l=0;l<c;l++){var v=o[l],S=v.vertex,P=v.normalImpulse,C=v.tangentImpulse;if(P!==0||C!==0){var I=E.x*P+T.x*C,w=E.y*P+T.y*C;x.isStatic||x.isSleeping||(x.positionPrev.x+=I*x.inverseMass,x.positionPrev.y+=w*x.inverseMass,x.anglePrev+=x.inverseInertia*((S.x-x.position.x)*w-(S.y-x.position.y)*I)),M.isStatic||M.isSleeping||(M.positionPrev.x-=I*M.inverseMass,M.positionPrev.y-=w*M.inverseMass,M.anglePrev-=M.inverseInertia*((S.x-M.position.x)*w-(S.y-M.position.y)*I))}}}}},e.solveVelocity=function(u,f){var g=f/r._baseDelta,l=g*g,t=l*g,o=-e._restingThresh*g,c=e._restingThreshTangent,p=e._frictionNormalMultiplier*g,x=e._frictionMaxStatic,M=u.length,E,T,v,S;for(v=0;v<M;v++){var P=u[v];if(!(!P.isActive||P.isSensor)){var C=P.collision,I=C.parentA,w=C.parentB,b=I.velocity,A=w.velocity,D=C.normal.x,O=C.normal.y,R=C.tangent.x,z=C.tangent.y,N=P.activeContacts,H=N.length,q=1/H,J=I.inverseMass+w.inverseMass,_=P.friction*P.frictionStatic*p;for(b.x=I.position.x-I.positionPrev.x,b.y=I.position.y-I.positionPrev.y,A.x=w.position.x-w.positionPrev.x,A.y=w.position.y-w.positionPrev.y,I.angularVelocity=I.angle-I.anglePrev,w.angularVelocity=w.angle-w.anglePrev,S=0;S<H;S++){var $=N[S],K=$.vertex,Y=K.x-I.position.x,ne=K.y-I.position.y,Z=K.x-w.position.x,ie=K.y-w.position.y,ee=b.x-ne*I.angularVelocity,He=b.y+Y*I.angularVelocity,$e=A.x-ie*w.angularVelocity,Ve=A.y+Z*w.angularVelocity,Ie=ee-$e,Ee=He-Ve,Pe=D*Ie+O*Ee,ae=R*Ie+z*Ee,Te=P.separation+Pe,we=Math.min(Te,1);we=Te<0?0:we;var Be=we*_;ae<-Be||ae>Be?(T=ae>0?ae:-ae,E=P.friction*(ae>0?1:-1)*t,E<-T?E=-T:E>T&&(E=T)):(E=ae,T=x);var Ae=Y*O-ne*D,be=Z*O-ie*D,Le=q/(J+I.inverseInertia*Ae*Ae+w.inverseInertia*be*be),pe=(1+P.restitution)*Pe*Le;if(E*=Le,Pe<o)$.normalImpulse=0;else{var Ue=$.normalImpulse;$.normalImpulse+=pe,$.normalImpulse>0&&($.normalImpulse=0),pe=$.normalImpulse-Ue}if(ae<-c||ae>c)$.tangentImpulse=0;else{var Ge=$.tangentImpulse;$.tangentImpulse+=E,$.tangentImpulse<-T&&($.tangentImpulse=-T),$.tangentImpulse>T&&($.tangentImpulse=T),E=$.tangentImpulse-Ge}var me=D*pe+R*E,ve=O*pe+z*E;I.isStatic||I.isSleeping||(I.positionPrev.x+=me*I.inverseMass,I.positionPrev.y+=ve*I.inverseMass,I.anglePrev+=(Y*ve-ne*me)*I.inverseInertia),w.isStatic||w.isSleeping||(w.positionPrev.x-=me*w.inverseMass,w.positionPrev.y-=ve*w.inverseMass,w.anglePrev-=(Z*ve-ie*me)*w.inverseInertia)}}}}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(9),r=s(0);(function(){e.create=function(a){return r.extend({table:{},list:[],collisionStart:[],collisionActive:[],collisionEnd:[]},a)},e.update=function(a,u,f){var g=a.list,l=g.length,t=a.table,o=u.length,c=a.collisionStart,p=a.collisionEnd,x=a.collisionActive,M,E,T,v;for(c.length=0,p.length=0,x.length=0,v=0;v<l;v++)g[v].confirmedActive=!1;for(v=0;v<o;v++)M=u[v],T=M.pair,T?(T.isActive?x.push(T):c.push(T),n.update(T,M,f),T.confirmedActive=!0):(T=n.create(M,f),t[T.id]=T,c.push(T),g.push(T));var S=[];for(l=g.length,v=0;v<l;v++)T=g[v],T.confirmedActive||(n.setActive(T,!1,f),p.push(T),!T.collision.bodyA.isSleeping&&!T.collision.bodyB.isSleeping&&S.push(v));for(v=0;v<S.length;v++)E=S[v]-v,T=g[E],g.splice(E,1),delete t[T.id]},e.clear=function(a){return a.table={},a.list.length=0,a.collisionStart.length=0,a.collisionActive.length=0,a.collisionEnd.length=0,a}})()}),(function(d,m,s){var e=d.exports=s(21);e.Axes=s(11),e.Bodies=s(12),e.Body=s(4),e.Bounds=s(1),e.Collision=s(8),e.Common=s(0),e.Composite=s(6),e.Composites=s(22),e.Constraint=s(10),e.Contact=s(16),e.Detector=s(13),e.Engine=s(17),e.Events=s(5),e.Grid=s(23),e.Mouse=s(14),e.MouseConstraint=s(24),e.Pair=s(9),e.Pairs=s(19),e.Plugin=s(15),e.Query=s(25),e.Render=s(26),e.Resolver=s(18),e.Runner=s(27),e.SAT=s(28),e.Sleeping=s(7),e.Svg=s(29),e.Vector=s(2),e.Vertices=s(3),e.World=s(30),e.Engine.run=e.Runner.run,e.Common.deprecated(e.Engine,"run","Engine.run âž¤ use Matter.Runner.run(engine) instead")}),(function(d,m,s){var e={};d.exports=e;var n=s(15),r=s(0);(function(){e.name="matter-js",e.version="0.19.0",e.uses=[],e.used=[],e.use=function(){n.use(e,Array.prototype.slice.call(arguments))},e.before=function(a,u){return a=a.replace(/^Matter./,""),r.chainPathBefore(e,a,u)},e.after=function(a,u){return a=a.replace(/^Matter./,""),r.chainPathAfter(e,a,u)}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(6),r=s(10),a=s(0),u=s(4),f=s(12),g=a.deprecated;(function(){e.stack=function(l,t,o,c,p,x,M){for(var E=n.create({label:"Stack"}),T=l,v=t,S,P=0,C=0;C<c;C++){for(var I=0,w=0;w<o;w++){var b=M(T,v,w,C,S,P);if(b){var A=b.bounds.max.y-b.bounds.min.y,D=b.bounds.max.x-b.bounds.min.x;A>I&&(I=A),u.translate(b,{x:D*.5,y:A*.5}),T=b.bounds.max.x+p,n.addBody(E,b),S=b,P+=1}else T+=p}v+=I+x,T=l}return E},e.chain=function(l,t,o,c,p,x){for(var M=l.bodies,E=1;E<M.length;E++){var T=M[E-1],v=M[E],S=T.bounds.max.y-T.bounds.min.y,P=T.bounds.max.x-T.bounds.min.x,C=v.bounds.max.y-v.bounds.min.y,I=v.bounds.max.x-v.bounds.min.x,w={bodyA:T,pointA:{x:P*t,y:S*o},bodyB:v,pointB:{x:I*c,y:C*p}},b=a.extend(w,x);n.addConstraint(l,r.create(b))}return l.label+=" Chain",l},e.mesh=function(l,t,o,c,p){var x=l.bodies,M,E,T,v,S;for(M=0;M<o;M++){for(E=1;E<t;E++)T=x[E-1+M*t],v=x[E+M*t],n.addConstraint(l,r.create(a.extend({bodyA:T,bodyB:v},p)));if(M>0)for(E=0;E<t;E++)T=x[E+(M-1)*t],v=x[E+M*t],n.addConstraint(l,r.create(a.extend({bodyA:T,bodyB:v},p))),c&&E>0&&(S=x[E-1+(M-1)*t],n.addConstraint(l,r.create(a.extend({bodyA:S,bodyB:v},p)))),c&&E<t-1&&(S=x[E+1+(M-1)*t],n.addConstraint(l,r.create(a.extend({bodyA:S,bodyB:v},p))))}return l.label+=" Mesh",l},e.pyramid=function(l,t,o,c,p,x,M){return e.stack(l,t,o,c,p,x,function(E,T,v,S,P,C){var I=Math.min(c,Math.ceil(o/2)),w=P?P.bounds.max.x-P.bounds.min.x:0;if(!(S>I)){S=I-S;var b=S,A=o-1-S;if(!(v<b||v>A)){C===1&&u.translate(P,{x:(v+(o%2===1?1:-1))*w,y:0});var D=P?v*w:0;return M(l+D+v*p,T,v,S,P,C)}}})},e.newtonsCradle=function(l,t,o,c,p){for(var x=n.create({label:"Newtons Cradle"}),M=0;M<o;M++){var E=1.9,T=f.circle(l+M*(c*E),t+p,c,{inertia:1/0,restitution:1,friction:0,frictionAir:1e-4,slop:1}),v=r.create({pointA:{x:l+M*(c*E),y:t},bodyB:T});n.addBody(x,T),n.addConstraint(x,v)}return x},g(e,"newtonsCradle","Composites.newtonsCradle âž¤ moved to newtonsCradle example"),e.car=function(l,t,o,c,p){var x=u.nextGroup(!0),M=20,E=-o*.5+M,T=o*.5-M,v=0,S=n.create({label:"Car"}),P=f.rectangle(l,t,o,c,{collisionFilter:{group:x},chamfer:{radius:c*.5},density:2e-4}),C=f.circle(l+E,t+v,p,{collisionFilter:{group:x},friction:.8}),I=f.circle(l+T,t+v,p,{collisionFilter:{group:x},friction:.8}),w=r.create({bodyB:P,pointB:{x:E,y:v},bodyA:C,stiffness:1,length:0}),b=r.create({bodyB:P,pointB:{x:T,y:v},bodyA:I,stiffness:1,length:0});return n.addBody(S,P),n.addBody(S,C),n.addBody(S,I),n.addConstraint(S,w),n.addConstraint(S,b),S},g(e,"car","Composites.car âž¤ moved to car example"),e.softBody=function(l,t,o,c,p,x,M,E,T,v){T=a.extend({inertia:1/0},T),v=a.extend({stiffness:.2,render:{type:"line",anchors:!1}},v);var S=e.stack(l,t,o,c,p,x,function(P,C){return f.circle(P,C,E,T)});return e.mesh(S,o,c,M,v),S.label="Soft Body",S},g(e,"softBody","Composites.softBody âž¤ moved to softBody and cloth examples")})()}),(function(d,m,s){var e={};d.exports=e;var n=s(9),r=s(0),a=r.deprecated;(function(){e.create=function(u){var f={buckets:{},pairs:{},pairsList:[],bucketWidth:48,bucketHeight:48};return r.extend(f,u)},e.update=function(u,f,g,l){var t,o,c,p=g.world,x=u.buckets,M,E,T=!1;for(t=0;t<f.length;t++){var v=f[t];if(!(v.isSleeping&&!l)&&!(p.bounds&&(v.bounds.max.x<p.bounds.min.x||v.bounds.min.x>p.bounds.max.x||v.bounds.max.y<p.bounds.min.y||v.bounds.min.y>p.bounds.max.y))){var S=e._getRegion(u,v);if(!v.region||S.id!==v.region.id||l){(!v.region||l)&&(v.region=S);var P=e._regionUnion(S,v.region);for(o=P.startCol;o<=P.endCol;o++)for(c=P.startRow;c<=P.endRow;c++){E=e._getBucketId(o,c),M=x[E];var C=o>=S.startCol&&o<=S.endCol&&c>=S.startRow&&c<=S.endRow,I=o>=v.region.startCol&&o<=v.region.endCol&&c>=v.region.startRow&&c<=v.region.endRow;!C&&I&&I&&M&&e._bucketRemoveBody(u,M,v),(v.region===S||C&&!I||l)&&(M||(M=e._createBucket(x,E)),e._bucketAddBody(u,M,v))}v.region=S,T=!0}}}T&&(u.pairsList=e._createActivePairsList(u))},a(e,"update","Grid.update âž¤ replaced by Matter.Detector"),e.clear=function(u){u.buckets={},u.pairs={},u.pairsList=[]},a(e,"clear","Grid.clear âž¤ replaced by Matter.Detector"),e._regionUnion=function(u,f){var g=Math.min(u.startCol,f.startCol),l=Math.max(u.endCol,f.endCol),t=Math.min(u.startRow,f.startRow),o=Math.max(u.endRow,f.endRow);return e._createRegion(g,l,t,o)},e._getRegion=function(u,f){var g=f.bounds,l=Math.floor(g.min.x/u.bucketWidth),t=Math.floor(g.max.x/u.bucketWidth),o=Math.floor(g.min.y/u.bucketHeight),c=Math.floor(g.max.y/u.bucketHeight);return e._createRegion(l,t,o,c)},e._createRegion=function(u,f,g,l){return{id:u+","+f+","+g+","+l,startCol:u,endCol:f,startRow:g,endRow:l}},e._getBucketId=function(u,f){return"C"+u+"R"+f},e._createBucket=function(u,f){var g=u[f]=[];return g},e._bucketAddBody=function(u,f,g){var l=u.pairs,t=n.id,o=f.length,c;for(c=0;c<o;c++){var p=f[c];if(!(g.id===p.id||g.isStatic&&p.isStatic)){var x=t(g,p),M=l[x];M?M[2]+=1:l[x]=[g,p,1]}}f.push(g)},e._bucketRemoveBody=function(u,f,g){var l=u.pairs,t=n.id,o;f.splice(r.indexOf(f,g),1);var c=f.length;for(o=0;o<c;o++){var p=l[t(g,f[o])];p&&(p[2]-=1)}},e._createActivePairsList=function(u){var f,g=u.pairs,l=r.keys(g),t=l.length,o=[],c;for(c=0;c<t;c++)f=g[l[c]],f[2]>0?o.push(f):delete g[l[c]];return o}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(3),r=s(7),a=s(14),u=s(5),f=s(13),g=s(10),l=s(6),t=s(0),o=s(1);(function(){e.create=function(c,p){var x=(c?c.mouse:null)||(p?p.mouse:null);x||(c&&c.render&&c.render.canvas?x=a.create(c.render.canvas):p&&p.element?x=a.create(p.element):(x=a.create(),t.warn("MouseConstraint.create: options.mouse was undefined, options.element was undefined, may not function as expected")));var M=g.create({label:"Mouse Constraint",pointA:x.position,pointB:{x:0,y:0},length:.01,stiffness:.1,angularStiffness:1,render:{strokeStyle:"#90EE90",lineWidth:3}}),E={type:"mouseConstraint",mouse:x,element:null,body:null,constraint:M,collisionFilter:{category:1,mask:4294967295,group:0}},T=t.extend(E,p);return u.on(c,"beforeUpdate",function(){var v=l.allBodies(c.world);e.update(T,v),e._triggerEvents(T)}),T},e.update=function(c,p){var x=c.mouse,M=c.constraint,E=c.body;if(x.button===0){if(M.bodyB)r.set(M.bodyB,!1),M.pointA=x.position;else for(var T=0;T<p.length;T++)if(E=p[T],o.contains(E.bounds,x.position)&&f.canCollide(E.collisionFilter,c.collisionFilter))for(var v=E.parts.length>1?1:0;v<E.parts.length;v++){var S=E.parts[v];if(n.contains(S.vertices,x.position)){M.pointA=x.position,M.bodyB=c.body=E,M.pointB={x:x.position.x-E.position.x,y:x.position.y-E.position.y},M.angleB=E.angle,r.set(E,!1),u.trigger(c,"startdrag",{mouse:x,body:E});break}}}else M.bodyB=c.body=null,M.pointB=null,E&&u.trigger(c,"enddrag",{mouse:x,body:E})},e._triggerEvents=function(c){var p=c.mouse,x=p.sourceEvents;x.mousemove&&u.trigger(c,"mousemove",{mouse:p}),x.mousedown&&u.trigger(c,"mousedown",{mouse:p}),x.mouseup&&u.trigger(c,"mouseup",{mouse:p}),a.clearSourceEvents(p)}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(2),r=s(8),a=s(1),u=s(12),f=s(3);(function(){e.collides=function(g,l){for(var t=[],o=l.length,c=g.bounds,p=r.collides,x=a.overlaps,M=0;M<o;M++){var E=l[M],T=E.parts.length,v=T===1?0:1;if(x(E.bounds,c))for(var S=v;S<T;S++){var P=E.parts[S];if(x(P.bounds,c)){var C=p(P,g);if(C){t.push(C);break}}}}return t},e.ray=function(g,l,t,o){o=o||1e-100;for(var c=n.angle(l,t),p=n.magnitude(n.sub(l,t)),x=(t.x+l.x)*.5,M=(t.y+l.y)*.5,E=u.rectangle(x,M,p,o,{angle:c}),T=e.collides(E,g),v=0;v<T.length;v+=1){var S=T[v];S.body=S.bodyB=S.bodyA}return T},e.region=function(g,l,t){for(var o=[],c=0;c<g.length;c++){var p=g[c],x=a.overlaps(p.bounds,l);(x&&!t||!x&&t)&&o.push(p)}return o},e.point=function(g,l){for(var t=[],o=0;o<g.length;o++){var c=g[o];if(a.contains(c.bounds,l))for(var p=c.parts.length===1?0:1;p<c.parts.length;p++){var x=c.parts[p];if(a.contains(x.bounds,l)&&f.contains(x.vertices,l)){t.push(c);break}}}return t}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(4),r=s(0),a=s(6),u=s(1),f=s(5),g=s(2),l=s(14);(function(){var t,o;typeof window<"u"&&(t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(v){window.setTimeout(function(){v(r.now())},1e3/60)},o=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame),e._goodFps=30,e._goodDelta=1e3/60,e.create=function(v){var S={engine:null,element:null,canvas:null,mouse:null,frameRequestId:null,timing:{historySize:60,delta:0,deltaHistory:[],lastTime:0,lastTimestamp:0,lastElapsed:0,timestampElapsed:0,timestampElapsedHistory:[],engineDeltaHistory:[],engineElapsedHistory:[],elapsedHistory:[]},options:{width:800,height:600,pixelRatio:1,background:"#14151f",wireframeBackground:"#14151f",hasBounds:!!v.bounds,enabled:!0,wireframes:!0,showSleeping:!0,showDebug:!1,showStats:!1,showPerformance:!1,showBounds:!1,showVelocity:!1,showCollisions:!1,showSeparations:!1,showAxes:!1,showPositions:!1,showAngleIndicator:!1,showIds:!1,showVertexNumbers:!1,showConvexHulls:!1,showInternalEdges:!1,showMousePosition:!1}},P=r.extend(S,v);return P.canvas&&(P.canvas.width=P.options.width||P.canvas.width,P.canvas.height=P.options.height||P.canvas.height),P.mouse=v.mouse,P.engine=v.engine,P.canvas=P.canvas||x(P.options.width,P.options.height),P.context=P.canvas.getContext("2d"),P.textures={},P.bounds=P.bounds||{min:{x:0,y:0},max:{x:P.canvas.width,y:P.canvas.height}},P.controller=e,P.options.showBroadphase=!1,P.options.pixelRatio!==1&&e.setPixelRatio(P,P.options.pixelRatio),r.isElement(P.element)&&P.element.appendChild(P.canvas),P},e.run=function(v){(function S(P){v.frameRequestId=t(S),c(v,P),e.world(v,P),(v.options.showStats||v.options.showDebug)&&e.stats(v,v.context,P),(v.options.showPerformance||v.options.showDebug)&&e.performance(v,v.context,P)})()},e.stop=function(v){o(v.frameRequestId)},e.setPixelRatio=function(v,S){var P=v.options,C=v.canvas;S==="auto"&&(S=M(C)),P.pixelRatio=S,C.setAttribute("data-pixel-ratio",S),C.width=P.width*S,C.height=P.height*S,C.style.width=P.width+"px",C.style.height=P.height+"px"},e.lookAt=function(v,S,P,C){C=typeof C<"u"?C:!0,S=r.isArray(S)?S:[S],P=P||{x:0,y:0};for(var I={min:{x:1/0,y:1/0},max:{x:-1/0,y:-1/0}},w=0;w<S.length;w+=1){var b=S[w],A=b.bounds?b.bounds.min:b.min||b.position||b,D=b.bounds?b.bounds.max:b.max||b.position||b;A&&D&&(A.x<I.min.x&&(I.min.x=A.x),D.x>I.max.x&&(I.max.x=D.x),A.y<I.min.y&&(I.min.y=A.y),D.y>I.max.y&&(I.max.y=D.y))}var O=I.max.x-I.min.x+2*P.x,R=I.max.y-I.min.y+2*P.y,z=v.canvas.height,N=v.canvas.width,H=N/z,q=O/R,J=1,_=1;q>H?_=q/H:J=H/q,v.options.hasBounds=!0,v.bounds.min.x=I.min.x,v.bounds.max.x=I.min.x+O*J,v.bounds.min.y=I.min.y,v.bounds.max.y=I.min.y+R*_,C&&(v.bounds.min.x+=O*.5-O*J*.5,v.bounds.max.x+=O*.5-O*J*.5,v.bounds.min.y+=R*.5-R*_*.5,v.bounds.max.y+=R*.5-R*_*.5),v.bounds.min.x-=P.x,v.bounds.max.x-=P.x,v.bounds.min.y-=P.y,v.bounds.max.y-=P.y,v.mouse&&(l.setScale(v.mouse,{x:(v.bounds.max.x-v.bounds.min.x)/v.canvas.width,y:(v.bounds.max.y-v.bounds.min.y)/v.canvas.height}),l.setOffset(v.mouse,v.bounds.min))},e.startViewTransform=function(v){var S=v.bounds.max.x-v.bounds.min.x,P=v.bounds.max.y-v.bounds.min.y,C=S/v.options.width,I=P/v.options.height;v.context.setTransform(v.options.pixelRatio/C,0,0,v.options.pixelRatio/I,0,0),v.context.translate(-v.bounds.min.x,-v.bounds.min.y)},e.endViewTransform=function(v){v.context.setTransform(v.options.pixelRatio,0,0,v.options.pixelRatio,0,0)},e.world=function(v,S){var P=r.now(),C=v.engine,I=C.world,w=v.canvas,b=v.context,A=v.options,D=v.timing,O=a.allBodies(I),R=a.allConstraints(I),z=A.wireframes?A.wireframeBackground:A.background,N=[],H=[],q,J={timestamp:C.timing.timestamp};if(f.trigger(v,"beforeRender",J),v.currentBackground!==z&&T(v,z),b.globalCompositeOperation="source-in",b.fillStyle="transparent",b.fillRect(0,0,w.width,w.height),b.globalCompositeOperation="source-over",A.hasBounds){for(q=0;q<O.length;q++){var _=O[q];u.overlaps(_.bounds,v.bounds)&&N.push(_)}for(q=0;q<R.length;q++){var $=R[q],K=$.bodyA,Y=$.bodyB,ne=$.pointA,Z=$.pointB;K&&(ne=g.add(K.position,$.pointA)),Y&&(Z=g.add(Y.position,$.pointB)),!(!ne||!Z)&&(u.contains(v.bounds,ne)||u.contains(v.bounds,Z))&&H.push($)}e.startViewTransform(v),v.mouse&&(l.setScale(v.mouse,{x:(v.bounds.max.x-v.bounds.min.x)/v.options.width,y:(v.bounds.max.y-v.bounds.min.y)/v.options.height}),l.setOffset(v.mouse,v.bounds.min))}else H=R,N=O,v.options.pixelRatio!==1&&v.context.setTransform(v.options.pixelRatio,0,0,v.options.pixelRatio,0,0);!A.wireframes||C.enableSleeping&&A.showSleeping?e.bodies(v,N,b):(A.showConvexHulls&&e.bodyConvexHulls(v,N,b),e.bodyWireframes(v,N,b)),A.showBounds&&e.bodyBounds(v,N,b),(A.showAxes||A.showAngleIndicator)&&e.bodyAxes(v,N,b),A.showPositions&&e.bodyPositions(v,N,b),A.showVelocity&&e.bodyVelocity(v,N,b),A.showIds&&e.bodyIds(v,N,b),A.showSeparations&&e.separations(v,C.pairs.list,b),A.showCollisions&&e.collisions(v,C.pairs.list,b),A.showVertexNumbers&&e.vertexNumbers(v,N,b),A.showMousePosition&&e.mousePosition(v,v.mouse,b),e.constraints(H,b),A.hasBounds&&e.endViewTransform(v),f.trigger(v,"afterRender",J),D.lastElapsed=r.now()-P},e.stats=function(v,S,P){for(var C=v.engine,I=C.world,w=a.allBodies(I),b=0,A=55,D=44,O=0,R=0,z=0;z<w.length;z+=1)b+=w[z].parts.length;var N={Part:b,Body:w.length,Cons:a.allConstraints(I).length,Comp:a.allComposites(I).length,Pair:C.pairs.list.length};S.fillStyle="#0e0f19",S.fillRect(O,R,A*5.5,D),S.font="12px Arial",S.textBaseline="top",S.textAlign="right";for(var H in N){var q=N[H];S.fillStyle="#aaa",S.fillText(H,O+A,R+8),S.fillStyle="#eee",S.fillText(q,O+A,R+26),O+=A}},e.performance=function(v,S){var P=v.engine,C=v.timing,I=C.deltaHistory,w=C.elapsedHistory,b=C.timestampElapsedHistory,A=C.engineDeltaHistory,D=C.engineElapsedHistory,O=P.timing.lastDelta,R=p(I),z=p(w),N=p(A),H=p(D),q=p(b),J=q/R||0,_=1e3/R||0,$=4,K=12,Y=60,ne=34,Z=10,ie=69;S.fillStyle="#0e0f19",S.fillRect(0,50,K*4+Y*5+22,ne),e.status(S,Z,ie,Y,$,I.length,Math.round(_)+" fps",_/e._goodFps,function(ee){return I[ee]/R-1}),e.status(S,Z+K+Y,ie,Y,$,A.length,O.toFixed(2)+" dt",e._goodDelta/O,function(ee){return A[ee]/N-1}),e.status(S,Z+(K+Y)*2,ie,Y,$,D.length,H.toFixed(2)+" ut",1-H/e._goodFps,function(ee){return D[ee]/H-1}),e.status(S,Z+(K+Y)*3,ie,Y,$,w.length,z.toFixed(2)+" rt",1-z/e._goodFps,function(ee){return w[ee]/z-1}),e.status(S,Z+(K+Y)*4,ie,Y,$,b.length,J.toFixed(2)+" x",J*J*J,function(ee){return(b[ee]/I[ee]/J||0)-1})},e.status=function(v,S,P,C,I,w,b,A,D){v.strokeStyle="#888",v.fillStyle="#444",v.lineWidth=1,v.fillRect(S,P+7,C,1),v.beginPath(),v.moveTo(S,P+7-I*r.clamp(.4*D(0),-2,2));for(var O=0;O<C;O+=1)v.lineTo(S+O,P+7-(O<w?I*r.clamp(.4*D(O),-2,2):0));v.stroke(),v.fillStyle="hsl("+r.clamp(25+95*A,0,120)+",100%,60%)",v.fillRect(S,P-7,4,4),v.font="12px Arial",v.textBaseline="middle",v.textAlign="right",v.fillStyle="#eee",v.fillText(b,S+C,P-5)},e.constraints=function(v,S){for(var P=S,C=0;C<v.length;C++){var I=v[C];if(!(!I.render.visible||!I.pointA||!I.pointB)){var w=I.bodyA,b=I.bodyB,A,D;if(w?A=g.add(w.position,I.pointA):A=I.pointA,I.render.type==="pin")P.beginPath(),P.arc(A.x,A.y,3,0,2*Math.PI),P.closePath();else{if(b?D=g.add(b.position,I.pointB):D=I.pointB,P.beginPath(),P.moveTo(A.x,A.y),I.render.type==="spring")for(var O=g.sub(D,A),R=g.perp(g.normalise(O)),z=Math.ceil(r.clamp(I.length/5,12,20)),N,H=1;H<z;H+=1)N=H%2===0?1:-1,P.lineTo(A.x+O.x*(H/z)+R.x*N*4,A.y+O.y*(H/z)+R.y*N*4);P.lineTo(D.x,D.y)}I.render.lineWidth&&(P.lineWidth=I.render.lineWidth,P.strokeStyle=I.render.strokeStyle,P.stroke()),I.render.anchors&&(P.fillStyle=I.render.strokeStyle,P.beginPath(),P.arc(A.x,A.y,3,0,2*Math.PI),P.arc(D.x,D.y,3,0,2*Math.PI),P.closePath(),P.fill())}}},e.bodies=function(v,S,P){var C=P;v.engine;var I=v.options,w=I.showInternalEdges||!I.wireframes,b,A,D,O;for(D=0;D<S.length;D++)if(b=S[D],!!b.render.visible){for(O=b.parts.length>1?1:0;O<b.parts.length;O++)if(A=b.parts[O],!!A.render.visible){if(I.showSleeping&&b.isSleeping?C.globalAlpha=.5*A.render.opacity:A.render.opacity!==1&&(C.globalAlpha=A.render.opacity),A.render.sprite&&A.render.sprite.texture&&!I.wireframes){var R=A.render.sprite,z=E(v,R.texture);C.translate(A.position.x,A.position.y),C.rotate(A.angle),C.drawImage(z,z.width*-R.xOffset*R.xScale,z.height*-R.yOffset*R.yScale,z.width*R.xScale,z.height*R.yScale),C.rotate(-A.angle),C.translate(-A.position.x,-A.position.y)}else{if(A.circleRadius)C.beginPath(),C.arc(A.position.x,A.position.y,A.circleRadius,0,2*Math.PI);else{C.beginPath(),C.moveTo(A.vertices[0].x,A.vertices[0].y);for(var N=1;N<A.vertices.length;N++)!A.vertices[N-1].isInternal||w?C.lineTo(A.vertices[N].x,A.vertices[N].y):C.moveTo(A.vertices[N].x,A.vertices[N].y),A.vertices[N].isInternal&&!w&&C.moveTo(A.vertices[(N+1)%A.vertices.length].x,A.vertices[(N+1)%A.vertices.length].y);C.lineTo(A.vertices[0].x,A.vertices[0].y),C.closePath()}I.wireframes?(C.lineWidth=1,C.strokeStyle="#bbb",C.stroke()):(C.fillStyle=A.render.fillStyle,A.render.lineWidth&&(C.lineWidth=A.render.lineWidth,C.strokeStyle=A.render.strokeStyle,C.stroke()),C.fill())}C.globalAlpha=1}}},e.bodyWireframes=function(v,S,P){var C=P,I=v.options.showInternalEdges,w,b,A,D,O;for(C.beginPath(),A=0;A<S.length;A++)if(w=S[A],!!w.render.visible)for(O=w.parts.length>1?1:0;O<w.parts.length;O++){for(b=w.parts[O],C.moveTo(b.vertices[0].x,b.vertices[0].y),D=1;D<b.vertices.length;D++)!b.vertices[D-1].isInternal||I?C.lineTo(b.vertices[D].x,b.vertices[D].y):C.moveTo(b.vertices[D].x,b.vertices[D].y),b.vertices[D].isInternal&&!I&&C.moveTo(b.vertices[(D+1)%b.vertices.length].x,b.vertices[(D+1)%b.vertices.length].y);C.lineTo(b.vertices[0].x,b.vertices[0].y)}C.lineWidth=1,C.strokeStyle="#bbb",C.stroke()},e.bodyConvexHulls=function(v,S,P){var C=P,I,w,b;for(C.beginPath(),w=0;w<S.length;w++)if(I=S[w],!(!I.render.visible||I.parts.length===1)){for(C.moveTo(I.vertices[0].x,I.vertices[0].y),b=1;b<I.vertices.length;b++)C.lineTo(I.vertices[b].x,I.vertices[b].y);C.lineTo(I.vertices[0].x,I.vertices[0].y)}C.lineWidth=1,C.strokeStyle="rgba(255,255,255,0.2)",C.stroke()},e.vertexNumbers=function(v,S,P){var C=P,I,w,b;for(I=0;I<S.length;I++){var A=S[I].parts;for(b=A.length>1?1:0;b<A.length;b++){var D=A[b];for(w=0;w<D.vertices.length;w++)C.fillStyle="rgba(255,255,255,0.2)",C.fillText(I+"_"+w,D.position.x+(D.vertices[w].x-D.position.x)*.8,D.position.y+(D.vertices[w].y-D.position.y)*.8)}}},e.mousePosition=function(v,S,P){var C=P;C.fillStyle="rgba(255,255,255,0.8)",C.fillText(S.position.x+"  "+S.position.y,S.position.x+5,S.position.y-5)},e.bodyBounds=function(v,S,P){var C=P;v.engine;var I=v.options;C.beginPath();for(var w=0;w<S.length;w++){var b=S[w];if(b.render.visible)for(var A=S[w].parts,D=A.length>1?1:0;D<A.length;D++){var O=A[D];C.rect(O.bounds.min.x,O.bounds.min.y,O.bounds.max.x-O.bounds.min.x,O.bounds.max.y-O.bounds.min.y)}}I.wireframes?C.strokeStyle="rgba(255,255,255,0.08)":C.strokeStyle="rgba(0,0,0,0.1)",C.lineWidth=1,C.stroke()},e.bodyAxes=function(v,S,P){var C=P;v.engine;var I=v.options,w,b,A,D;for(C.beginPath(),b=0;b<S.length;b++){var O=S[b],R=O.parts;if(O.render.visible)if(I.showAxes)for(A=R.length>1?1:0;A<R.length;A++)for(w=R[A],D=0;D<w.axes.length;D++){var z=w.axes[D];C.moveTo(w.position.x,w.position.y),C.lineTo(w.position.x+z.x*20,w.position.y+z.y*20)}else for(A=R.length>1?1:0;A<R.length;A++)for(w=R[A],D=0;D<w.axes.length;D++)C.moveTo(w.position.x,w.position.y),C.lineTo((w.vertices[0].x+w.vertices[w.vertices.length-1].x)/2,(w.vertices[0].y+w.vertices[w.vertices.length-1].y)/2)}I.wireframes?(C.strokeStyle="indianred",C.lineWidth=1):(C.strokeStyle="rgba(255, 255, 255, 0.4)",C.globalCompositeOperation="overlay",C.lineWidth=2),C.stroke(),C.globalCompositeOperation="source-over"},e.bodyPositions=function(v,S,P){var C=P;v.engine;var I=v.options,w,b,A,D;for(C.beginPath(),A=0;A<S.length;A++)if(w=S[A],!!w.render.visible)for(D=0;D<w.parts.length;D++)b=w.parts[D],C.arc(b.position.x,b.position.y,3,0,2*Math.PI,!1),C.closePath();for(I.wireframes?C.fillStyle="indianred":C.fillStyle="rgba(0,0,0,0.5)",C.fill(),C.beginPath(),A=0;A<S.length;A++)w=S[A],w.render.visible&&(C.arc(w.positionPrev.x,w.positionPrev.y,2,0,2*Math.PI,!1),C.closePath());C.fillStyle="rgba(255,165,0,0.8)",C.fill()},e.bodyVelocity=function(v,S,P){var C=P;C.beginPath();for(var I=0;I<S.length;I++){var w=S[I];if(w.render.visible){var b=n.getVelocity(w);C.moveTo(w.position.x,w.position.y),C.lineTo(w.position.x+b.x,w.position.y+b.y)}}C.lineWidth=3,C.strokeStyle="cornflowerblue",C.stroke()},e.bodyIds=function(v,S,P){var C=P,I,w;for(I=0;I<S.length;I++)if(S[I].render.visible){var b=S[I].parts;for(w=b.length>1?1:0;w<b.length;w++){var A=b[w];C.font="12px Arial",C.fillStyle="rgba(255,255,255,0.5)",C.fillText(A.id,A.position.x+10,A.position.y-10)}}},e.collisions=function(v,S,P){var C=P,I=v.options,w,b,A,D;for(C.beginPath(),A=0;A<S.length;A++)if(w=S[A],!!w.isActive)for(b=w.collision,D=0;D<w.activeContacts.length;D++){var O=w.activeContacts[D],R=O.vertex;C.rect(R.x-1.5,R.y-1.5,3.5,3.5)}for(I.wireframes?C.fillStyle="rgba(255,255,255,0.7)":C.fillStyle="orange",C.fill(),C.beginPath(),A=0;A<S.length;A++)if(w=S[A],!!w.isActive&&(b=w.collision,w.activeContacts.length>0)){var z=w.activeContacts[0].vertex.x,N=w.activeContacts[0].vertex.y;w.activeContacts.length===2&&(z=(w.activeContacts[0].vertex.x+w.activeContacts[1].vertex.x)/2,N=(w.activeContacts[0].vertex.y+w.activeContacts[1].vertex.y)/2),b.bodyB===b.supports[0].body||b.bodyA.isStatic===!0?C.moveTo(z-b.normal.x*8,N-b.normal.y*8):C.moveTo(z+b.normal.x*8,N+b.normal.y*8),C.lineTo(z,N)}I.wireframes?C.strokeStyle="rgba(255,165,0,0.7)":C.strokeStyle="orange",C.lineWidth=1,C.stroke()},e.separations=function(v,S,P){var C=P,I=v.options,w,b,A,D,O;for(C.beginPath(),O=0;O<S.length;O++)if(w=S[O],!!w.isActive){b=w.collision,A=b.bodyA,D=b.bodyB;var R=1;!D.isStatic&&!A.isStatic&&(R=.5),D.isStatic&&(R=0),C.moveTo(D.position.x,D.position.y),C.lineTo(D.position.x-b.penetration.x*R,D.position.y-b.penetration.y*R),R=1,!D.isStatic&&!A.isStatic&&(R=.5),A.isStatic&&(R=0),C.moveTo(A.position.x,A.position.y),C.lineTo(A.position.x+b.penetration.x*R,A.position.y+b.penetration.y*R)}I.wireframes?C.strokeStyle="rgba(255,165,0,0.5)":C.strokeStyle="orange",C.stroke()},e.inspector=function(v,S){v.engine;var P=v.selected,C=v.render,I=C.options,w;if(I.hasBounds){var b=C.bounds.max.x-C.bounds.min.x,A=C.bounds.max.y-C.bounds.min.y,D=b/C.options.width,O=A/C.options.height;S.scale(1/D,1/O),S.translate(-C.bounds.min.x,-C.bounds.min.y)}for(var R=0;R<P.length;R++){var z=P[R].data;switch(S.translate(.5,.5),S.lineWidth=1,S.strokeStyle="rgba(255,165,0,0.9)",S.setLineDash([1,2]),z.type){case"body":w=z.bounds,S.beginPath(),S.rect(Math.floor(w.min.x-3),Math.floor(w.min.y-3),Math.floor(w.max.x-w.min.x+6),Math.floor(w.max.y-w.min.y+6)),S.closePath(),S.stroke();break;case"constraint":var N=z.pointA;z.bodyA&&(N=z.pointB),S.beginPath(),S.arc(N.x,N.y,10,0,2*Math.PI),S.closePath(),S.stroke();break}S.setLineDash([]),S.translate(-.5,-.5)}v.selectStart!==null&&(S.translate(.5,.5),S.lineWidth=1,S.strokeStyle="rgba(255,165,0,0.6)",S.fillStyle="rgba(255,165,0,0.1)",w=v.selectBounds,S.beginPath(),S.rect(Math.floor(w.min.x),Math.floor(w.min.y),Math.floor(w.max.x-w.min.x),Math.floor(w.max.y-w.min.y)),S.closePath(),S.stroke(),S.fill(),S.translate(-.5,-.5)),I.hasBounds&&S.setTransform(1,0,0,1,0,0)};var c=function(v,S){var P=v.engine,C=v.timing,I=C.historySize,w=P.timing.timestamp;C.delta=S-C.lastTime||e._goodDelta,C.lastTime=S,C.timestampElapsed=w-C.lastTimestamp||0,C.lastTimestamp=w,C.deltaHistory.unshift(C.delta),C.deltaHistory.length=Math.min(C.deltaHistory.length,I),C.engineDeltaHistory.unshift(P.timing.lastDelta),C.engineDeltaHistory.length=Math.min(C.engineDeltaHistory.length,I),C.timestampElapsedHistory.unshift(C.timestampElapsed),C.timestampElapsedHistory.length=Math.min(C.timestampElapsedHistory.length,I),C.engineElapsedHistory.unshift(P.timing.lastElapsed),C.engineElapsedHistory.length=Math.min(C.engineElapsedHistory.length,I),C.elapsedHistory.unshift(C.lastElapsed),C.elapsedHistory.length=Math.min(C.elapsedHistory.length,I)},p=function(v){for(var S=0,P=0;P<v.length;P+=1)S+=v[P];return S/v.length||0},x=function(v,S){var P=document.createElement("canvas");return P.width=v,P.height=S,P.oncontextmenu=function(){return!1},P.onselectstart=function(){return!1},P},M=function(v){var S=v.getContext("2d"),P=window.devicePixelRatio||1,C=S.webkitBackingStorePixelRatio||S.mozBackingStorePixelRatio||S.msBackingStorePixelRatio||S.oBackingStorePixelRatio||S.backingStorePixelRatio||1;return P/C},E=function(v,S){var P=v.textures[S];return P||(P=v.textures[S]=new Image,P.src=S,P)},T=function(v,S){var P=S;/(jpg|gif|png)$/.test(S)&&(P="url("+S+")"),v.canvas.style.background=P,v.canvas.style.backgroundSize="contain",v.currentBackground=S}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(5),r=s(17),a=s(0);(function(){var u,f;if(typeof window<"u"&&(u=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame,f=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame),!u){var g;u=function(l){g=setTimeout(function(){l(a.now())},1e3/60)},f=function(){clearTimeout(g)}}e.create=function(l){var t={fps:60,deltaSampleSize:60,counterTimestamp:0,frameCounter:0,deltaHistory:[],timePrev:null,frameRequestId:null,isFixed:!1,enabled:!0},o=a.extend(t,l);return o.delta=o.delta||1e3/o.fps,o.deltaMin=o.deltaMin||1e3/o.fps,o.deltaMax=o.deltaMax||1e3/(o.fps*.5),o.fps=1e3/o.delta,o},e.run=function(l,t){return typeof l.positionIterations<"u"&&(t=l,l=e.create()),(function o(c){l.frameRequestId=u(o),c&&l.enabled&&e.tick(l,t,c)})(),l},e.tick=function(l,t,o){var c=t.timing,p;l.isFixed?p=l.delta:(p=o-l.timePrev||l.delta,l.timePrev=o,l.deltaHistory.push(p),l.deltaHistory=l.deltaHistory.slice(-l.deltaSampleSize),p=Math.min.apply(null,l.deltaHistory),p=p<l.deltaMin?l.deltaMin:p,p=p>l.deltaMax?l.deltaMax:p,l.delta=p);var x={timestamp:c.timestamp};n.trigger(l,"beforeTick",x),l.frameCounter+=1,o-l.counterTimestamp>=1e3&&(l.fps=l.frameCounter*((o-l.counterTimestamp)/1e3),l.counterTimestamp=o,l.frameCounter=0),n.trigger(l,"tick",x),n.trigger(l,"beforeUpdate",x),r.update(t,p),n.trigger(l,"afterUpdate",x),n.trigger(l,"afterTick",x)},e.stop=function(l){f(l.frameRequestId)},e.start=function(l,t){e.run(l,t)}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(8),r=s(0),a=r.deprecated;(function(){e.collides=function(u,f){return n.collides(u,f)},a(e,"collides","SAT.collides âž¤ replaced by Collision.collides")})()}),(function(d,m,s){var e={};d.exports=e,s(1);var n=s(0);(function(){e.pathToVertices=function(r,a){typeof window<"u"&&!("SVGPathSeg"in window)&&n.warn("Svg.pathToVertices: SVGPathSeg not defined, a polyfill is required.");var u,f,g,l,t,o,c,p,x,M,E=[],T,v,S=0,P=0,C=0;a=a||15;var I=function(b,A,D){var O=D%2===1&&D>1;if(!x||b!=x.x||A!=x.y){x&&O?(T=x.x,v=x.y):(T=0,v=0);var R={x:T+b,y:v+A};(O||!x)&&(x=R),E.push(R),P=T+b,C=v+A}},w=function(b){var A=b.pathSegTypeAsLetter.toUpperCase();if(A!=="Z"){switch(A){case"M":case"L":case"T":case"C":case"S":case"Q":P=b.x,C=b.y;break;case"H":P=b.x;break;case"V":C=b.y;break}I(P,C,b.pathSegType)}};for(e._svgPathToAbsolute(r),g=r.getTotalLength(),o=[],u=0;u<r.pathSegList.numberOfItems;u+=1)o.push(r.pathSegList.getItem(u));for(c=o.concat();S<g;){if(M=r.getPathSegAtLength(S),t=o[M],t!=p){for(;c.length&&c[0]!=t;)w(c.shift());p=t}switch(t.pathSegTypeAsLetter.toUpperCase()){case"C":case"T":case"S":case"Q":case"A":l=r.getPointAtLength(S),I(l.x,l.y,0);break}S+=a}for(u=0,f=c.length;u<f;++u)w(c[u]);return E},e._svgPathToAbsolute=function(r){for(var a,u,f,g,l,t,o=r.pathSegList,c=0,p=0,x=o.numberOfItems,M=0;M<x;++M){var E=o.getItem(M),T=E.pathSegTypeAsLetter;if(/[MLHVCSQTA]/.test(T))"x"in E&&(c=E.x),"y"in E&&(p=E.y);else switch("x1"in E&&(f=c+E.x1),"x2"in E&&(l=c+E.x2),"y1"in E&&(g=p+E.y1),"y2"in E&&(t=p+E.y2),"x"in E&&(c+=E.x),"y"in E&&(p+=E.y),T){case"m":o.replaceItem(r.createSVGPathSegMovetoAbs(c,p),M);break;case"l":o.replaceItem(r.createSVGPathSegLinetoAbs(c,p),M);break;case"h":o.replaceItem(r.createSVGPathSegLinetoHorizontalAbs(c),M);break;case"v":o.replaceItem(r.createSVGPathSegLinetoVerticalAbs(p),M);break;case"c":o.replaceItem(r.createSVGPathSegCurvetoCubicAbs(c,p,f,g,l,t),M);break;case"s":o.replaceItem(r.createSVGPathSegCurvetoCubicSmoothAbs(c,p,l,t),M);break;case"q":o.replaceItem(r.createSVGPathSegCurvetoQuadraticAbs(c,p,f,g),M);break;case"t":o.replaceItem(r.createSVGPathSegCurvetoQuadraticSmoothAbs(c,p),M);break;case"a":o.replaceItem(r.createSVGPathSegArcAbs(c,p,E.r1,E.r2,E.angle,E.largeArcFlag,E.sweepFlag),M);break;case"z":case"Z":c=a,p=u;break}(T=="M"||T=="m")&&(a=c,u=p)}}})()}),(function(d,m,s){var e={};d.exports=e;var n=s(6);s(0),(function(){e.create=n.create,e.add=n.add,e.remove=n.remove,e.clear=n.clear,e.addComposite=n.addComposite,e.addBody=n.addBody,e.addConstraint=n.addConstraint})()})])})})(Se)),Se.exports}var Ze=Ye();const V=Xe(Ze),ye=2,xe=3,ke=10,Ke=15;function je(i,h,d,m,s,e){const n=Math.max(0,Math.min(e,m/2,s/2));i.moveTo(h+n,d),i.lineTo(h+m-n,d),i.arcTo(h+m,d,h+m,d+n,n),i.lineTo(h+m,d+s-n),i.arcTo(h+m,d+s,h+m-n,d+s,n),i.lineTo(h+n,d+s),i.arcTo(h,d+s,h,d+s-n,n),i.lineTo(h,d+n),i.arcTo(h,d,h+n,d,n),i.closePath()}const F={engine:null,render:null,world:null,runner:null,isInitialized:!1,isRunning:!1,currentMode:"sand",currentSegments:k.SAND_COLORS.length,renderMaskHandler:null,init:function(i,h,d,m={}){const s=m.mode||F.currentMode||"sand",e=Math.max(1,m.segments||(s==="sand"?k.SAND_COLORS.length:1));if(F.isInitialized){const r=F.render&&(F.render.options.width!==h||F.render.options.height!==d),a=F.currentMode!==s||F.currentSegments!==e;r&&F.render&&(console.log(`Resizing physics renderer to ${h}x${d}`),F.render.bounds.max.x=h,F.render.bounds.max.y=d,F.render.options.width=h,F.render.options.height=d,F.render.canvas.width=h,F.render.canvas.height=d),(r||a)&&(F.currentMode=s,F.currentSegments=e,F.updateWallPositions(h,d)),F.configureRenderMask(),F.start();return}if(console.log(`Initializing Physics Engine (${s}): ${h}x${d}`),!i||isNaN(h)||isNaN(d)||h<=0||d<=0){console.error("Cannot initialize Physics: Invalid canvas or dimensions.");return}const n={enableSleeping:!0,positionIterations:8,velocityIterations:6};F.engine=V.Engine.create(n),F.world=F.engine.world,F.engine.world.gravity.y=.7,F.render=V.Render.create({element:i.parentNode,canvas:i,engine:F.engine,options:{width:h,height:d,wireframes:!1,background:"transparent",showSleeping:!1,pixelRatio:window.devicePixelRatio||1}}),F.currentMode=s,F.currentSegments=e,F.createWalls(h,d,s,e),F.configureRenderMask(),F.runner=V.Runner.create(),V.Runner.run(F.runner,F.engine),V.Render.run(F.render),F.isInitialized=!0,F.isRunning=!0,console.log("Physics engine initialized and running.")},createWalls:function(i,h,d=F.currentMode,m=F.currentSegments){if(!F.world)return;const s=V.Composite.allBodies(F.world).filter(a=>a.isStatic);s.length>0&&V.World.remove(F.world,s);const e=15,n={isStatic:!0,friction:.6,restitution:.1,render:{visible:!1}},r=[];if(r.push(V.Bodies.rectangle(i/2,h+e/2,i+e*2,e,n)),r.push(V.Bodies.rectangle(-e/2,h/2,e,h+e*2,n)),r.push(V.Bodies.rectangle(i+e/2,h/2,e,h+e*2,n)),d==="sand"){const a=Math.max(1,m),u=i/a;for(let f=1;f<a;f++){const g=f*u;r.push(V.Bodies.rectangle(g,h/2,e,h+e*2,n))}}V.World.add(F.world,r)},updateWallPositions:function(i,h){F.createWalls(i,h,F.currentMode,F.currentSegments)},addParticle:function(i,h){if(!F.isInitialized||!F.engine||!F.world||!F.render?.options?.width||F.currentMode!=="sand")return!1;const d=Math.max(1,F.currentSegments||k.SAND_COLORS.length);if(i<0||i>=d)return!1;const m=F.render.options.width/d,s=y.preferences?.sandParticleSize||5,e=15,n=s*.5,r=i*m,a=r+e/2+s+n,u=r+m-e/2-s-n;if(a>=u)return!1;const f=a+Math.random()*(u-a),g=s+4,l=V.Bodies.polygon(f,g,6,s,{restitution:.15,friction:.7,frictionAir:.01,density:.01,render:{fillStyle:h},sleepThreshold:60});return V.Body.setVelocity(l,{x:(Math.random()-.5)*.1,y:Math.random()*.1}),V.Body.setAngularVelocity(l,(Math.random()-.5)*.01),V.World.add(F.world,l),!0},addWaterParticle:function(i="#4aa8ff"){if(!F.isInitialized||!F.engine||!F.world||!F.render?.options?.width||F.currentMode!=="water")return!1;const h=F.render.options.width,d=Math.max(2,(y.preferences?.sandParticleSize||5)*.8),m=15,s=d*.25,e=m/2+d+s,n=h-m/2-d-s;if(e>=n)return!1;const r=e+Math.random()*(n-e),a=-d*2,u=V.Bodies.circle(r,a,d,{restitution:.03,friction:.01,frictionStatic:.02,frictionAir:.01,density:8e-4,render:{fillStyle:i},sleepThreshold:120});return V.Body.setVelocity(u,{x:(Math.random()-.5)*.08,y:Math.random()*.06}),V.World.add(F.world,u),!0},getSegmentTopYs:function(){if(!F.world||!F.render?.options?.width)return null;const i=Math.max(1,F.currentSegments||k.SAND_COLORS.length),h=F.render.options.width/i,d=Array(i).fill(1/0);return V.Composite.allBodies(F.world).filter(s=>!s.isStatic).forEach(s=>{const e=s.position?.x;if(typeof e!="number"||Number.isNaN(e))return;const n=Math.max(0,Math.min(i-1,Math.floor(e/h))),r=s.bounds?.min?.y;typeof r=="number"&&!Number.isNaN(r)&&r<d[n]&&(d[n]=r)}),d},getTopY:function(){if(!F.world)return null;const i=V.Composite.allBodies(F.world).filter(d=>!d.isStatic);if(i.length===0)return 1/0;let h=1/0;return i.forEach(d=>{const m=d.bounds?.min?.y;typeof m=="number"&&!Number.isNaN(m)&&m<h&&(h=m)}),h},clearDynamicBodies:function(){if(!F.world)return;const h=V.Composite.allBodies(F.world).filter(d=>!d.isStatic);h.length>0&&V.World.remove(F.world,h)},configureRenderMask:function(){F.render&&(F.renderMaskHandler&&(V.Events.off(F.render,"afterRender",F.renderMaskHandler),F.renderMaskHandler=null),F.currentMode==="sand"&&(F.renderMaskHandler=()=>{F.applyRoundedSegmentMask()},V.Events.on(F.render,"afterRender",F.renderMaskHandler)))},applyRoundedSegmentMask:function(){if(!F.render?.context||!F.render?.options)return;const i=F.render.context,h=F.render.options.width,d=F.render.options.height,m=Math.max(1,F.currentSegments||k.SAND_COLORS.length),e=(Math.max(1,h-ye*2)-ke*(m-1))/m,n=Math.max(1,d-ye*2-xe*2),r=ye+xe;i.save(),i.globalCompositeOperation="destination-in",i.beginPath();for(let a=0;a<m;a++){const u=ye+a*(e+ke)+xe,f=Math.max(1,e-xe*2),g=Math.min(Ke,f/2,n/2);je(i,u,r,f,n,g)}i.fillStyle="#ffffff",i.fill(),i.restore()},stop:function(){F.isRunning&&(F.runner&&V.Runner.stop(F.runner),F.render&&V.Render.stop(F.render),F.isRunning=!1)},start:function(){F.isRunning||!F.isInitialized||(F.render&&V.Render.run(F.render),F.runner&&F.engine?(V.Runner.run(F.runner,F.engine),F.isRunning=!0):console.error("Cannot start physics, not initialized."))},destroy:function(){console.log("Destroying physics engine..."),F.stop(),F.render&&F.renderMaskHandler&&(V.Events.off(F.render,"afterRender",F.renderMaskHandler),F.renderMaskHandler=null),F.world&&V.World.clear(F.world,!1),F.engine&&V.Engine.clear(F.engine),F.engine=null,F.world=null,F.render=null,F.runner=null,F.isInitialized=!1,F.isRunning=!1,F.currentMode="sand",F.currentSegments=k.SAND_COLORS.length,console.log("Physics engine destroyed.")}},de=k.SAND_COLORS.length,he=2,Re=10,ge=3,_e=220,Oe=320,Ne=1150,et=6.5,tt=18,nt=.18,rt=15;function j(i,h,d){return Math.max(h,Math.min(d,i))}function Me(i,h={r:74,g:168,b:255}){if(typeof i!="string")return h;const d=i.trim().replace("#",""),m=d.length===3?d.split("").map(s=>`${s}${s}`).join(""):d;return/^[0-9a-fA-F]{6}$/.test(m)?{r:parseInt(m.slice(0,2),16),g:parseInt(m.slice(2,4),16),b:parseInt(m.slice(4,6),16)}:h}function se(i,h){return`rgba(${i.r}, ${i.g}, ${i.b}, ${h})`}function oe(i,h){return{r:j(Math.round(i.r+h),0,255),g:j(Math.round(i.g+h),0,255),b:j(Math.round(i.b+h),0,255)}}function ze(i,h){return oe(i,-h)}function st(i){const h=Math.max(14,Math.round(i/6));return Array.from({length:h},()=>({offset:0,velocity:0}))}function Ce(i,h){return j(i.fillUnits/Math.max(1,h),0,1)}function We(i,h){const d=Ce(i,h);return i.yBottom-i.height*d}function it(i,h,d){const m=i.surfacePoints,s=Ce(i,h),e=We(i,h);if(m.length===0||s<=0)return i.yBottom;const n=j(d/Math.max(1,i.width),0,1)*(m.length-1),r=Math.floor(n),a=Math.min(m.length-1,r+1),u=n-r,f=m[r].offset,g=m[a].offset;return e+(f+(g-f)*u)}function at(i){i.surfacePoints.forEach(h=>{h.offset=0,h.velocity=0})}function ot(i,h,d,m,s,e){const n=Math.max(0,Math.min(e,m/2,s/2));i.moveTo(h+n,d),i.lineTo(h+m-n,d),i.arcTo(h+m,d,h+m,d+n,n),i.lineTo(h+m,d+s-n),i.arcTo(h+m,d+s,h+m-n,d+s,n),i.lineTo(h+n,d+s),i.arcTo(h,d+s,h,d+s-n,n),i.lineTo(h,d+n),i.arcTo(h,d,h+n,d,n),i.closePath()}function lt(i,h,d){const m=Math.sqrt(h.vx*h.vx+h.vy*h.vy),s=j(m/420,0,1),e=Math.sin((h.x+h.y)*.07)*.05,n=h.radius*j(.95-s*.22+e,.55,1.05),r=h.radius*(1.25+s*.95),a=Math.atan2(h.vy,h.vx)-Math.PI/2;i.save(),i.translate(h.x,h.y),i.rotate(a);const u=i.createLinearGradient(0,-r,0,r);u.addColorStop(0,se(oe(d,45),.9)),u.addColorStop(.55,se(oe(d,12),.95)),u.addColorStop(1,se(ze(d,32),.88)),i.beginPath(),i.moveTo(0,-r*1.05),i.bezierCurveTo(n*.95,-r*.7,n*1.2,r*.2,0,r),i.bezierCurveTo(-n*1.2,r*.2,-n*.95,-r*.7,0,-r*1.05),i.closePath(),i.fillStyle=u,i.fill(),i.beginPath(),i.ellipse(-n*.18,-r*.2,n*.22,r*.2,0,0,Math.PI*2),i.fillStyle=se(oe(d,110),.45),i.fill(),s>.18&&(i.beginPath(),i.moveTo(0,-r*1.02),i.lineTo(0,-r*(1.35+s*.35)),i.strokeStyle=se(oe(d,70),.35),i.lineWidth=Math.max(.6,h.radius*.22),i.lineCap="round",i.stroke()),i.restore()}function ct(i,h,d){const m=Math.sqrt(h.vx*h.vx+h.vy*h.vy),s=j(m/280,0,1),e=Math.atan2(h.vy,h.vx),n=j(h.life/h.maxLife,0,1),r=h.radius*(1+s*.9),a=h.radius*(1-s*.35);i.save(),i.translate(h.x,h.y),i.rotate(e),i.beginPath(),i.ellipse(0,0,r,Math.max(.6,a),0,0,Math.PI*2),i.fillStyle=se(oe(d,55),n*.9),i.fill(),i.restore()}const L={canvas:null,ctx:null,width:0,height:0,dpr:1,bars:[],droplets:[],splashParticles:[],isInitialized:!1,isRunning:!1,rafId:null,lastFrameMs:0,barCapacity:120,dropletRadius:3,maxDroplets:_e,colors:[...k.SAND_COLORS],frameClockMs:0,init:function(i,h,d,m={}){if(!i||!Number.isFinite(h)||!Number.isFinite(d)||h<=0||d<=0){console.error("WaterBars.init called with invalid canvas or dimensions.");return}if(L.isInitialized&&L.canvas!==i&&L.destroy(),L.canvas=i,L.ctx=i.getContext("2d",{alpha:!0}),!L.ctx){console.error("WaterBars could not acquire 2D context.");return}const s=Array.isArray(m.colors)&&m.colors.length>0?m.colors.slice(0,de):[...k.SAND_COLORS];L.colors=s,m.capacityPerBar!==void 0&&L.setCapacity(m.capacityPerBar),m.particleRadius!==void 0&&L.setParticleRadius(m.particleRadius),L.resize(h,d),L.isInitialized=!0,L.renderOnce()},resize:function(i,h){if(!L.canvas||!L.ctx||!Number.isFinite(i)||!Number.isFinite(h)||i<=0||h<=0)return;const d=L.bars.map(m=>m.fillUnits||0);L.width=Math.max(1,Math.floor(i)),L.height=Math.max(1,Math.floor(h)),L.dpr=Math.min(window.devicePixelRatio||1,2),L.canvas.width=Math.floor(L.width*L.dpr),L.canvas.height=Math.floor(L.height*L.dpr),L.canvas.style.width=`${L.width}px`,L.canvas.style.height=`${L.height}px`,L.ctx.setTransform(L.dpr,0,0,L.dpr,0,0),L.rebuildBars(d)},rebuildBars:function(i=[]){L.droplets=[],L.splashParticles=[],L.bars=[];const h=Math.max(20,L.width-he*2),d=Math.max(20,L.height-he*2),m=Math.max(8,(h-Re*(de-1))/de),s=he,e=he+ge,n=L.height-he-ge,r=Math.max(8,d-ge*2);for(let a=0;a<de;a++){const u=s+a*(m+Re)+ge,f=Math.max(4,m-ge*2),g=j(Number(i[a])||0,0,L.barCapacity),l={index:a,x:u,width:f,yTop:e,yBottom:n,height:r,cornerRadius:Math.min(rt,f/2,r/2),colorHex:L.colors[a]||k.SAND_COLORS[a]||"#4aa8ff",fillUnits:g,surfacePoints:st(f)};L.bars.push(l)}},reset:function(){L.droplets=[],L.splashParticles=[],L.bars.forEach(i=>{i.fillUnits=0,at(i)}),L.renderOnce()},setCapacity:function(i){const h=Number(i);L.barCapacity=Number.isFinite(h)?Math.max(1,Math.floor(h)):120,L.bars.forEach(d=>{d.fillUnits=j(d.fillUnits,0,L.barCapacity)})},setParticleRadius:function(i){const h=Number(i);Number.isFinite(h)&&(L.dropletRadius=j(h,1.6,12))},setColors:function(i){!Array.isArray(i)||i.length===0||(L.colors=i.slice(0,de),L.bars.forEach((h,d)=>{h.colorHex=L.colors[d]||h.colorHex}))},getTotalCapacity:function(){return L.barCapacity*L.bars.length},getTotalFillUnits:function(){return L.bars.length===0?0:L.bars.reduce((i,h)=>i+h.fillUnits,0)},getPendingDropletCount:function(){return L.droplets.length},getPendingForBar:function(i){return L.droplets.reduce((h,d)=>h+(d.barIndex===i?1:0),0)},getBarProjectedRemaining:function(i){if(i<0||i>=L.bars.length)return 0;const h=L.bars[i],d=L.getPendingForBar(i);return Math.max(0,L.barCapacity-h.fillUnits-d)},findBestBarIndex:function(i=-1){if(L.bars.length===0)return-1;if(i>=0&&i<L.bars.length&&L.getBarProjectedRemaining(i)>0)return i;let h=-1,d=0;for(let m=0;m<L.bars.length;m++){const s=L.getBarProjectedRemaining(m);s>d&&(d=s,h=m)}return h},addDroplet:function(i,h){if(!L.isInitialized||!L.ctx||i<0||i>=L.bars.length||L.droplets.length>=L.maxDroplets)return!1;const d=L.bars[i],m=j(L.dropletRadius,1.6,Math.max(2.2,d.width*.48)),s=d.x+m,e=d.x+d.width-m,n=e>s?s+Math.random()*(e-s):d.x+d.width*.5;return L.droplets.push({barIndex:i,colorHex:h||d.colorHex,radius:m,x:n,y:d.yTop+m+1,vx:(Math.random()-.5)*22,vy:24+Math.random()*52}),!0},createSplash:function(i,h,d,m,s){if(L.splashParticles.length>=Oe)return;const e=Math.min(7,3+Math.floor(m/120));for(let n=0;n<e&&!(L.splashParticles.length>=Oe);n++){const r=70+Math.random()*130+m*.1,a=-Math.PI/2+(Math.random()-.5)*1.2;L.splashParticles.push({barIndex:i.index,x:h,y:d-1,vx:Math.cos(a)*r,vy:Math.sin(a)*r,radius:1+Math.random()*1.8,life:.18+Math.random()*.28,maxLife:.46,colorHex:s})}},disturbSurface:function(i,h,d){const m=i.surfacePoints;if(!m||m.length===0)return;const s=j((h-i.x)/Math.max(1,i.width),0,1),e=Math.round(s*(m.length-1)),n=j(d*.16,10,200);for(let r=Math.max(0,e-2);r<=Math.min(m.length-1,e+2);r++){const u=1-Math.abs(r-e)/3;m[r].velocity+=n*Math.max(0,u)}},updateDroplets:function(i){if(L.droplets.length!==0)for(let h=L.droplets.length-1;h>=0;h--){const d=L.droplets[h],m=L.bars[d.barIndex];if(!m){L.droplets.splice(h,1);continue}d.vy+=Ne*i,d.vx*=Math.max(0,1-i*1.8),d.x+=d.vx*i,d.y+=d.vy*i;const s=m.x+d.radius,e=m.x+m.width-d.radius;d.x<s?(d.x=s,d.vx*=-.3):d.x>e&&(d.x=e,d.vx*=-.3);const n=it(m,L.barCapacity,d.x-m.x);if(d.y+d.radius>=n){m.fillUnits=j(m.fillUnits+1,0,L.barCapacity),L.disturbSurface(m,d.x,d.vy),L.createSplash(m,d.x,n,d.vy,d.colorHex||m.colorHex),L.droplets.splice(h,1);continue}d.y-d.radius>m.yBottom+26&&L.droplets.splice(h,1)}},updateSplashParticles:function(i){if(L.splashParticles.length!==0)for(let h=L.splashParticles.length-1;h>=0;h--){const d=L.splashParticles[h];d.vy+=Ne*.74*i,d.vx*=Math.max(0,1-i*.9),d.x+=d.vx*i,d.y+=d.vy*i,d.life-=i,(d.life<=0||d.y>L.height+16)&&L.splashParticles.splice(h,1)}},updateSurface:function(i){const h=Math.min(.05,i);L.bars.forEach(d=>{const m=d.surfacePoints;if(!m||m.length===0)return;const s=m.map(u=>u.offset),e=d.height*nt,r=Ce(d,L.barCapacity)>.02?Math.sin(L.frameClockMs*.0019+d.index*.85)*d.height*6e-4:0;for(let u=0;u<m.length;u++){const f=m[u],g=s[u>0?u-1:u],l=s[u<m.length-1?u+1:u],t=g+l-2*s[u],o=-34*s[u],c=tt*t;f.velocity+=(o+c)*h,f.velocity*=Math.max(0,1-et*h),f.offset+=f.velocity*h,f.offset=j(f.offset,-e,e)}const a=Math.floor(m.length/2);m[a].velocity+=r})},isNearTop:function(){return L.bars.length===0?!1:L.bars.every(i=>i.fillUnits>=L.barCapacity)},ensureSizeFromCanvas:function(){if(!L.canvas)return;const i=Math.max(1,Math.floor(L.canvas.clientWidth||0)),h=Math.max(1,Math.floor(L.canvas.clientHeight||0));(i!==L.width||h!==L.height)&&L.resize(i,h)},start:function(){!L.isInitialized||L.isRunning||(L.isRunning=!0,L.lastFrameMs=performance.now(),L.rafId=requestAnimationFrame(L.tick))},stop:function(){L.isRunning&&(L.isRunning=!1,L.rafId&&(cancelAnimationFrame(L.rafId),L.rafId=null),L.lastFrameMs=0)},tick:function(i){if(!L.isRunning)return;const h=j((i-L.lastFrameMs)/1e3,.001,.05);L.lastFrameMs=i,L.frameClockMs=i,L.ensureSizeFromCanvas(),L.updateDroplets(h),L.updateSplashParticles(h),L.updateSurface(h),L.renderOnce(),L.rafId=requestAnimationFrame(L.tick)},renderOnce:function(){if(!L.ctx)return;const i=L.ctx;i.clearRect(0,0,L.width,L.height);const h=Array.from({length:L.bars.length},()=>[]),d=Array.from({length:L.bars.length},()=>[]);L.droplets.forEach(m=>{m.barIndex>=0&&m.barIndex<h.length&&h[m.barIndex].push(m)}),L.splashParticles.forEach(m=>{m.barIndex>=0&&m.barIndex<d.length&&d[m.barIndex].push(m)}),L.bars.forEach(m=>{if(i.save(),i.beginPath(),ot(i,m.x,m.yTop,m.width,m.height,m.cornerRadius),i.clip(),Ce(m,L.barCapacity)>0){const e=Me(m.colorHex),n=oe(e,38),r=oe(e,10),a=ze(e,28),u=We(m,L.barCapacity),f=i.createLinearGradient(0,m.yTop,0,m.yBottom);f.addColorStop(0,se(n,.78)),f.addColorStop(.48,se(r,.84)),f.addColorStop(1,se(a,.93)),i.beginPath(),i.moveTo(m.x,m.yBottom),i.lineTo(m.x,u+m.surfacePoints[0].offset);for(let g=1;g<m.surfacePoints.length;g++){const l=m.x+g/(m.surfacePoints.length-1)*m.width,t=u+m.surfacePoints[g].offset;i.lineTo(l,t)}i.lineTo(m.x+m.width,m.yBottom),i.closePath(),i.fillStyle=f,i.fill(),i.beginPath();for(let g=0;g<m.surfacePoints.length;g++){const l=m.x+g/(m.surfacePoints.length-1)*m.width,t=u+m.surfacePoints[g].offset;g===0?i.moveTo(l,t):i.lineTo(l,t)}i.lineWidth=1.7,i.strokeStyle=se(oe(e,85),.7),i.stroke()}d[m.index].forEach(e=>{const n=Me(e.colorHex);ct(i,e,n)}),h[m.index].forEach(e=>{const n=Me(e.colorHex);lt(i,e,n)}),i.restore()})},destroy:function(){L.stop(),L.bars=[],L.droplets=[],L.splashParticles=[],L.canvas=null,L.ctx=null,L.width=0,L.height=0,L.isInitialized=!1}},W={update:function(i){y.preferences.showScheduleCircles?W.renderScheduleCircles():B.scheduleCirclesDisplayEl&&(B.scheduleCirclesDisplayEl.innerHTML="")},renderScheduleCircles:function(){if(!y.preferences.showScheduleCircles||!B.scheduleCirclesDisplayEl){B.scheduleCirclesDisplayEl&&(B.scheduleCirclesDisplayEl.innerHTML="");return}const i=le(),h=G.getCurrentPeriodInfo(i),d=y.getActiveColourScheme(),m=(y.schedule||[]).map((n,r)=>({...n,originalIndex:r})).filter(n=>n.showCircles);if(m.length===0){B.scheduleCirclesDisplayEl.innerHTML="";return}let s=-1;h&&(s=m.findIndex(n=>n.originalIndex===h.index));let e="";for(let n=0;n<m.length;n++){const r=s>=n,a=r?"â—":"â—‹",u=`schedule-circle-symbol ${r?"active":"inactive"}`,f=r?d.text:"#555";e+=`<span class="${u}" style="color: ${f};">${a}</span>`}B.scheduleCirclesDisplayEl.innerHTML=e},setupPhysicsSandBars:function(i){if(W.stopPhysicsCheckInterval(),L.stop(),L.reset(),F.clearDynamicBodies(),k.physicsParticlesAdded=0,k.totalParticlesForPeriod=0,!y.preferences.showSandBars||!B.sandBarsCanvas||!B.sandBarsContainerEl){F.stop();return}const h=y.preferences?.sandHeight||150,d=y.preferences?.sandWidth||80;B.sandBarsContainerEl.style.height=`${h}px`,B.sandBarsContainerEl.style.width=`${d}%`,requestAnimationFrame(()=>{const m=B.sandBarsContainerEl.offsetWidth,s=B.sandBarsContainerEl.offsetHeight;if(m<=0||s<=0){console.warn("Sand bars container has zero dimensions after rAF. Aborting physics setup."),F.stop();return}const e=y.preferences?.sandParticleSize||5,n=3*Math.sqrt(3)/2*e*e,r=m/k.SAND_COLORS.length,u=Math.max(0,r-15-e*.25),f=Math.max(0,s-e*.2),g=u*f,l=.94;k.visualMaxParticlesPerSegment=Math.max(10,Math.floor(g*l/n)),k.totalParticlesForPeriod=k.visualMaxParticlesPerSegment*k.SAND_COLORS.length,console.log(`Est. Max Particles Per Segment (Hex): ${k.visualMaxParticlesPerSegment}, Total Target: ${k.totalParticlesForPeriod}, Particle Area: ${n.toFixed(2)}`),F.init(B.sandBarsCanvas,m,s,{mode:"sand",segments:k.SAND_COLORS.length}),F.start(),W.handleColorSchemeChange();const t=i||G.getCurrentPeriodInfo(le());t?t.end.getTime()-t.start.getTime()>0?(W.checkAndAddParticles(),k.physicsCheckIntervalId=setInterval(W.checkAndAddParticles,k.physicsCheckIntervalMs)):(console.log("Period duration is zero or negative, stopping sand physics."),F.stop()):(console.log("No current period found, stopping sand physics."),F.stop())})},setupPhysicsWaterFill:function(i){if(W.stopPhysicsCheckInterval(),F.clearDynamicBodies(),F.stop(),k.physicsParticlesAdded=0,k.totalParticlesForPeriod=0,!y.preferences.showWaterFill||!B.waterFillCanvas||!B.waterFillContainerEl){L.stop(),L.reset();return}const h=y.preferences?.sandHeight||150,d=y.preferences?.sandWidth||80;B.waterFillContainerEl.style.height=`${h}px`,B.waterFillContainerEl.style.width=`${d}%`,requestAnimationFrame(()=>{const m=B.waterFillContainerEl.offsetWidth,s=B.waterFillContainerEl.offsetHeight;if(m<=0||s<=0){console.warn("Water fill container has zero dimensions after rAF. Aborting physics setup."),L.stop();return}const e=k.SAND_COLORS.length,n=Math.max(2,(y.preferences?.sandParticleSize||5)*.75),r=Math.PI*n*n,a=8,u=10,f=Math.max(20,m-a*2),g=Math.max(20,s-8),l=Math.max(6,(f-u*(e-1))/e),t=.7;k.visualMaxParticlesPerSegment=Math.max(30,Math.floor(l*g*t/r)),k.totalParticlesForPeriod=k.visualMaxParticlesPerSegment*e,console.log(`Est. Max Water Droplets Per Segment: ${k.visualMaxParticlesPerSegment}, Total Target: ${k.totalParticlesForPeriod}, Particle Area: ${r.toFixed(2)}`),L.init(B.waterFillCanvas,m,s,{colors:k.SAND_COLORS,capacityPerBar:k.visualMaxParticlesPerSegment,particleRadius:n}),L.setCapacity(k.visualMaxParticlesPerSegment),L.setParticleRadius(n),L.reset(),L.start(),W.handleColorSchemeChange();const o=i||G.getCurrentPeriodInfo(le());o?o.end.getTime()-o.start.getTime()>0?(W.checkAndAddWaterParticles(),k.physicsCheckIntervalId=setInterval(W.checkAndAddWaterParticles,k.physicsCheckIntervalMs)):console.log("Period duration is zero or negative, showing empty water bars."):console.log("No current period found, showing empty water bars.")})},isSandBarsNearTop:function(){if(!F.isInitialized||!F.isRunning)return!1;const i=F.getSegmentTopYs();if(!i||i.length!==k.SAND_COLORS.length)return!1;const h=y.preferences?.sandParticleSize||5,d=Math.max(2,h*1.2);return i.every(m=>Number.isFinite(m)&&m<=d)},isWaterNearTop:function(){return L.isNearTop()},checkAndAddParticles:function(){if(!y.preferences.showSandBars||!F.isRunning||k.totalParticlesForPeriod<=0){W.stopPhysicsCheckInterval();return}const i=le(),h=G.getCurrentPeriodInfo(i);if(!h){W.stopPhysicsCheckInterval();return}const d=h.start.getTime(),s=h.end.getTime()-d;if(s<=0){W.stopPhysicsCheckInterval();return}if(W.isSandBarsNearTop()){W.stopPhysicsCheckInterval();return}const n=Math.max(0,i.getTime()-d),r=Math.min(1,n/s),a=Math.floor(r*k.totalParticlesForPeriod),u=Math.ceil(k.totalParticlesForPeriod*1.35),g=Math.min(a,u)-k.physicsParticlesAdded;if(g<=0)return;const l=6;for(let t=0;t<Math.min(g,l)&&!(k.physicsParticlesAdded>=u);++t){const o=s/k.SAND_COLORS.length,c=k.physicsParticlesAdded;let p;if(c<k.totalParticlesForPeriod){const x=(c+.5)/k.totalParticlesForPeriod*s;p=Math.min(k.SAND_COLORS.length-1,Math.floor(x/o))}else p=c%k.SAND_COLORS.length;if(p>=0)if(F.addParticle(p,k.SAND_COLORS[p]))k.physicsParticlesAdded++;else break}k.physicsParticlesAdded>=u&&W.stopPhysicsCheckInterval()},checkAndAddWaterParticles:function(){if(!y.preferences.showWaterFill||!L.isRunning||k.totalParticlesForPeriod<=0){W.stopPhysicsCheckInterval();return}const i=le(),h=G.getCurrentPeriodInfo(i);if(!h){W.stopPhysicsCheckInterval();return}const d=h.start.getTime(),s=h.end.getTime()-d;if(s<=0){W.stopPhysicsCheckInterval();return}const e=Math.max(1,L.getTotalCapacity()||k.totalParticlesForPeriod);k.totalParticlesForPeriod=e;const n=L.getTotalFillUnits(),r=L.getPendingDropletCount(),a=n+r;if(k.physicsParticlesAdded=a,W.isWaterNearTop()&&r===0){W.stopPhysicsCheckInterval();return}const u=Math.max(0,i.getTime()-d),f=Math.min(1,u/s),g=Math.floor(f*e),l=Math.ceil(e*1.6),o=Math.min(g,l)-a;if(o<=0)return;const c=5;for(let x=0;x<Math.min(o,c);++x){const M=a+x;if(M>=l)break;const E=s/k.SAND_COLORS.length,T=M;let v;if(T<e){const P=(T+.5)/e*s;v=Math.min(k.SAND_COLORS.length-1,Math.floor(P/E))}else v=T%k.SAND_COLORS.length;const S=L.findBestBarIndex(v);if(S>=0){if(!L.addDroplet(S,k.SAND_COLORS[S]))break}else break}const p=L.getPendingDropletCount();W.isWaterNearTop()&&p===0&&W.stopPhysicsCheckInterval()},stopPhysicsCheckInterval:function(){k.physicsCheckIntervalId&&(clearInterval(k.physicsCheckIntervalId),k.physicsCheckIntervalId=null)},handlePeriodChange:function(i){if(y.preferences.showSandBars){W.setupPhysicsSandBars(i);return}if(y.preferences.showWaterFill){W.setupPhysicsWaterFill(i);return}W.stopPhysicsCheckInterval(),L.stop(),L.reset(),F.clearDynamicBodies(),F.stop()},handleDisplayToggle:function(){const i=G.getCurrentPeriodInfo(le());if(y.preferences.showSandBars){W.setupPhysicsSandBars(i);return}if(y.preferences.showWaterFill){W.setupPhysicsWaterFill(i);return}W.stopPhysicsCheckInterval(),L.stop(),L.reset(),F.clearDynamicBodies(),F.stop()},handleColorSchemeChange:function(){const i=y.getActiveColourScheme().text||"#FFFFFF";document.querySelectorAll(".sand-bar-outline-segment, .water-fill-outline-segment").forEach(h=>{h.style.borderColor=i}),y.preferences.showScheduleCircles&&W.renderScheduleCircles()}},ce={update:function(){const i=y.preferences;if(!B.clockDisplayArea){console.warn("DOM cache not ready in Layout.update");return}[{el:B.dateEl,pref:"showDate"},{el:B.scheduleCirclesDisplayEl,pref:"showScheduleCircles"},{el:B.timeEl,pref:"showTime"}].forEach(n=>{n.el?.classList.toggle("element-hidden",!i[n.pref])});const d=i.showScheduleLabel||i.showProgressBar||i.showSandBars||i.showWaterFill;B.periodContainerEl?.classList.toggle("element-hidden",!d),d?B.periodLabelEl?.classList.toggle("element-hidden",!i.showScheduleLabel):B.periodLabelEl?.classList.add("element-hidden");const m=i.showProgressBar&&!i.showSandBars&&!i.showWaterFill,s=i.showSandBars,e=i.showWaterFill;B.progressBarEl?.classList.toggle("element-hidden",!m),B.sandBarsContainerEl?.classList.toggle("element-hidden",!s),B.waterFillContainerEl?.classList.toggle("element-hidden",!e),B.sandBarsCanvas&&(B.sandBarsCanvas.style.display=s?"block":"none"),B.waterFillCanvas&&(B.waterFillCanvas.style.display=e?"block":"none"),ce.applyFontAndSizePreferences()},applyFontAndSizePreferences:function(){const i=y.preferences;y.getActiveColourScheme(),B.clockDisplayArea&&(i.showDate&&B.dateEl&&(B.dateEl.style.fontSize=i.dateFontSize+"px"),i.showTime&&B.timeEl&&(B.timeEl.style.fontSize=i.timeFontSize+"px"),i.showScheduleLabel&&B.periodLabelEl&&(B.periodLabelEl.style.fontSize=i.scheduleLabelFontSize+"px"),i.showProgressBar&&!i.showSandBars&&!i.showWaterFill&&(B.timeLeftEl&&(B.timeLeftEl.style.fontSize=i.timeLeftFontSize+"px"),B.progressBarEl&&(B.progressBarEl.style.height=i.progressBarHeight+"px")),document.body.style.fontFamily=i.fontFamily,i.showScheduleCircles&&B.scheduleCirclesDisplayEl&&W.renderScheduleCircles())}},U={attachListeners:function(){B.addScheduleRowBtn?.addEventListener("click",U.addRow),B.deleteScheduleRowBtn?.addEventListener("click",U.deleteRow)},renderTable:function(){const i=B.scheduleTableBody;if(!i){console.error("Schedule table body not found");return}i.innerHTML="",y.normalizeScheduleContinuity(),(y.schedule||[]).forEach((d,m)=>{const s=document.createElement("tr");s.dataset.index=m,s.setAttribute("draggable","true"),m===k.selectedScheduleRowIndex&&s.classList.add("selected"),s.appendChild(U.createDragCell()),s.appendChild(U.createLabelCell(d,m)),s.appendChild(U.createTimeCell(d,m,"start")),s.appendChild(U.createTimeCell(d,m,"end")),s.appendChild(U.createSchemeCell(d,m)),s.appendChild(U.createAlertCell(d,m)),s.appendChild(U.createCirclesCell(d,m)),s.addEventListener("click",U.handleRowClick),s.addEventListener("dragstart",U.handleDragStart),s.addEventListener("dragover",U.handleDragOver),s.addEventListener("dragleave",U.handleDragLeave),s.addEventListener("drop",U.handleDrop),s.addEventListener("dragend",U.handleDragEnd),i.appendChild(s)}),i.removeEventListener("dragleave",U.handleTableDragLeave),i.addEventListener("dragleave",U.handleTableDragLeave)},createDragCell:function(){const i=document.createElement("td");return i.innerHTML="â˜°",i.className="drag-handle",i.title="Drag to reorder",i},createLabelCell:function(i,h){const d=document.createElement("td"),m=document.createElement("input");return m.type="text",m.value=i.label||"",m.placeholder="Period Label",m.addEventListener("change",function(){y.schedule&&y.schedule[h]&&(y.schedule[h].label=this.value,y.save(),G.update())}),d.appendChild(m),d},createTimeCell:function(i,h,d){const m=document.createElement("td"),s=document.createElement("input");if(s.type="time",d==="end"){const e=U.isEndLocked(h);s.value=U.getEffectiveEndValue(h,i),e?(s.readOnly=!0,s.classList.add("locked-time"),s.title="Locked to the next row's Start time"):s.addEventListener("change",function(){y.schedule&&y.schedule[h]&&(y.schedule[h].end=this.value,y.save(),G.update())})}else s.value=i.start||"00:00",s.addEventListener("change",function(){y.schedule&&y.schedule[h]&&(y.schedule[h].start=this.value,y.normalizeScheduleContinuity(),y.save(),U.renderTable(),G.update())});return m.appendChild(s),m},isEndLocked:function(i){return i>=0&&i<y.schedule.length-1},getEffectiveEndValue:function(i,h){return U.isEndLocked(i)?y.schedule[i+1]?.start||h?.end||"00:00":h?.end||"23:59"},createSchemeCell:function(i,h){const d=document.createElement("td"),m=document.createElement("div");m.className="scheme-swatch";const s=y.preferences?.colourSchemes||[],e=s.find(n=>n.id===i.colourSchemeId)||s.find(n=>n.id===1)||s[0];return m.style.backgroundColor=e?e.background:"#ff00ff",m.style.borderColor=e?e.text:"#ffffff",m.title=`Scheme: ${e?e.name:"Unknown"} (ID: ${i.colourSchemeId}). Click to cycle.`,m.addEventListener("click",n=>{n.stopPropagation(),U.cycleSchemeForRow(h)}),d.appendChild(m),d},createAlertCell:function(i,h){const d=document.createElement("td"),m=document.createElement("button"),s=y.alerts[h]?.colour?.enabled||!1;return m.innerHTML=s?"ðŸ”´":"ðŸŸ¢",m.title=`Visual Alert: ${s?"Enabled":"Disabled"}. Click to edit.`,m.className="alert-edit-btn",m.addEventListener("click",e=>{e.stopPropagation(),Q.openModal(h)}),d.appendChild(m),d.style.textAlign="center",d},createCirclesCell:function(i,h){const d=document.createElement("td"),m=document.createElement("input");return m.type="checkbox",m.checked=i.showCircles||!1,m.title="Show this period in the Schedule Circles display",m.addEventListener("change",function(s){s.stopPropagation(),y.schedule&&y.schedule[h]&&(y.schedule[h].showCircles=this.checked,y.save(),W.renderScheduleCircles())}),d.appendChild(m),d.style.textAlign="center",d},handleRowClick:function(i){const h=parseInt(this.dataset.index,10);if(i.target.tagName==="INPUT"||i.target.tagName==="BUTTON"||i.target.classList.contains("scheme-swatch")||i.target.classList.contains("drag-handle")){if(this.classList.contains("selected")){k.selectedScheduleRowIndex=h;return}}else{const d=B.scheduleTableBody?.querySelector("tr.selected");d&&d.classList.remove("selected"),this.classList.add("selected"),k.selectedScheduleRowIndex=h}},cycleSchemeForRow:function(i){if(!y.schedule||i<0||i>=y.schedule.length)return;const h=y.schedule[i].colourSchemeId||1,d=y.preferences?.colourSchemes||[];if(d.length===0)return;let s=(d.findIndex(e=>e.id===h)+1)%d.length;y.schedule[i].colourSchemeId=d[s]?.id||d[0]?.id||1,y.save(),U.renderTable(),G.update()},addRow:function(){const i=k.selectedScheduleRowIndex===null||k.selectedScheduleRowIndex<0||k.selectedScheduleRowIndex>=y.schedule.length?y.schedule.length:k.selectedScheduleRowIndex+1,h=y.schedule[i],d=y.schedule[i-1],m=h?.start||d?.start||"00:00",s=h?.start||d?.end||"23:59",e={label:"New Period",start:m,end:s,colourSchemeId:1,showCircles:!1};y.schedule.splice(i,0,e);const n={};Object.keys(y.alerts).forEach(r=>{const a=parseInt(r,10);n[a>=i?a+1:a]=y.alerts[r]}),y.alerts=n,y.normalizeScheduleContinuity(),k.selectedScheduleRowIndex=i,U.renderTable(),y.save(),G.update()},deleteRow:function(){const i=k.selectedScheduleRowIndex;if(i!==null&&i>=0&&i<y.schedule.length){if(confirm(`Delete row "${y.schedule[i].label}"?`)){y.schedule.splice(i,1),delete y.alerts[i];const h={};Object.keys(y.alerts).forEach(d=>{const m=parseInt(d,10);h[m>i?m-1:m]=y.alerts[d]}),y.alerts=h,y.normalizeScheduleContinuity(),k.selectedScheduleRowIndex=null,U.renderTable(),y.save(),G.update()}}else X.showButtonFeedback(B.deleteScheduleRowBtn,"Select Row First!",2e3)},handleDragStart:function(i){if(k.dragStartIndex=parseInt(this.dataset.index,10),!isNaN(k.dragStartIndex)&&(i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text/plain",k.dragStartIndex),this.classList.add("dragging"),!this.classList.contains("selected"))){const h=B.scheduleTableBody?.querySelector("tr.selected");h&&h.classList.remove("selected"),this.classList.add("selected"),k.selectedScheduleRowIndex=k.dragStartIndex}},handleDragOver:function(i){i.preventDefault(),i.dataTransfer.dropEffect="move",this.classList.add("drag-over")},handleDragLeave:function(i){this.classList.remove("drag-over")},handleDrop:function(i){i.preventDefault(),this.classList.remove("drag-over");const h=parseInt(this.dataset.index,10),d=k.dragStartIndex;if(d!==null&&!isNaN(h)&&d!==h){const m=y.schedule.splice(d,1)[0];y.schedule.splice(h,0,m);const s=y.alerts[d],e={};Object.keys(y.alerts).forEach(n=>{const r=parseInt(n,10);if(r===d)return;let a=r;d<r&&h>=r?a--:d>r&&h<=r&&a++,e[a]=y.alerts[n]}),s&&(e[h]=s),y.alerts=e,y.normalizeScheduleContinuity(),k.selectedScheduleRowIndex=h,U.renderTable(),y.save(),G.update()}k.dragStartIndex=null},handleDragEnd:function(i){this.classList.remove("dragging"),document.querySelectorAll("#schedule-table tbody tr.drag-over").forEach(h=>{h.classList.remove("drag-over")}),k.dragStartIndex=null},handleTableDragLeave:function(i){B.scheduleTableBody&&!B.scheduleTableBody.contains(i.relatedTarget)&&document.querySelectorAll("#schedule-table tbody tr.drag-over").forEach(h=>{h.classList.remove("drag-over")})}},Q={attachListeners:function(){B.alertModal?.addEventListener("click",i=>{(i.target===B.alertModal||B.closeModalBtn&&i.target===B.closeModalBtn)&&Q.closeModal()})},openModal:function(i){if(i===null||i<0||!y.schedule||i>=y.schedule.length)return;const h=y.schedule[i]?.label||`Row ${i+1}`;B.alertModalTitle&&(B.alertModalTitle.textContent=`Visual Alert Settings for "${h}"`),Q.renderModalForm(i),B.alertModal&&(B.alertModal.style.display="block")},closeModal:function(){B.alertModal&&(B.alertModal.style.display="none"),B.alertModalBody&&(B.alertModalBody.innerHTML="")},renderModalForm:function(i){if(!B.alertModalBody||!y.schedule||i>=y.schedule.length)return;const h=y.defaultPreferences?.defaultAlertSettings?.colour||{},d=y.alerts[i]?.colour||{},m={...h,...d},s=m.durationMs||h.durationMs||1500,e=m.intervalMs||h.intervalMs||500,n=s/1e3,r=!!y.alerts[i]?.colour;B.alertModalBody.innerHTML=`
            <div class="alert-settings-form" data-index="${i}">
            <label><input type="checkbox" id="alert-colour-enabled" ${m.enabled?"checked":""}> Enable Visual Alert</label><hr>
            <label>Flash Background Colour: <input type="color" id="alert-bg-color" value="${m.background}"></label>
            <label>Flash Text Colour: <input type="color" id="alert-label-color" value="${m.text}"></label>
            <label>Flash Duration (s): <input type="number" id="alert-flash-duration-sec" min="0.5" max="10" step="0.1" value="${n.toFixed(1)}"></label>
            <label>Flash Interval (ms): <input type="number" id="alert-flash-interval" min="100" max="2000" step="50" value="${e}"></label>
            <div class="button-group">
                <button id="save-alert" data-option="colour">Save Visual Alert</button>
                <button id="preview-alert" data-option="colour">Preview Flash</button>
                <button id="remove-alert" data-option="colour" ${r?"":"disabled"}>${m.enabled?"Disable Alert":r?"Remove Custom Settings":"Using Defaults"}</button>
            </div>
            <div class="feedback-message" style="display: none;"></div></div>`;const a=B.alertModalBody.querySelector(".alert-settings-form");a?.querySelector("#alert-colour-enabled")?.addEventListener("change",Q.handleModalEnableToggle),a?.querySelector("#save-alert")?.addEventListener("click",Q.handleModalSave),a?.querySelector("#preview-alert")?.addEventListener("click",Q.handleModalPreview),a?.querySelector("#remove-alert")?.addEventListener("click",Q.handleModalRemove),Q.updateModalControlsState(a,m.enabled,r)},handleModalEnableToggle:function(i){const h=i.target.closest(".alert-settings-form"),d=i.target.checked,m=parseInt(h.dataset.index,10);Q.updateModalControlsState(h,d,!!y.alerts[m]?.colour)},updateModalControlsState:function(i,h,d){if(!i)return;const m=i.querySelectorAll('input[type="color"], input[type="number"]'),s=i.querySelector("#preview-alert"),e=i.querySelector("#remove-alert");m.forEach(n=>n.disabled=!h),s&&(s.disabled=!h),e&&(e.disabled=!d,e.textContent=h?"Disable Alert":d?"Remove Custom Settings":"Using Defaults")},handleModalSave:function(){const i=this.closest(".alert-settings-form");if(!i)return;const h=parseInt(i.dataset.index,10);if(isNaN(h))return;const d=i.querySelector("#alert-colour-enabled"),m=i.querySelector("#alert-flash-duration-sec"),s=i.querySelector("#alert-flash-interval"),e=i.querySelector("#alert-bg-color"),n=i.querySelector("#alert-label-color");if(i.querySelector(".feedback-message"),!d||!m||!s||!e||!n){console.error("Modal form elements not found for saving.");return}y.alerts[h]||(y.alerts[h]={});const r=y.defaultPreferences?.defaultAlertSettings?.colour||{},a=r.durationMs||1500,u=r.intervalMs||500;let f=parseFloat(m.value);f=isNaN(f)?a/1e3:Math.max(.5,Math.min(10,f));let g=parseInt(s.value,10);g=isNaN(g)?u:Math.max(100,Math.min(2e3,g));let l={enabled:d.checked,background:e.value||r.background||"#ff0000",text:n.value||r.text||"#ffffff",durationMs:Math.round(f*1e3),intervalMs:g};y.alerts[h].colour=l,y.save(),U.renderTable(),X.showButtonFeedback(this,"Saved!"),setTimeout(Q.closeModal,1600)},handleModalPreview:function(){const i=this.closest(".alert-settings-form");if(!i)return;const h=i.querySelector("#alert-colour-enabled"),d=i.querySelector(".feedback-message");if(!h||!h.checked){X.showFeedback(d,"Enable the alert first to preview.",!1);return}const m=parseFloat(i.querySelector("#alert-flash-duration-sec")?.value),s=parseInt(i.querySelector("#alert-flash-interval")?.value,10);if(isNaN(m)||isNaN(s)){X.showFeedback(d,"Invalid duration or interval value.",!1);return}let e={enabled:!0,background:i.querySelector("#alert-bg-color")?.value||"#ff0000",text:i.querySelector("#alert-label-color")?.value||"#ffffff",durationMs:Math.round(m*1e3),intervalMs:s};Q.triggerVisualAlert(e),X.showFeedback(d,"Previewing flash...",!0)},handleModalRemove:function(){const i=this.closest(".alert-settings-form");if(!i)return;const h=parseInt(i.dataset.index,10),d=i.querySelector("#alert-colour-enabled"),m=i.querySelector(".feedback-message");isNaN(h)||h>=y.schedule.length||(y.alerts[h]?.colour?d.checked?(d.checked=!1,Q.updateModalControlsState(i,!1,!0),X.showFeedback(m,"Alert disabled. Click Save to confirm.",!0)):confirm(`Remove custom visual alert settings for "${y.schedule[h].label}"? It will revert to defaults.`)&&(delete y.alerts[h].colour,Object.keys(y.alerts[h]).length===0&&delete y.alerts[h],y.save(),U.renderTable(),Q.closeModal()):(X.showFeedback(m,"No custom settings to remove. Using defaults.",!0),this&&(this.disabled=!0,this.textContent="Using Defaults")))},triggerVisualAlert:function(i){Q.clearVisualAlert();const{background:h,text:d,durationMs:m,intervalMs:s}=i,e=y.getActiveColourScheme();k.originalBodyStyles={background:document.body.style.backgroundColor,color:document.body.style.color,timeColor:B.timeEl?.style.color||"",dateColor:B.dateEl?.style.color||"",labelColor:B.periodLabelEl?.style.color||"",progressColor:B.progressEl?.style.backgroundColor||"",timeLeftColor:B.timeLeftEl?.style.color||""};let n=!1;const r=()=>{n=!n;const a=n?h:e.background,u=n?d:e.text;document.body.style.backgroundColor=a,document.body.style.color=u,B.timeEl&&y.preferences.showTime&&(B.timeEl.style.color=u),B.dateEl&&y.preferences.showDate&&(B.dateEl.style.color=u),B.periodLabelEl&&y.preferences.showScheduleLabel&&(B.periodLabelEl.style.color=u),B.progressEl&&y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill&&(B.progressEl.style.backgroundColor=u),B.timeLeftEl&&y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill&&(B.timeLeftEl.style.color=u),B.scheduleCirclesDisplayEl&&y.preferences.showScheduleCircles&&B.scheduleCirclesDisplayEl.querySelectorAll(".schedule-circle-symbol.active").forEach(f=>f.style.color=u)};r(),k.activeVisualAlertInterval=setInterval(r,s),k.activeVisualAlertTimeout=setTimeout(()=>{Q.clearVisualAlert(),Q.restoreOriginalStyles(e)},m)},clearVisualAlert:function(){clearTimeout(k.activeVisualAlertTimeout),clearInterval(k.activeVisualAlertInterval),k.activeVisualAlertInterval=null,k.activeVisualAlertTimeout=null},restoreOriginalStyles:function(i=null){const h=i||y.getActiveColourScheme();document.body.style.backgroundColor=h.background,document.body.style.color=h.text,B.timeEl&&y.preferences.showTime&&(B.timeEl.style.color=h.text),B.dateEl&&y.preferences.showDate&&(B.dateEl.style.color=h.text),B.periodLabelEl&&y.preferences.showScheduleLabel&&(B.periodLabelEl.style.color=h.text),B.progressEl&&y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill&&(B.progressEl.style.backgroundColor=h.text),B.timeLeftEl&&y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill&&(B.timeLeftEl.style.color=h.text),y.preferences.showScheduleCircles&&W.renderScheduleCircles()}},G={updateIntervalId:null,start:function(){G.updateIntervalId&&clearInterval(G.updateIntervalId),G.updateIntervalId=setInterval(G.update,1e3),G.update(),console.log("Clock started.")},stop:function(){G.updateIntervalId&&(clearInterval(G.updateIntervalId),G.updateIntervalId=null,console.log("Clock stopped."))},getCurrentPeriodInfo:function(i){if(!y.schedule||y.schedule.length===0)return null;for(let h=0;h<y.schedule.length;h++){const d=y.schedule[h];if(!(!d||typeof d.start!="string"||typeof d.end!="string"))try{const m=X.getTodayTime(d.start),s=X.getTodayTime(d.end);let e=new Date(s.getTime()),n=!1;s.getTime()<=m.getTime()&&(n=!0,s.getHours()===0&&s.getMinutes()===0&&s.getSeconds()===0?(e=X.getTodayTime(d.start),e.setDate(e.getDate()+1),e.setHours(0,0,0,0)):e.setDate(e.getDate()+1));let r=!1;if(n){const a=new Date(m);a.setHours(24,0,0,0);const u=new Date(m);u.setDate(u.getDate()+1),u.setHours(0,0,0,0),(i>=m&&i<a||i>=u&&i<e)&&(r=!0)}else i>=m&&i<e&&(r=!0);if(!r&&(d.end==="23:59"||d.end==="23:59:59")){const a=new Date(m);a.setHours(23,59,59,999),i>=m&&i<=a&&(r=!0,e=a)}if(r)return{label:d.label,start:m,end:e,index:h}}catch(m){console.error("Error processing period:",d?.label,d?.start,d?.end,m)}}return null},update:function(){if(!y||!ce||!Q||!W||!k||!B){console.error("Core modules not available in Clock.update");return}const i=le(),h=y.getActiveColourScheme();ce.update(),k.activeVisualAlertInterval||Q.restoreOriginalStyles(h),y.preferences.showTime&&B.timeEl&&(B.timeEl.textContent=X.formatTime(i)),y.preferences.showDate&&B.dateEl&&(B.dateEl.textContent=X.formatDate(i)),W.update(i);const d=G.getCurrentPeriodInfo(i),m=d?d.index:null;m!==k.currentPeriodIndex&&(k.currentPeriodLabel=d?d.label:null,k.currentPeriodIndex=m,d&&y.alerts[d.index]?.colour?.enabled?Q.triggerVisualAlert(y.alerts[d.index].colour):k.activeVisualAlertInterval&&(Q.clearVisualAlert(),Q.restoreOriginalStyles()),W.handlePeriodChange(d)),G.updatePeriodDisplay(i,d)},updatePeriodDisplay:function(i,h){if(B.periodLabelEl)if(h)if(y.preferences.showScheduleLabel?B.periodLabelEl.textContent=h.label:B.periodLabelEl.textContent="",y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill){if(B.progressEl&&B.progressBarEl&&B.timeLeftEl){const d=h.start.getTime(),m=h.end.getTime(),s=i.getTime(),e=m-d,n=Math.max(0,s-d);if(e>0){const r=Math.min(100,Math.max(0,n/e*100));B.progressEl.style.width=r+"%";const a=B.progressBarEl.offsetWidth,u=B.timeLeftEl.offsetWidth>0?B.timeLeftEl.offsetWidth:60;let f=r/100*a-u/2;f=Math.max(0,Math.min(a-u,f)),B.timeLeftEl.style.left=f+"px";const g=Math.max(0,m-s),l=Math.floor(g/1e3),t=Math.floor(l/60),o=l%60;B.timeLeftEl.textContent=`${t}:${o<10?"0"+o:o}`}else{B.progressEl.style.width=s>=d?"100%":"0%",B.timeLeftEl.textContent="0:00";const r=B.progressBarEl.offsetWidth,a=B.timeLeftEl.offsetWidth>0?B.timeLeftEl.offsetWidth:60;B.timeLeftEl.style.left=`${r-a}px`}}}else B.progressEl&&(B.progressEl.style.width="0%"),B.timeLeftEl&&(B.timeLeftEl.textContent="");else B.periodLabelEl&&(B.periodLabelEl.textContent=""),B.progressEl&&y.preferences.showProgressBar&&(B.progressEl.style.width="0%"),B.timeLeftEl&&y.preferences.showProgressBar&&(B.timeLeftEl.textContent="")}},ft=new Set(["Atkinson Hyperlegible Next","Arial","Helvetica","Times New Roman","Courier New","Verdana","Tahoma","Trebuchet MS","Georgia","Palatino","Garamond","Comic Sans MS","Impact","Lucida Console","Digital-7","OCR A Std","Monaco"]),y={schedule:[{label:"Before",start:"00:00",end:"08:50",colourSchemeId:1,showCircles:!1},{label:"Period 1",start:"08:50",end:"10:05",colourSchemeId:1,showCircles:!0},{label:"Break",start:"10:05",end:"10:15",colourSchemeId:2,showCircles:!1},{label:"Period 2",start:"10:15",end:"11:30",colourSchemeId:1,showCircles:!0},{label:"Lunch",start:"11:30",end:"12:20",colourSchemeId:2,showCircles:!1},{label:"Period 3",start:"12:20",end:"13:35",colourSchemeId:1,showCircles:!0},{label:"Break",start:"13:35",end:"13:45",colourSchemeId:2,showCircles:!1},{label:"Period 4",start:"13:45",end:"15:00",colourSchemeId:1,showCircles:!0},{label:"After",start:"15:00",end:"23:59",colourSchemeId:1,showCircles:!1}],preferences:{},alerts:{},defaultPreferences:{fontFamily:"Atkinson Hyperlegible Next",dateFontSize:64,timeFontSize:200,scheduleLabelFontSize:48,timeLeftFontSize:40,progressBarHeight:120,timeOffsetMs:0,showDate:!0,showTime:!0,showScheduleLabel:!0,showProgressBar:!0,showScheduleCircles:!1,showSandBars:!1,showWaterFill:!1,sandWidth:80,sandHeight:150,sandParticleSize:5,colourSchemes:[{id:1,name:"Default Dark",background:"#000000",text:"#FFFFFF"},{id:2,name:"Default Light",background:"#F0F0F0",text:"#000000"}],defaultAlertSettings:{colour:{enabled:!1,background:"#ff0000",text:"#ffffff",durationMs:1500,intervalMs:500}}},normalizeScheduleContinuity:function(){if(!Array.isArray(y.schedule)||y.schedule.length===0)return;for(let d=0;d<y.schedule.length-1;d++){const m=y.schedule[d],s=y.schedule[d+1];!m||!s||(typeof s.start=="string"&&s.start.length>0?m.end=s.start:(typeof m.end!="string"||m.end.length===0)&&(m.end="00:00"))}const i=y.schedule.length-1,h=y.schedule[i];h&&(typeof h.end!="string"||h.end.length===0)&&(h.end="23:59")},load:function(){y.preferences=JSON.parse(JSON.stringify(y.defaultPreferences));const i=JSON.parse(JSON.stringify(y.schedule));y.alerts={};const h=localStorage.getItem("clockSchedule");let d=!1;if(h)try{const e=JSON.parse(h);Array.isArray(e)&&e.length>0&&(y.schedule=e.map(n=>({label:n.label||"Unnamed",start:n.start||"00:00",end:n.end||"00:00",colourSchemeId:n.colourSchemeId||1,showCircles:typeof n.showCircles=="boolean"?n.showCircles:!1})),d=!0)}catch(e){console.error("Error parsing saved schedule.",e)}d||(y.schedule=i),y.normalizeScheduleContinuity();const m=localStorage.getItem("clockPreferences");if(m)try{const e=JSON.parse(m);if(typeof e=="object"&&e!==null){const n={...JSON.parse(JSON.stringify(y.defaultPreferences)),...e,defaultAlertSettings:{colour:{...y.defaultPreferences.defaultAlertSettings.colour,...e.defaultAlertSettings?.colour||{}}},colourSchemes:e.colourSchemes&&Array.isArray(e.colourSchemes)&&e.colourSchemes.length>0?e.colourSchemes.map(r=>({id:r.id||Date.now()+Math.random(),name:r.name||"Unnamed Scheme",background:r.background||"#000000",text:r.text||"#FFFFFF"})):y.defaultPreferences.colourSchemes};for(const r of["showDate","showTime","showScheduleLabel","showProgressBar","showScheduleCircles","showSandBars","showWaterFill"])typeof n[r]!="boolean"&&(n[r]=y.defaultPreferences[r]);for(const r of["dateFontSize","timeFontSize","scheduleLabelFontSize","timeLeftFontSize","progressBarHeight","sandWidth","sandHeight","sandParticleSize"])n[r]=Number(n[r])||y.defaultPreferences[r];n.timeOffsetMs=Number(n.timeOffsetMs)||0,n.fontFamily==="Atkinson Hyperlegible"&&(n.fontFamily="Atkinson Hyperlegible Next"),ft.has(n.fontFamily)||(n.fontFamily=y.defaultPreferences.fontFamily),n.showSandBars&&n.showWaterFill&&(n.showWaterFill=!1),n.showProgressBar&&(n.showSandBars||n.showWaterFill)&&(n.showProgressBar=!1),n.sandWidth=Math.max(10,Math.min(100,n.sandWidth)),n.sandHeight=Math.max(50,Math.min(800,n.sandHeight)),n.sandParticleSize=Math.max(1,Math.min(20,n.sandParticleSize)),y.preferences=n}}catch(e){console.error("Error parsing saved preferences.",e)}const s=localStorage.getItem("clockAlerts");if(s)try{const e=JSON.parse(s);typeof e=="object"&&e!==null&&(y.alerts=e,Object.keys(y.alerts).forEach(n=>{y.alerts[n]?.noise&&delete y.alerts[n].noise,y.alerts[n]&&typeof y.alerts[n]=="object"&&Object.keys(y.alerts[n]).length===0&&delete y.alerts[n]}))}catch(e){console.error("Error parsing saved alerts settings.",e)}console.log("Settings loaded")},save:function(){try{y.normalizeScheduleContinuity(),y.preferences.hasOwnProperty("sandDropInterval")&&delete y.preferences.sandDropInterval;const i={};Object.keys(y.alerts).forEach(d=>{y.alerts[d]&&typeof y.alerts[d]=="object"&&Object.keys(y.alerts[d]).length>0&&(i[d]=y.alerts[d])});const h=y.schedule.map(d=>({label:d.label,start:d.start,end:d.end,colourSchemeId:d.colourSchemeId,showCircles:d.showCircles}));localStorage.setItem("clockSchedule",JSON.stringify(h)),localStorage.setItem("clockPreferences",JSON.stringify(y.preferences)),localStorage.setItem("clockAlerts",JSON.stringify(i))}catch(i){console.error("Error saving settings:",i)}},getActiveColourScheme:function(){const i=le(),h=typeof G<"u"?G.getCurrentPeriodInfo(i):null;let d=1;if(h&&h.index!==void 0&&y.schedule[h.index]){const e=y.schedule[h.index];e.colourSchemeId&&(d=e.colourSchemeId)}const m=y.preferences?.colourSchemes||y.defaultPreferences.colourSchemes;let s=m.find(e=>e.id===d);return s||(s=m.find(e=>e.id===1)),s||(s=m[0]),s||{id:0,name:"Error",background:"#ff00ff",text:"#000000"}}},re={attachListeners:function(){B.colorSchemeContentContainer?.addEventListener("click",re.handleContentClick),B.colorSchemeContentContainer?.addEventListener("input",re.handleContentInput)},renderTabs:function(){const i=B.colorSchemeTabsContainer,h=B.colorSchemeContentContainer;if(!i||!h)return;i.innerHTML="",(y.preferences?.colourSchemes||[]).forEach((e,n)=>{const r=document.createElement("button");r.className="colour-tab",r.textContent=e.name||`Scheme ${e.id}`,r.dataset.id=e.id,r.dataset.index=n,r.addEventListener("click",function(){i.querySelectorAll(".colour-tab.active").forEach(a=>a.classList.remove("active")),this.classList.add("active"),re.renderContent(n)}),i.appendChild(r)});const m=document.createElement("button");m.className="colour-tab add-colour",m.textContent="+",m.title="Add New Colour Scheme",m.addEventListener("click",re.addScheme),i.appendChild(m);const s=i.querySelector(".colour-tab:not(.add-colour)");s?s.click():h.innerHTML="<p>No colour schemes defined. Click '+' to add one.</p>"},renderContent:function(i){const h=B.colorSchemeContentContainer,d=y.preferences?.colourSchemes||[];if(!h||i<0||i>=d.length)return;const m=d[i];if(!m)return;const s=d.length>1&&m.id!==1&&m.id!==2,e=`
            <button
                id="delete-scheme-${i}"
                data-index="${i}"
                ${s?"":'disabled title="Cannot delete default schemes or the last remaining scheme"'}>
                Delete Scheme
            </button>`;h.innerHTML=`
          <div class="colour-scheme-form">
            <label>Scheme Name: <input type="text" id="scheme-name-${i}" value="${m.name||""}"></label>
            <label>Background Colour: <input type="color" id="scheme-bg-color-${i}" value="${m.background||"#000000"}"></label>
            <label>Main Text Colour (Date, Time, Label, Progress, Active Circles): <input type="color" id="scheme-text-color-${i}" value="${m.text||"#ffffff"}"></label>
            <button id="save-scheme-settings-${i}" data-index="${i}">Save Scheme</button>
            ${s?e:""}
             <div class="feedback-message" style="display: none;"></div>
           </div>`},handleContentInput:function(i){const h=i.target,d=h.closest(".colour-scheme-form");if(!d||!h.id||!(h.id.startsWith("scheme-name")||h.id.startsWith("scheme-bg-color")||h.id.startsWith("scheme-text-color")))return;const m=d.querySelector('button[id^="save-scheme-settings"]');if(!m)return;const s=parseInt(m.dataset.index,10);if(!isNaN(s)&&s>=0&&s<y.preferences.colourSchemes.length){const e=y.preferences.colourSchemes[s];h.id.startsWith("scheme-name")&&(e.name=h.value),h.id.startsWith("scheme-bg-color")&&(e.background=h.value),h.id.startsWith("scheme-text-color")&&(e.text=h.value);const n=B.colorSchemeTabsContainer?.querySelector(`.colour-tab[data-index="${s}"]`);n&&h.id.startsWith("scheme-name")&&(n.textContent=h.value||`Scheme ${e.id}`),G.update()}},handleContentClick:function(i){const h=i.target;if(h.tagName!=="BUTTON"||!h.id||!h.closest(".colour-scheme-form"))return;const d=parseInt(h.dataset.index,10);if(h.closest(".colour-scheme-form")?.querySelector(".feedback-message"),!isNaN(d))if(h.id.startsWith("save-scheme-settings")){y.save(),X.showButtonFeedback(h,"Saved!");const m=B.colorSchemeTabsContainer?.querySelector(`.colour-tab[data-index="${d}"]`);m&&!m.classList.contains("active")&&(B.colorSchemeTabsContainer?.querySelectorAll(".colour-tab.active").forEach(s=>s.classList.remove("active")),m.classList.add("active"))}else h.id.startsWith("delete-scheme")&&re.deleteScheme(d,h)},addScheme:function(){const i=(y.preferences.colourSchemes.reduce((m,s)=>Math.max(m,s.id||0),0)||0)+1,h={id:i,name:"New Scheme "+i,background:"#222222",text:"#EEEEEE"};y.preferences.colourSchemes.push(h),y.save(),re.renderTabs(),B.colorSchemeTabsContainer?.querySelector(`.colour-tab[data-id="${i}"]`)?.click()},deleteScheme:function(i,h){const d=y.preferences.colourSchemes;if(i<0||i>=d.length)return;const m=d[i];if(d.length>1&&m.id!==1&&m.id!==2){if(confirm(`Delete scheme "${m.name||`Scheme ${i+1}`}"? Periods using it will revert to Scheme 1.`)){const e=m.id;d.splice(i,1),y.schedule.forEach(n=>{n.colourSchemeId===e&&(n.colourSchemeId=1)}),y.save(),U.renderTable(),re.renderTabs(),G.update()}}else alert("Cannot delete default schemes or the last remaining scheme.")},resetDefaults:function(){confirm("Reset ALL Colour Schemes to the defaults? This cannot be undone.")&&(y.preferences.colourSchemes=JSON.parse(JSON.stringify(y.defaultPreferences.colourSchemes)),y.schedule.forEach(i=>i.colourSchemeId=1),y.save(),U.renderTable(),re.renderTabs(),G.update(),X.showButtonFeedback(B.resetSchemesBtn,"Reset!"))}},ue={attachListeners:function(){B.fontSelect?.addEventListener("input",function(){y.preferences&&(y.preferences.fontFamily=this.value,ce.applyFontAndSizePreferences(),y.save())}),document.querySelectorAll(".number-input-wrapper").forEach(i=>{const h=i.querySelector('input[type="number"]'),d=i.querySelector(".num-btn.minus"),m=i.querySelector(".num-btn.plus");if(!h||!h.dataset||!h.dataset.pref||!d||!m)return;const s=h.dataset.pref;let e=null,n=null;const r=500,a=100;if(!y.preferences||!y.defaultPreferences||!y.preferences.hasOwnProperty(s)){console.warn(`Preference key "${s}" not found in settings for input ${h.id}`);return}const u=t=>{if(!y.preferences.hasOwnProperty(s))return;parseInt(h.step);const o=h.min?parseInt(h.min,10):-1/0,c=h.max?parseInt(h.max,10):1/0;let p=parseInt(t,10);p=isNaN(p)?y.defaultPreferences[s]:Math.max(o,Math.min(c,p)),y.preferences[s]!==p&&(y.preferences[s]=p,h.value=p,ce.applyFontAndSizePreferences(),["sandWidth","sandHeight","sandParticleSize"].includes(s)&&(console.log(`Physics fill pref changed (${s}), triggering physics setup...`),requestAnimationFrame(()=>{W.handleDisplayToggle()})),y.save())},f=t=>{u(parseInt(h.value,10)+t),g(),n=setTimeout(()=>{e=setInterval(()=>{u(parseInt(h.value,10)+t)},a)},r)},g=()=>{clearTimeout(n),clearInterval(e),n=e=null};h.addEventListener("change",()=>u(h.value)),d.addEventListener("mousedown",()=>f(-(parseInt(h.step)||1))),m.addEventListener("mousedown",()=>f(parseInt(h.step)||1)),["mouseup","mouseleave","blur","touchend","touchcancel"].forEach(t=>{d.addEventListener(t,g),m.addEventListener(t,g)})}),B.displayElementsChecklist?.querySelectorAll('input[type="checkbox"]').forEach(i=>{i.addEventListener("change",ue.handleDisplayToggleChange)}),B.resetAppearanceBtn?.addEventListener("click",ue.resetFontAndSizeDefaults),B.resetSchemesBtn?.addEventListener("click",re.resetDefaults),document.getElementById("reset-sandbar-defaults")?.addEventListener("click",ue.resetSandBarDefaults)},handleDisplayToggleChange:function(){const i=this.dataset.pref;if(!i||!y.preferences||!y.preferences.hasOwnProperty(i))return;y.preferences[i]=this.checked;const h=B.displayElementsChecklist?.querySelector("#pref-show-progress-bar"),d=B.displayElementsChecklist?.querySelector("#pref-show-sand-bars"),m=B.displayElementsChecklist?.querySelector("#pref-show-water-fill"),s=()=>{y.preferences.showProgressBar&&(y.preferences.showProgressBar=!1,h&&(h.checked=!1))},e=()=>{y.preferences.showSandBars&&(y.preferences.showSandBars=!1,d&&(d.checked=!1))},n=()=>{y.preferences.showWaterFill&&(y.preferences.showWaterFill=!1,m&&(m.checked=!1))};i==="showSandBars"&&this.checked?(s(),n()):i==="showWaterFill"&&this.checked?(s(),e()):i==="showProgressBar"&&this.checked&&(e(),n()),document.getElementById("sand-bar-options")?.classList.toggle("element-hidden",!(y.preferences.showSandBars||y.preferences.showWaterFill)),ce.update(),W.handleDisplayToggle(),y.save()},updateInputs:function(){if(!y.preferences)return;B.fontSelect&&(B.fontSelect.value=y.preferences.fontFamily),B.dateFontSizeInput&&(B.dateFontSizeInput.value=y.preferences.dateFontSize),B.timeFontSizeInput&&(B.timeFontSizeInput.value=y.preferences.timeFontSize),B.labelFontSizeInput&&(B.labelFontSizeInput.value=y.preferences.scheduleLabelFontSize),B.timeLeftFontSizeInput&&(B.timeLeftFontSizeInput.value=y.preferences.timeLeftFontSize),B.progressHeightInput&&(B.progressHeightInput.value=y.preferences.progressBarHeight),B.displayElementsChecklist?.querySelectorAll('input[type="checkbox"]').forEach(h=>{const d=h.dataset.pref;d&&y.preferences.hasOwnProperty(d)&&(h.checked=y.preferences[d])});const i=document.getElementById("sand-bar-options");if(i){i.classList.toggle("element-hidden",!(y.preferences.showSandBars||y.preferences.showWaterFill));const h=i.querySelector("#pref-sand-width"),d=i.querySelector("#pref-sand-height"),m=i.querySelector("#pref-sand-particle-size");h&&(h.value=y.preferences.sandWidth),d&&(d.value=y.preferences.sandHeight),m&&(m.value=y.preferences.sandParticleSize)}},resetFontAndSizeDefaults:function(){if(confirm("Reset Font & Size settings to defaults?")){if(!y.preferences||!y.defaultPreferences)return;y.preferences.fontFamily=y.defaultPreferences.fontFamily,y.preferences.dateFontSize=y.defaultPreferences.dateFontSize,y.preferences.timeFontSize=y.defaultPreferences.timeFontSize,y.preferences.scheduleLabelFontSize=y.defaultPreferences.scheduleLabelFontSize,y.preferences.timeLeftFontSize=y.defaultPreferences.timeLeftFontSize,y.preferences.progressBarHeight=y.defaultPreferences.progressBarHeight,ue.updateInputs(),ce.applyFontAndSizePreferences(),y.save(),X.showButtonFeedback(B.resetAppearanceBtn,"Reset!")}},resetSandBarDefaults:function(){if(confirm("Reset Physics Fill settings to defaults?")){if(!y.preferences||!y.defaultPreferences)return;y.preferences.sandWidth=y.defaultPreferences.sandWidth,y.preferences.sandHeight=y.defaultPreferences.sandHeight,y.preferences.sandParticleSize=y.defaultPreferences.sandParticleSize,ue.updateInputs(),(y.preferences.showSandBars||y.preferences.showWaterFill)&&requestAnimationFrame(()=>{W.handleDisplayToggle()}),y.save(),X.showButtonFeedback(document.getElementById("reset-sandbar-defaults"),"Reset!")}}},te={attachListeners:function(){B.syncToBellBtn?.addEventListener("click",te.syncToNearestBell),B.resetOffsetBtn?.addEventListener("click",te.resetOffset),te.addManualOffsetListener(B.offsetMinDownBtn,-6e4),te.addManualOffsetListener(B.offsetMinUpBtn,6e4),te.addManualOffsetListener(B.offsetSecDownBtn,-1e3),te.addManualOffsetListener(B.offsetSecUpBtn,1e3)},addManualOffsetListener:function(i,h){i&&i.addEventListener("click",()=>te.adjustOffset(h))},adjustOffset:function(i){typeof y.preferences.timeOffsetMs!="number"&&(y.preferences.timeOffsetMs=0),y.preferences.timeOffsetMs+=i,te.updateOffsetDisplay(),G.update(),y.save()},resetOffset:function(){y.preferences.timeOffsetMs!==0?(y.preferences.timeOffsetMs=0,te.updateOffsetDisplay(),G.update(),y.save(),X.showButtonFeedback(B.resetOffsetBtn,"Offset Reset!",1500)):X.showButtonFeedback(B.resetOffsetBtn,"Already Zero!",1e3)},syncToNearestBell:function(){if(!y.schedule||y.schedule.length===0){X.showButtonFeedback(B.syncToBellBtn,"Add Schedule First!",2e3);return}const h=new Date().getTime();let d=1/0,m=null;if(y.schedule.forEach(s=>{if(!(!s||!s.start||!s.end||!/^\d{2}:\d{2}$/.test(s.start)||!/^\d{2}:\d{2}$/.test(s.end)))try{const e=X.getTodayTime(s.start),n=X.getTodayTime(s.end),r=e.getTime(),a=n.getTime();let u=Math.abs(r-h);if(u<d&&(d=u,m=e),!y.schedule.some(g=>g.start===s.end)){let g=Math.abs(a-h);g<d&&(d=g,m=n)}}catch(e){console.error("Sync error parsing time for period:",s.label,e)}}),m!==null){const s=m.getTime()-h;y.preferences.timeOffsetMs=s,te.updateOffsetDisplay(),G.update(),y.save(),X.showButtonFeedback(B.syncToBellBtn,"Synced!")}else X.showButtonFeedback(B.syncToBellBtn,"No Valid Times!",2e3)},updateOffsetDisplay:function(){const i=Number(y.preferences?.timeOffsetMs)||0,h=Math.round(i/1e3),d=h>=0?"+":"-",m=Math.abs(h),s=Math.floor(m/60),e=m%60,n=e<10?"0"+e:e,r=`${d}${s}m ${n}s`;B.currentOffsetDisplay&&(B.currentOffsetDisplay.textContent=r)}},fe={init:function(){console.log("Classroom Clock Initializing..."),Je(),y.load(),ue.updateInputs(),re.renderTabs(),U.renderTable(),te.updateOffsetDisplay(),ue.attachListeners(),re.attachListeners(),U.attachListeners(),Q.attachListeners(),te.attachListeners(),fe.attachGlobalListeners(),ce.update(),W.handleDisplayToggle(),G.start(),console.log("Classroom Clock Initialized.")},attachGlobalListeners:function(){B.menuToggle?.addEventListener("click",()=>{const i=B.settingsMenu?.classList.toggle("open");B.menuToggle&&(B.menuToggle.innerHTML=i?"â–²":"â–¼")}),B.menuResizer?.addEventListener("mousedown",fe.handleResizeMouseDown),document.addEventListener("mousemove",fe.handleResizeMouseMove),document.addEventListener("mouseup",fe.handleResizeMouseUp),document.addEventListener("mouseleave",fe.handleResizeMouseUp),B.tabsContainer?.querySelectorAll(".tab-button").forEach(i=>{i.addEventListener("click",fe.handleTabClick)})},handleTabClick:function(){if(!B.tabsContainer||!B.tabContentsContainer)return;B.tabsContainer.querySelectorAll(".tab-button.active").forEach(h=>h.classList.remove("active")),B.tabContentsContainer.querySelectorAll(".tab-content.active").forEach(h=>h.classList.remove("active")),this.classList.add("active");const i=this.getAttribute("data-tab");if(i){const h=B.tabContentsContainer.querySelector(`#${i}`);h&&h.classList.add("active")}},handleResizeMouseDown:function(i){k.isResizingMenu=!0,document.body.style.cursor="ew-resize",document.body.style.userSelect="none",document.body.style.setProperty("-webkit-user-select","none")},handleResizeMouseMove:function(i){if(!k.isResizingMenu||!B.settingsMenu)return;const h=window.innerWidth-i.clientX,d=400,m=Math.min(950,window.innerWidth-50);h>=d&&h<=m&&(B.settingsMenu.style.width=h+"px")},handleResizeMouseUp:function(i){k.isResizingMenu&&(k.isResizingMenu=!1,document.body.style.cursor="default",document.body.style.userSelect="",document.body.style.removeProperty("-webkit-user-select"))}};document.addEventListener("DOMContentLoaded",fe.init);
