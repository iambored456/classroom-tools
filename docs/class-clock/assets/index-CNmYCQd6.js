(function(){const h=document.createElement("link").relList;if(h&&h.supports&&h.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))p(s);new MutationObserver(s=>{for(const e of s)if(e.type==="childList")for(const n of e.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&p(n)}).observe(document,{childList:!0,subtree:!0});function d(s){const e={};return s.integrity&&(e.integrity=s.integrity),s.referrerPolicy&&(e.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?e.credentials="include":s.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function p(s){if(s.ep)return;s.ep=!0;const e=d(s);fetch(s.href,e)}})();function qe(){return{clockDisplayArea:document.getElementById("clock-display-area"),timeEl:document.getElementById("time"),dateEl:document.getElementById("date"),scheduleCirclesDisplayEl:document.getElementById("schedule-circles-display"),periodContainerEl:document.getElementById("period-container"),periodLabelEl:document.getElementById("period-label"),progressBarEl:document.getElementById("progress-bar"),progressEl:document.getElementById("progress"),timeLeftEl:document.getElementById("time-left"),sandBarsContainerEl:document.getElementById("sand-bars-container"),sandBarsCanvas:document.getElementById("sand-bars-canvas"),waterFillContainerEl:document.getElementById("water-fill-container"),waterFillCanvas:document.getElementById("water-fill-canvas"),alertModal:document.getElementById("alert-modal"),alertModalTitle:document.getElementById("modal-title"),alertModalBody:document.getElementById("modal-body"),closeModalBtn:document.querySelector("#alert-modal .close-modal-btn"),menuToggle:document.getElementById("menu-toggle"),settingsMenu:document.getElementById("settings-menu"),menuResizer:document.getElementById("menu-resizer"),settingsNav:document.getElementById("settings-nav"),tabsContainer:document.getElementById("tabs"),tabContentsContainer:document.getElementById("tab-contents"),appearanceTab:document.getElementById("appearance-tab"),scheduleAlertsTab:document.getElementById("schedule-alerts-tab"),displayElementsChecklist:document.getElementById("display-elements-checklist"),fontSelect:document.getElementById("pref-font"),dateFontSizeInput:document.getElementById("pref-date-font"),timeFontSizeInput:document.getElementById("pref-time-font"),labelFontSizeInput:document.getElementById("pref-schedule-label-font"),timeLeftFontSizeInput:document.getElementById("pref-time-left-font"),progressHeightInput:document.getElementById("pref-progress-height"),resetAppearanceBtn:document.getElementById("reset-appearance-defaults"),resetSchemesBtn:document.getElementById("reset-schemes-defaults"),colorSchemeTabsContainer:document.getElementById("colour-scheme-tabs"),colorSchemeContentContainer:document.getElementById("colour-scheme-content"),scheduleTableBody:document.querySelector("#schedule-table tbody"),addScheduleRowBtn:document.getElementById("add-schedule-row"),deleteScheduleRowBtn:document.getElementById("delete-schedule-row"),timeSyncSection:document.getElementById("time-sync-section"),syncToBellBtn:document.getElementById("sync-to-bell"),offsetMinDownBtn:document.getElementById("offset-min-down"),offsetMinUpBtn:document.getElementById("offset-min-up"),offsetSecDownBtn:document.getElementById("offset-sec-down"),offsetSecUpBtn:document.getElementById("offset-sec-up"),resetOffsetBtn:document.getElementById("reset-offset"),currentOffsetDisplay:document.getElementById("current-offset")}}let B={};function Je(){B=qe(),console.log("DOM Cache Updated",B)}const X={getTodayTime:function(i){if(!i||!/^\d{2}:\d{2}$/.test(i)){const s=new Date;return s.setSeconds(0,0),s}const[h,d]=i.split(":").map(Number),p=new Date;return p.setHours(h,d,0,0),p},formatTime:function(i){let h=i.getHours();const d=i.getMinutes(),p=h>=12?"PM":"AM";return h=h%12||12,`${h}:${d<10?"0"+d:d} ${p}`},formatDate:function(i){const h={weekday:"long",month:"long",day:"numeric"};return i.toLocaleDateString(void 0,h)},showFeedback:function(i,h,d=!0){i&&(i.textContent=h,i.classList.remove("success","error"),i.classList.add(d?"success":"error"),i.style.display="block",setTimeout(()=>{i&&(i.style.display="none")},3e3))},showButtonFeedback:function(i,h="Saved!",d=1500){if(!i)return;const p=i.textContent;i.textContent=h,i.classList.add("button-success"),i.disabled=!0,setTimeout(()=>{i&&(i.textContent=p,i.classList.remove("button-success"),i.disabled=!1)},d)},lightenColor:function(i,h){if(!i||(i=i.replace(/^#/,""),i.length!==6))return"#cccccc";try{let d=parseInt(i.substring(0,2),16),p=parseInt(i.substring(2,4),16),s=parseInt(i.substring(4,6),16);d=Math.min(255,Math.floor(d*(1+h/100))),p=Math.min(255,Math.floor(p*(1+h/100))),s=Math.min(255,Math.floor(s*(1+h/100)));const e=d.toString(16).padStart(2,"0"),n=p.toString(16).padStart(2,"0"),r=s.toString(16).padStart(2,"0");return`#${e}${n}${r}`}catch(d){return console.error("Error lightening color:",i,d),"#cccccc"}}};function le(){const i=y.preferences&&y.preferences.timeOffsetMs?Number(y.preferences.timeOffsetMs):0,h=new Date;return new Date(h.getTime()+i)}const k={currentPeriodLabel:null,currentPeriodIndex:null,activeVisualAlertInterval:null,activeVisualAlertTimeout:null,originalBodyStyles:{},selectedScheduleRowIndex:null,isResizingMenu:!1,dragStartIndex:null,SAND_COLORS:["#fba1bd","#dfb37a","#8aca91","#54cce2","#b6b6fd"],physicsCheckIntervalId:null,physicsCheckIntervalMs:100,physicsParticlesAdded:0,visualMaxParticlesPerSegment:0,totalParticlesForPeriod:0};var Fe=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Xe(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var Se={exports:{}};var Qe=Se.exports,De;function Ye(){return De||(De=1,(function(i,h){(function(p,s){i.exports=s()})(Qe,function(){return(function(d){var p={};function s(e){if(p[e])return p[e].exports;var n=p[e]={i:e,l:!1,exports:{}};return d[e].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=d,s.c=p,s.d=function(e,n,r){s.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},s.r=function(e){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,n){if(n&1&&(e=s(e)),n&8||n&4&&typeof e=="object"&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),n&2&&typeof e!="string")for(var a in e)s.d(r,a,(function(u){return e[u]}).bind(null,a));return r},s.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(n,"a",n),n},s.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},s.p="",s(s.s=20)})([(function(d,p){var s={};d.exports=s,(function(){s._baseDelta=1e3/60,s._nextId=0,s._seed=0,s._nowStartTime=+new Date,s._warnedOnce={},s._decomp=null,s.extend=function(n,r){var a,u;typeof r=="boolean"?(a=2,u=r):(a=1,u=!0);for(var c=a;c<arguments.length;c++){var m=arguments[c];if(m)for(var l in m)u&&m[l]&&m[l].constructor===Object&&(!n[l]||n[l].constructor===Object)?(n[l]=n[l]||{},s.extend(n[l],u,m[l])):n[l]=m[l]}return n},s.clone=function(n,r){return s.extend({},r,n)},s.keys=function(n){if(Object.keys)return Object.keys(n);var r=[];for(var a in n)r.push(a);return r},s.values=function(n){var r=[];if(Object.keys){for(var a=Object.keys(n),u=0;u<a.length;u++)r.push(n[a[u]]);return r}for(var c in n)r.push(n[c]);return r},s.get=function(n,r,a,u){r=r.split(".").slice(a,u);for(var c=0;c<r.length;c+=1)n=n[r[c]];return n},s.set=function(n,r,a,u,c){var m=r.split(".").slice(u,c);return s.get(n,r,0,-1)[m[m.length-1]]=a,a},s.shuffle=function(n){for(var r=n.length-1;r>0;r--){var a=Math.floor(s.random()*(r+1)),u=n[r];n[r]=n[a],n[a]=u}return n},s.choose=function(n){return n[Math.floor(s.random()*n.length)]},s.isElement=function(n){return typeof HTMLElement<"u"?n instanceof HTMLElement:!!(n&&n.nodeType&&n.nodeName)},s.isArray=function(n){return Object.prototype.toString.call(n)==="[object Array]"},s.isFunction=function(n){return typeof n=="function"},s.isPlainObject=function(n){return typeof n=="object"&&n.constructor===Object},s.isString=function(n){return toString.call(n)==="[object String]"},s.clamp=function(n,r,a){return n<r?r:n>a?a:n},s.sign=function(n){return n<0?-1:1},s.now=function(){if(typeof window<"u"&&window.performance){if(window.performance.now)return window.performance.now();if(window.performance.webkitNow)return window.performance.webkitNow()}return Date.now?Date.now():new Date-s._nowStartTime},s.random=function(n,r){return n=typeof n<"u"?n:0,r=typeof r<"u"?r:1,n+e()*(r-n)};var e=function(){return s._seed=(s._seed*9301+49297)%233280,s._seed/233280};s.colorToNumber=function(n){return n=n.replace("#",""),n.length==3&&(n=n.charAt(0)+n.charAt(0)+n.charAt(1)+n.charAt(1)+n.charAt(2)+n.charAt(2)),parseInt(n,16)},s.logLevel=1,s.log=function(){console&&s.logLevel>0&&s.logLevel<=3&&console.log.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},s.info=function(){console&&s.logLevel>0&&s.logLevel<=2&&console.info.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},s.warn=function(){console&&s.logLevel>0&&s.logLevel<=3&&console.warn.apply(console,["matter-js:"].concat(Array.prototype.slice.call(arguments)))},s.warnOnce=function(){var n=Array.prototype.slice.call(arguments).join(" ");s._warnedOnce[n]||(s.warn(n),s._warnedOnce[n]=!0)},s.deprecated=function(n,r,a){n[r]=s.chain(function(){s.warnOnce("ðŸ”… deprecated ðŸ”…",a)},n[r])},s.nextId=function(){return s._nextId++},s.indexOf=function(n,r){if(n.indexOf)return n.indexOf(r);for(var a=0;a<n.length;a++)if(n[a]===r)return a;return-1},s.map=function(n,r){if(n.map)return n.map(r);for(var a=[],u=0;u<n.length;u+=1)a.push(r(n[u]));return a},s.topologicalSort=function(n){var r=[],a=[],u=[];for(var c in n)!a[c]&&!u[c]&&s._topologicalSort(c,a,u,n,r);return r},s._topologicalSort=function(n,r,a,u,c){var m=u[n]||[];a[n]=!0;for(var l=0;l<m.length;l+=1){var t=m[l];a[t]||r[t]||s._topologicalSort(t,r,a,u,c)}a[n]=!1,r[n]=!0,c.push(n)},s.chain=function(){for(var n=[],r=0;r<arguments.length;r+=1){var a=arguments[r];a._chained?n.push.apply(n,a._chained):n.push(a)}var u=function(){for(var c,m=new Array(arguments.length),l=0,t=arguments.length;l<t;l++)m[l]=arguments[l];for(l=0;l<n.length;l+=1){var o=n[l].apply(c,m);typeof o<"u"&&(c=o)}return c};return u._chained=n,u},s.chainPathBefore=function(n,r,a){return s.set(n,r,s.chain(a,s.get(n,r)))},s.chainPathAfter=function(n,r,a){return s.set(n,r,s.chain(s.get(n,r),a))},s.setDecomp=function(n){s._decomp=n},s.getDecomp=function(){var n=s._decomp;try{!n&&typeof window<"u"&&(n=window.decomp),!n&&typeof Fe<"u"&&(n=Fe.decomp)}catch{n=null}return n}})()}),(function(d,p){var s={};d.exports=s,(function(){s.create=function(e){var n={min:{x:0,y:0},max:{x:0,y:0}};return e&&s.update(n,e),n},s.update=function(e,n,r){e.min.x=1/0,e.max.x=-1/0,e.min.y=1/0,e.max.y=-1/0;for(var a=0;a<n.length;a++){var u=n[a];u.x>e.max.x&&(e.max.x=u.x),u.x<e.min.x&&(e.min.x=u.x),u.y>e.max.y&&(e.max.y=u.y),u.y<e.min.y&&(e.min.y=u.y)}r&&(r.x>0?e.max.x+=r.x:e.min.x+=r.x,r.y>0?e.max.y+=r.y:e.min.y+=r.y)},s.contains=function(e,n){return n.x>=e.min.x&&n.x<=e.max.x&&n.y>=e.min.y&&n.y<=e.max.y},s.overlaps=function(e,n){return e.min.x<=n.max.x&&e.max.x>=n.min.x&&e.max.y>=n.min.y&&e.min.y<=n.max.y},s.translate=function(e,n){e.min.x+=n.x,e.max.x+=n.x,e.min.y+=n.y,e.max.y+=n.y},s.shift=function(e,n){var r=e.max.x-e.min.x,a=e.max.y-e.min.y;e.min.x=n.x,e.max.x=n.x+r,e.min.y=n.y,e.max.y=n.y+a}})()}),(function(d,p){var s={};d.exports=s,(function(){s.create=function(e,n){return{x:e||0,y:n||0}},s.clone=function(e){return{x:e.x,y:e.y}},s.magnitude=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},s.magnitudeSquared=function(e){return e.x*e.x+e.y*e.y},s.rotate=function(e,n,r){var a=Math.cos(n),u=Math.sin(n);r||(r={});var c=e.x*a-e.y*u;return r.y=e.x*u+e.y*a,r.x=c,r},s.rotateAbout=function(e,n,r,a){var u=Math.cos(n),c=Math.sin(n);a||(a={});var m=r.x+((e.x-r.x)*u-(e.y-r.y)*c);return a.y=r.y+((e.x-r.x)*c+(e.y-r.y)*u),a.x=m,a},s.normalise=function(e){var n=s.magnitude(e);return n===0?{x:0,y:0}:{x:e.x/n,y:e.y/n}},s.dot=function(e,n){return e.x*n.x+e.y*n.y},s.cross=function(e,n){return e.x*n.y-e.y*n.x},s.cross3=function(e,n,r){return(n.x-e.x)*(r.y-e.y)-(n.y-e.y)*(r.x-e.x)},s.add=function(e,n,r){return r||(r={}),r.x=e.x+n.x,r.y=e.y+n.y,r},s.sub=function(e,n,r){return r||(r={}),r.x=e.x-n.x,r.y=e.y-n.y,r},s.mult=function(e,n){return{x:e.x*n,y:e.y*n}},s.div=function(e,n){return{x:e.x/n,y:e.y/n}},s.perp=function(e,n){return n=n===!0?-1:1,{x:n*-e.y,y:n*e.x}},s.neg=function(e){return{x:-e.x,y:-e.y}},s.angle=function(e,n){return Math.atan2(n.y-e.y,n.x-e.x)},s._temp=[s.create(),s.create(),s.create(),s.create(),s.create(),s.create()]})()}),(function(d,p,s){var e={};d.exports=e;var n=s(2),r=s(0);(function(){e.create=function(a,u){for(var c=[],m=0;m<a.length;m++){var l=a[m],t={x:l.x,y:l.y,index:m,body:u,isInternal:!1};c.push(t)}return c},e.fromPath=function(a,u){var c=/L?\s*([-\d.e]+)[\s,]*([-\d.e]+)*/ig,m=[];return a.replace(c,function(l,t,o){m.push({x:parseFloat(t),y:parseFloat(o)})}),e.create(m,u)},e.centre=function(a){for(var u=e.area(a,!0),c={x:0,y:0},m,l,t,o=0;o<a.length;o++)t=(o+1)%a.length,m=n.cross(a[o],a[t]),l=n.mult(n.add(a[o],a[t]),m),c=n.add(c,l);return n.div(c,6*u)},e.mean=function(a){for(var u={x:0,y:0},c=0;c<a.length;c++)u.x+=a[c].x,u.y+=a[c].y;return n.div(u,a.length)},e.area=function(a,u){for(var c=0,m=a.length-1,l=0;l<a.length;l++)c+=(a[m].x-a[l].x)*(a[m].y+a[l].y),m=l;return u?c/2:Math.abs(c)/2},e.inertia=function(a,u){for(var c=0,m=0,l=a,t,o,f=0;f<l.length;f++)o=(f+1)%l.length,t=Math.abs(n.cross(l[o],l[f])),c+=t*(n.dot(l[o],l[o])+n.dot(l[o],l[f])+n.dot(l[f],l[f])),m+=t;return u/6*(c/m)},e.translate=function(a,u,c){c=typeof c<"u"?c:1;var m=a.length,l=u.x*c,t=u.y*c,o;for(o=0;o<m;o++)a[o].x+=l,a[o].y+=t;return a},e.rotate=function(a,u,c){if(u!==0){var m=Math.cos(u),l=Math.sin(u),t=c.x,o=c.y,f=a.length,g,x,M,E;for(E=0;E<f;E++)g=a[E],x=g.x-t,M=g.y-o,g.x=t+(x*m-M*l),g.y=o+(x*l+M*m);return a}},e.contains=function(a,u){for(var c=u.x,m=u.y,l=a.length,t=a[l-1],o,f=0;f<l;f++){if(o=a[f],(c-t.x)*(o.y-t.y)+(m-t.y)*(t.x-o.x)>0)return!1;t=o}return!0},e.scale=function(a,u,c,m){if(u===1&&c===1)return a;m=m||e.centre(a);for(var l,t,o=0;o<a.length;o++)l=a[o],t=n.sub(l,m),a[o].x=m.x+t.x*u,a[o].y=m.y+t.y*c;return a},e.chamfer=function(a,u,c,m,l){typeof u=="number"?u=[u]:u=u||[8],c=typeof c<"u"?c:-1,m=m||2,l=l||14;for(var t=[],o=0;o<a.length;o++){var f=a[o-1>=0?o-1:a.length-1],g=a[o],x=a[(o+1)%a.length],M=u[o<u.length?o:u.length-1];if(M===0){t.push(g);continue}var E=n.normalise({x:g.y-f.y,y:f.x-g.x}),T=n.normalise({x:x.y-g.y,y:g.x-x.x}),v=Math.sqrt(2*Math.pow(M,2)),C=n.mult(r.clone(E),M),P=n.normalise(n.mult(n.add(E,T),.5)),S=n.sub(g,n.mult(P,v)),I=c;c===-1&&(I=Math.pow(M,.32)*1.75),I=r.clamp(I,m,l),I%2===1&&(I+=1);for(var w=Math.acos(n.dot(E,T)),b=w/I,A=0;A<I;A++)t.push(n.add(n.rotate(C,b*A),S))}return t},e.clockwiseSort=function(a){var u=e.mean(a);return a.sort(function(c,m){return n.angle(u,c)-n.angle(u,m)}),a},e.isConvex=function(a){var u=0,c=a.length,m,l,t,o;if(c<3)return null;for(m=0;m<c;m++)if(l=(m+1)%c,t=(m+2)%c,o=(a[l].x-a[m].x)*(a[t].y-a[l].y),o-=(a[l].y-a[m].y)*(a[t].x-a[l].x),o<0?u|=1:o>0&&(u|=2),u===3)return!1;return u!==0?!0:null},e.hull=function(a){var u=[],c=[],m,l;for(a=a.slice(0),a.sort(function(t,o){var f=t.x-o.x;return f!==0?f:t.y-o.y}),l=0;l<a.length;l+=1){for(m=a[l];c.length>=2&&n.cross3(c[c.length-2],c[c.length-1],m)<=0;)c.pop();c.push(m)}for(l=a.length-1;l>=0;l-=1){for(m=a[l];u.length>=2&&n.cross3(u[u.length-2],u[u.length-1],m)<=0;)u.pop();u.push(m)}return u.pop(),c.pop(),u.concat(c)}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(3),r=s(2),a=s(7),u=s(0),c=s(1),m=s(11);(function(){e._timeCorrection=!0,e._inertiaScale=4,e._nextCollidingGroupId=1,e._nextNonCollidingGroupId=-1,e._nextCategory=1,e._baseDelta=1e3/60,e.create=function(t){var o={id:u.nextId(),type:"body",label:"Body",parts:[],plugin:{},angle:0,vertices:n.fromPath("L 0 0 L 40 0 L 40 40 L 0 40"),position:{x:0,y:0},force:{x:0,y:0},torque:0,positionImpulse:{x:0,y:0},constraintImpulse:{x:0,y:0,angle:0},totalContacts:0,speed:0,angularSpeed:0,velocity:{x:0,y:0},angularVelocity:0,isSensor:!1,isStatic:!1,isSleeping:!1,motion:0,sleepThreshold:60,density:.001,restitution:0,friction:.1,frictionStatic:.5,frictionAir:.01,collisionFilter:{category:1,mask:4294967295,group:0},slop:.05,timeScale:1,render:{visible:!0,opacity:1,strokeStyle:null,fillStyle:null,lineWidth:null,sprite:{xScale:1,yScale:1,xOffset:0,yOffset:0}},events:null,bounds:null,chamfer:null,circleRadius:0,positionPrev:null,anglePrev:0,parent:null,axes:null,area:0,mass:0,inertia:0,deltaTime:16.666666666666668,_original:null},f=u.extend(o,t);return l(f,t),f},e.nextGroup=function(t){return t?e._nextNonCollidingGroupId--:e._nextCollidingGroupId++},e.nextCategory=function(){return e._nextCategory=e._nextCategory<<1,e._nextCategory};var l=function(t,o){o=o||{},e.set(t,{bounds:t.bounds||c.create(t.vertices),positionPrev:t.positionPrev||r.clone(t.position),anglePrev:t.anglePrev||t.angle,vertices:t.vertices,parts:t.parts||[t],isStatic:t.isStatic,isSleeping:t.isSleeping,parent:t.parent||t}),n.rotate(t.vertices,t.angle,t.position),m.rotate(t.axes,t.angle),c.update(t.bounds,t.vertices,t.velocity),e.set(t,{axes:o.axes||t.axes,area:o.area||t.area,mass:o.mass||t.mass,inertia:o.inertia||t.inertia});var f=t.isStatic?"#14151f":u.choose(["#f19648","#f5d259","#f55a3c","#063e7b","#ececd1"]),g=t.isStatic?"#555":"#ccc",x=t.isStatic&&t.render.fillStyle===null?1:0;t.render.fillStyle=t.render.fillStyle||f,t.render.strokeStyle=t.render.strokeStyle||g,t.render.lineWidth=t.render.lineWidth||x,t.render.sprite.xOffset+=-(t.bounds.min.x-t.position.x)/(t.bounds.max.x-t.bounds.min.x),t.render.sprite.yOffset+=-(t.bounds.min.y-t.position.y)/(t.bounds.max.y-t.bounds.min.y)};e.set=function(t,o,f){var g;typeof o=="string"&&(g=o,o={},o[g]=f);for(g in o)if(Object.prototype.hasOwnProperty.call(o,g))switch(f=o[g],g){case"isStatic":e.setStatic(t,f);break;case"isSleeping":a.set(t,f);break;case"mass":e.setMass(t,f);break;case"density":e.setDensity(t,f);break;case"inertia":e.setInertia(t,f);break;case"vertices":e.setVertices(t,f);break;case"position":e.setPosition(t,f);break;case"angle":e.setAngle(t,f);break;case"velocity":e.setVelocity(t,f);break;case"angularVelocity":e.setAngularVelocity(t,f);break;case"speed":e.setSpeed(t,f);break;case"angularSpeed":e.setAngularSpeed(t,f);break;case"parts":e.setParts(t,f);break;case"centre":e.setCentre(t,f);break;default:t[g]=f}},e.setStatic=function(t,o){for(var f=0;f<t.parts.length;f++){var g=t.parts[f];g.isStatic=o,o?(g._original={restitution:g.restitution,friction:g.friction,mass:g.mass,inertia:g.inertia,density:g.density,inverseMass:g.inverseMass,inverseInertia:g.inverseInertia},g.restitution=0,g.friction=1,g.mass=g.inertia=g.density=1/0,g.inverseMass=g.inverseInertia=0,g.positionPrev.x=g.position.x,g.positionPrev.y=g.position.y,g.anglePrev=g.angle,g.angularVelocity=0,g.speed=0,g.angularSpeed=0,g.motion=0):g._original&&(g.restitution=g._original.restitution,g.friction=g._original.friction,g.mass=g._original.mass,g.inertia=g._original.inertia,g.density=g._original.density,g.inverseMass=g._original.inverseMass,g.inverseInertia=g._original.inverseInertia,g._original=null)}},e.setMass=function(t,o){var f=t.inertia/(t.mass/6);t.inertia=f*(o/6),t.inverseInertia=1/t.inertia,t.mass=o,t.inverseMass=1/t.mass,t.density=t.mass/t.area},e.setDensity=function(t,o){e.setMass(t,o*t.area),t.density=o},e.setInertia=function(t,o){t.inertia=o,t.inverseInertia=1/t.inertia},e.setVertices=function(t,o){o[0].body===t?t.vertices=o:t.vertices=n.create(o,t),t.axes=m.fromVertices(t.vertices),t.area=n.area(t.vertices),e.setMass(t,t.density*t.area);var f=n.centre(t.vertices);n.translate(t.vertices,f,-1),e.setInertia(t,e._inertiaScale*n.inertia(t.vertices,t.mass)),n.translate(t.vertices,t.position),c.update(t.bounds,t.vertices,t.velocity)},e.setParts=function(t,o,f){var g;for(o=o.slice(0),t.parts.length=0,t.parts.push(t),t.parent=t,g=0;g<o.length;g++){var x=o[g];x!==t&&(x.parent=t,t.parts.push(x))}if(t.parts.length!==1){if(f=typeof f<"u"?f:!0,f){var M=[];for(g=0;g<o.length;g++)M=M.concat(o[g].vertices);n.clockwiseSort(M);var E=n.hull(M),T=n.centre(E);e.setVertices(t,E),n.translate(t.vertices,T)}var v=e._totalProperties(t);t.area=v.area,t.parent=t,t.position.x=v.centre.x,t.position.y=v.centre.y,t.positionPrev.x=v.centre.x,t.positionPrev.y=v.centre.y,e.setMass(t,v.mass),e.setInertia(t,v.inertia),e.setPosition(t,v.centre)}},e.setCentre=function(t,o,f){f?(t.positionPrev.x+=o.x,t.positionPrev.y+=o.y,t.position.x+=o.x,t.position.y+=o.y):(t.positionPrev.x=o.x-(t.position.x-t.positionPrev.x),t.positionPrev.y=o.y-(t.position.y-t.positionPrev.y),t.position.x=o.x,t.position.y=o.y)},e.setPosition=function(t,o,f){var g=r.sub(o,t.position);f?(t.positionPrev.x=t.position.x,t.positionPrev.y=t.position.y,t.velocity.x=g.x,t.velocity.y=g.y,t.speed=r.magnitude(g)):(t.positionPrev.x+=g.x,t.positionPrev.y+=g.y);for(var x=0;x<t.parts.length;x++){var M=t.parts[x];M.position.x+=g.x,M.position.y+=g.y,n.translate(M.vertices,g),c.update(M.bounds,M.vertices,t.velocity)}},e.setAngle=function(t,o,f){var g=o-t.angle;f?(t.anglePrev=t.angle,t.angularVelocity=g,t.angularSpeed=Math.abs(g)):t.anglePrev+=g;for(var x=0;x<t.parts.length;x++){var M=t.parts[x];M.angle+=g,n.rotate(M.vertices,g,t.position),m.rotate(M.axes,g),c.update(M.bounds,M.vertices,t.velocity),x>0&&r.rotateAbout(M.position,g,t.position,M.position)}},e.setVelocity=function(t,o){var f=t.deltaTime/e._baseDelta;t.positionPrev.x=t.position.x-o.x*f,t.positionPrev.y=t.position.y-o.y*f,t.velocity.x=(t.position.x-t.positionPrev.x)/f,t.velocity.y=(t.position.y-t.positionPrev.y)/f,t.speed=r.magnitude(t.velocity)},e.getVelocity=function(t){var o=e._baseDelta/t.deltaTime;return{x:(t.position.x-t.positionPrev.x)*o,y:(t.position.y-t.positionPrev.y)*o}},e.getSpeed=function(t){return r.magnitude(e.getVelocity(t))},e.setSpeed=function(t,o){e.setVelocity(t,r.mult(r.normalise(e.getVelocity(t)),o))},e.setAngularVelocity=function(t,o){var f=t.deltaTime/e._baseDelta;t.anglePrev=t.angle-o*f,t.angularVelocity=(t.angle-t.anglePrev)/f,t.angularSpeed=Math.abs(t.angularVelocity)},e.getAngularVelocity=function(t){return(t.angle-t.anglePrev)*e._baseDelta/t.deltaTime},e.getAngularSpeed=function(t){return Math.abs(e.getAngularVelocity(t))},e.setAngularSpeed=function(t,o){e.setAngularVelocity(t,u.sign(e.getAngularVelocity(t))*o)},e.translate=function(t,o,f){e.setPosition(t,r.add(t.position,o),f)},e.rotate=function(t,o,f,g){if(!f)e.setAngle(t,t.angle+o,g);else{var x=Math.cos(o),M=Math.sin(o),E=t.position.x-f.x,T=t.position.y-f.y;e.setPosition(t,{x:f.x+(E*x-T*M),y:f.y+(E*M+T*x)},g),e.setAngle(t,t.angle+o,g)}},e.scale=function(t,o,f,g){var x=0,M=0;g=g||t.position;for(var E=0;E<t.parts.length;E++){var T=t.parts[E];n.scale(T.vertices,o,f,g),T.axes=m.fromVertices(T.vertices),T.area=n.area(T.vertices),e.setMass(T,t.density*T.area),n.translate(T.vertices,{x:-T.position.x,y:-T.position.y}),e.setInertia(T,e._inertiaScale*n.inertia(T.vertices,T.mass)),n.translate(T.vertices,{x:T.position.x,y:T.position.y}),E>0&&(x+=T.area,M+=T.inertia),T.position.x=g.x+(T.position.x-g.x)*o,T.position.y=g.y+(T.position.y-g.y)*f,c.update(T.bounds,T.vertices,t.velocity)}t.parts.length>1&&(t.area=x,t.isStatic||(e.setMass(t,t.density*x),e.setInertia(t,M))),t.circleRadius&&(o===f?t.circleRadius*=o:t.circleRadius=null)},e.update=function(t,o){o=(typeof o<"u"?o:1e3/60)*t.timeScale;var f=o*o,g=e._timeCorrection?o/(t.deltaTime||o):1,x=1-t.frictionAir*(o/u._baseDelta),M=(t.position.x-t.positionPrev.x)*g,E=(t.position.y-t.positionPrev.y)*g;t.velocity.x=M*x+t.force.x/t.mass*f,t.velocity.y=E*x+t.force.y/t.mass*f,t.positionPrev.x=t.position.x,t.positionPrev.y=t.position.y,t.position.x+=t.velocity.x,t.position.y+=t.velocity.y,t.deltaTime=o,t.angularVelocity=(t.angle-t.anglePrev)*x*g+t.torque/t.inertia*f,t.anglePrev=t.angle,t.angle+=t.angularVelocity;for(var T=0;T<t.parts.length;T++){var v=t.parts[T];n.translate(v.vertices,t.velocity),T>0&&(v.position.x+=t.velocity.x,v.position.y+=t.velocity.y),t.angularVelocity!==0&&(n.rotate(v.vertices,t.angularVelocity,t.position),m.rotate(v.axes,t.angularVelocity),T>0&&r.rotateAbout(v.position,t.angularVelocity,t.position,v.position)),c.update(v.bounds,v.vertices,t.velocity)}},e.updateVelocities=function(t){var o=e._baseDelta/t.deltaTime,f=t.velocity;f.x=(t.position.x-t.positionPrev.x)*o,f.y=(t.position.y-t.positionPrev.y)*o,t.speed=Math.sqrt(f.x*f.x+f.y*f.y),t.angularVelocity=(t.angle-t.anglePrev)*o,t.angularSpeed=Math.abs(t.angularVelocity)},e.applyForce=function(t,o,f){var g={x:o.x-t.position.x,y:o.y-t.position.y};t.force.x+=f.x,t.force.y+=f.y,t.torque+=g.x*f.y-g.y*f.x},e._totalProperties=function(t){for(var o={mass:0,area:0,inertia:0,centre:{x:0,y:0}},f=t.parts.length===1?0:1;f<t.parts.length;f++){var g=t.parts[f],x=g.mass!==1/0?g.mass:1;o.mass+=x,o.area+=g.area,o.inertia+=g.inertia,o.centre=r.add(o.centre,r.mult(g.position,x))}return o.centre=r.div(o.centre,o.mass),o}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(0);(function(){e.on=function(r,a,u){for(var c=a.split(" "),m,l=0;l<c.length;l++)m=c[l],r.events=r.events||{},r.events[m]=r.events[m]||[],r.events[m].push(u);return u},e.off=function(r,a,u){if(!a){r.events={};return}typeof a=="function"&&(u=a,a=n.keys(r.events).join(" "));for(var c=a.split(" "),m=0;m<c.length;m++){var l=r.events[c[m]],t=[];if(u&&l)for(var o=0;o<l.length;o++)l[o]!==u&&t.push(l[o]);r.events[c[m]]=t}},e.trigger=function(r,a,u){var c,m,l,t,o=r.events;if(o&&n.keys(o).length>0){u||(u={}),c=a.split(" ");for(var f=0;f<c.length;f++)if(m=c[f],l=o[m],l){t=n.clone(u,!1),t.name=m,t.source=r;for(var g=0;g<l.length;g++)l[g].apply(r,[t])}}}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(5),r=s(0),a=s(1),u=s(4);(function(){e.create=function(c){return r.extend({id:r.nextId(),type:"composite",parent:null,isModified:!1,bodies:[],constraints:[],composites:[],label:"Composite",plugin:{},cache:{allBodies:null,allConstraints:null,allComposites:null}},c)},e.setModified=function(c,m,l,t){if(c.isModified=m,m&&c.cache&&(c.cache.allBodies=null,c.cache.allConstraints=null,c.cache.allComposites=null),l&&c.parent&&e.setModified(c.parent,m,l,t),t)for(var o=0;o<c.composites.length;o++){var f=c.composites[o];e.setModified(f,m,l,t)}},e.add=function(c,m){var l=[].concat(m);n.trigger(c,"beforeAdd",{object:m});for(var t=0;t<l.length;t++){var o=l[t];switch(o.type){case"body":if(o.parent!==o){r.warn("Composite.add: skipped adding a compound body part (you must add its parent instead)");break}e.addBody(c,o);break;case"constraint":e.addConstraint(c,o);break;case"composite":e.addComposite(c,o);break;case"mouseConstraint":e.addConstraint(c,o.constraint);break}}return n.trigger(c,"afterAdd",{object:m}),c},e.remove=function(c,m,l){var t=[].concat(m);n.trigger(c,"beforeRemove",{object:m});for(var o=0;o<t.length;o++){var f=t[o];switch(f.type){case"body":e.removeBody(c,f,l);break;case"constraint":e.removeConstraint(c,f,l);break;case"composite":e.removeComposite(c,f,l);break;case"mouseConstraint":e.removeConstraint(c,f.constraint);break}}return n.trigger(c,"afterRemove",{object:m}),c},e.addComposite=function(c,m){return c.composites.push(m),m.parent=c,e.setModified(c,!0,!0,!1),c},e.removeComposite=function(c,m,l){var t=r.indexOf(c.composites,m);if(t!==-1&&e.removeCompositeAt(c,t),l)for(var o=0;o<c.composites.length;o++)e.removeComposite(c.composites[o],m,!0);return c},e.removeCompositeAt=function(c,m){return c.composites.splice(m,1),e.setModified(c,!0,!0,!1),c},e.addBody=function(c,m){return c.bodies.push(m),e.setModified(c,!0,!0,!1),c},e.removeBody=function(c,m,l){var t=r.indexOf(c.bodies,m);if(t!==-1&&e.removeBodyAt(c,t),l)for(var o=0;o<c.composites.length;o++)e.removeBody(c.composites[o],m,!0);return c},e.removeBodyAt=function(c,m){return c.bodies.splice(m,1),e.setModified(c,!0,!0,!1),c},e.addConstraint=function(c,m){return c.constraints.push(m),e.setModified(c,!0,!0,!1),c},e.removeConstraint=function(c,m,l){var t=r.indexOf(c.constraints,m);if(t!==-1&&e.removeConstraintAt(c,t),l)for(var o=0;o<c.composites.length;o++)e.removeConstraint(c.composites[o],m,!0);return c},e.removeConstraintAt=function(c,m){return c.constraints.splice(m,1),e.setModified(c,!0,!0,!1),c},e.clear=function(c,m,l){if(l)for(var t=0;t<c.composites.length;t++)e.clear(c.composites[t],m,!0);return m?c.bodies=c.bodies.filter(function(o){return o.isStatic}):c.bodies.length=0,c.constraints.length=0,c.composites.length=0,e.setModified(c,!0,!0,!1),c},e.allBodies=function(c){if(c.cache&&c.cache.allBodies)return c.cache.allBodies;for(var m=[].concat(c.bodies),l=0;l<c.composites.length;l++)m=m.concat(e.allBodies(c.composites[l]));return c.cache&&(c.cache.allBodies=m),m},e.allConstraints=function(c){if(c.cache&&c.cache.allConstraints)return c.cache.allConstraints;for(var m=[].concat(c.constraints),l=0;l<c.composites.length;l++)m=m.concat(e.allConstraints(c.composites[l]));return c.cache&&(c.cache.allConstraints=m),m},e.allComposites=function(c){if(c.cache&&c.cache.allComposites)return c.cache.allComposites;for(var m=[].concat(c.composites),l=0;l<c.composites.length;l++)m=m.concat(e.allComposites(c.composites[l]));return c.cache&&(c.cache.allComposites=m),m},e.get=function(c,m,l){var t,o;switch(l){case"body":t=e.allBodies(c);break;case"constraint":t=e.allConstraints(c);break;case"composite":t=e.allComposites(c).concat(c);break}return t?(o=t.filter(function(f){return f.id.toString()===m.toString()}),o.length===0?null:o[0]):null},e.move=function(c,m,l){return e.remove(c,m),e.add(l,m),c},e.rebase=function(c){for(var m=e.allBodies(c).concat(e.allConstraints(c)).concat(e.allComposites(c)),l=0;l<m.length;l++)m[l].id=r.nextId();return c},e.translate=function(c,m,l){for(var t=l?e.allBodies(c):c.bodies,o=0;o<t.length;o++)u.translate(t[o],m);return c},e.rotate=function(c,m,l,t){for(var o=Math.cos(m),f=Math.sin(m),g=t?e.allBodies(c):c.bodies,x=0;x<g.length;x++){var M=g[x],E=M.position.x-l.x,T=M.position.y-l.y;u.setPosition(M,{x:l.x+(E*o-T*f),y:l.y+(E*f+T*o)}),u.rotate(M,m)}return c},e.scale=function(c,m,l,t,o){for(var f=o?e.allBodies(c):c.bodies,g=0;g<f.length;g++){var x=f[g],M=x.position.x-t.x,E=x.position.y-t.y;u.setPosition(x,{x:t.x+M*m,y:t.y+E*l}),u.scale(x,m,l)}return c},e.bounds=function(c){for(var m=e.allBodies(c),l=[],t=0;t<m.length;t+=1){var o=m[t];l.push(o.bounds.min,o.bounds.max)}return a.create(l)}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(4),r=s(5),a=s(0);(function(){e._motionWakeThreshold=.18,e._motionSleepThreshold=.08,e._minBias=.9,e.update=function(u,c){for(var m=c/a._baseDelta,l=e._motionSleepThreshold,t=0;t<u.length;t++){var o=u[t],f=n.getSpeed(o),g=n.getAngularSpeed(o),x=f*f+g*g;if(o.force.x!==0||o.force.y!==0){e.set(o,!1);continue}var M=Math.min(o.motion,x),E=Math.max(o.motion,x);o.motion=e._minBias*M+(1-e._minBias)*E,o.sleepThreshold>0&&o.motion<l?(o.sleepCounter+=1,o.sleepCounter>=o.sleepThreshold/m&&e.set(o,!0)):o.sleepCounter>0&&(o.sleepCounter-=1)}},e.afterCollisions=function(u){for(var c=e._motionSleepThreshold,m=0;m<u.length;m++){var l=u[m];if(l.isActive){var t=l.collision,o=t.bodyA.parent,f=t.bodyB.parent;if(!(o.isSleeping&&f.isSleeping||o.isStatic||f.isStatic)&&(o.isSleeping||f.isSleeping)){var g=o.isSleeping&&!o.isStatic?o:f,x=g===o?f:o;!g.isStatic&&x.motion>c&&e.set(g,!1)}}}},e.set=function(u,c){var m=u.isSleeping;c?(u.isSleeping=!0,u.sleepCounter=u.sleepThreshold,u.positionImpulse.x=0,u.positionImpulse.y=0,u.positionPrev.x=u.position.x,u.positionPrev.y=u.position.y,u.anglePrev=u.angle,u.speed=0,u.angularSpeed=0,u.motion=0,m||r.trigger(u,"sleepStart")):(u.isSleeping=!1,u.sleepCounter=0,m&&r.trigger(u,"sleepEnd"))}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(3),r=s(9);(function(){var a=[],u={overlap:0,axis:null},c={overlap:0,axis:null};e.create=function(m,l){return{pair:null,collided:!1,bodyA:m,bodyB:l,parentA:m.parent,parentB:l.parent,depth:0,normal:{x:0,y:0},tangent:{x:0,y:0},penetration:{x:0,y:0},supports:[]}},e.collides=function(m,l,t){if(e._overlapAxes(u,m.vertices,l.vertices,m.axes),u.overlap<=0||(e._overlapAxes(c,l.vertices,m.vertices,l.axes),c.overlap<=0))return null;var o=t&&t.table[r.id(m,l)],f;o?f=o.collision:(f=e.create(m,l),f.collided=!0,f.bodyA=m.id<l.id?m:l,f.bodyB=m.id<l.id?l:m,f.parentA=f.bodyA.parent,f.parentB=f.bodyB.parent),m=f.bodyA,l=f.bodyB;var g;u.overlap<c.overlap?g=u:g=c;var x=f.normal,M=f.supports,E=g.axis,T=E.x,v=E.y;T*(l.position.x-m.position.x)+v*(l.position.y-m.position.y)<0?(x.x=T,x.y=v):(x.x=-T,x.y=-v),f.tangent.x=-x.y,f.tangent.y=x.x,f.depth=g.overlap,f.penetration.x=x.x*f.depth,f.penetration.y=x.y*f.depth;var C=e._findSupports(m,l,x,1),P=0;if(n.contains(m.vertices,C[0])&&(M[P++]=C[0]),n.contains(m.vertices,C[1])&&(M[P++]=C[1]),P<2){var S=e._findSupports(l,m,x,-1);n.contains(l.vertices,S[0])&&(M[P++]=S[0]),P<2&&n.contains(l.vertices,S[1])&&(M[P++]=S[1])}return P===0&&(M[P++]=C[0]),M.length=P,f},e._overlapAxes=function(m,l,t,o){var f=l.length,g=t.length,x=l[0].x,M=l[0].y,E=t[0].x,T=t[0].y,v=o.length,C=Number.MAX_VALUE,P=0,S,I,w,b,A,D;for(A=0;A<v;A++){var O=o[A],R=O.x,z=O.y,N=x*R+M*z,H=E*R+T*z,q=N,J=H;for(D=1;D<f;D+=1)b=l[D].x*R+l[D].y*z,b>q?q=b:b<N&&(N=b);for(D=1;D<g;D+=1)b=t[D].x*R+t[D].y*z,b>J?J=b:b<H&&(H=b);if(I=q-H,w=J-N,S=I<w?I:w,S<C&&(C=S,P=A,S<=0))break}m.axis=o[P],m.overlap=C},e._projectToAxis=function(m,l,t){for(var o=l[0].x*t.x+l[0].y*t.y,f=o,g=1;g<l.length;g+=1){var x=l[g].x*t.x+l[g].y*t.y;x>f?f=x:x<o&&(o=x)}m.min=o,m.max=f},e._findSupports=function(m,l,t,o){var f=l.vertices,g=f.length,x=m.position.x,M=m.position.y,E=t.x*o,T=t.y*o,v=Number.MAX_VALUE,C,P,S,I,w;for(w=0;w<g;w+=1)P=f[w],I=E*(x-P.x)+T*(M-P.y),I<v&&(v=I,C=P);return S=f[(g+C.index-1)%g],v=E*(x-S.x)+T*(M-S.y),P=f[(C.index+1)%g],E*(x-P.x)+T*(M-P.y)<v?(a[0]=C,a[1]=P,a):(a[0]=C,a[1]=S,a)}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(16);(function(){e.create=function(r,a){var u=r.bodyA,c=r.bodyB,m={id:e.id(u,c),bodyA:u,bodyB:c,collision:r,contacts:[],activeContacts:[],separation:0,isActive:!0,confirmedActive:!0,isSensor:u.isSensor||c.isSensor,timeCreated:a,timeUpdated:a,inverseMass:0,friction:0,frictionStatic:0,restitution:0,slop:0};return e.update(m,r,a),m},e.update=function(r,a,u){var c=r.contacts,m=a.supports,l=r.activeContacts,t=a.parentA,o=a.parentB,f=t.vertices.length;r.isActive=!0,r.timeUpdated=u,r.collision=a,r.separation=a.depth,r.inverseMass=t.inverseMass+o.inverseMass,r.friction=t.friction<o.friction?t.friction:o.friction,r.frictionStatic=t.frictionStatic>o.frictionStatic?t.frictionStatic:o.frictionStatic,r.restitution=t.restitution>o.restitution?t.restitution:o.restitution,r.slop=t.slop>o.slop?t.slop:o.slop,a.pair=r,l.length=0;for(var g=0;g<m.length;g++){var x=m[g],M=x.body===t?x.index:f+x.index,E=c[M];E?l.push(E):l.push(c[M]=n.create(x))}},e.setActive=function(r,a,u){a?(r.isActive=!0,r.timeUpdated=u):(r.isActive=!1,r.activeContacts.length=0)},e.id=function(r,a){return r.id<a.id?"A"+r.id+"B"+a.id:"A"+a.id+"B"+r.id}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(3),r=s(2),a=s(7),u=s(1),c=s(11),m=s(0);(function(){e._warming=.4,e._torqueDampen=1,e._minLength=1e-6,e.create=function(l){var t=l;t.bodyA&&!t.pointA&&(t.pointA={x:0,y:0}),t.bodyB&&!t.pointB&&(t.pointB={x:0,y:0});var o=t.bodyA?r.add(t.bodyA.position,t.pointA):t.pointA,f=t.bodyB?r.add(t.bodyB.position,t.pointB):t.pointB,g=r.magnitude(r.sub(o,f));t.length=typeof t.length<"u"?t.length:g,t.id=t.id||m.nextId(),t.label=t.label||"Constraint",t.type="constraint",t.stiffness=t.stiffness||(t.length>0?1:.7),t.damping=t.damping||0,t.angularStiffness=t.angularStiffness||0,t.angleA=t.bodyA?t.bodyA.angle:t.angleA,t.angleB=t.bodyB?t.bodyB.angle:t.angleB,t.plugin={};var x={visible:!0,lineWidth:2,strokeStyle:"#ffffff",type:"line",anchors:!0};return t.length===0&&t.stiffness>.1?(x.type="pin",x.anchors=!1):t.stiffness<.9&&(x.type="spring"),t.render=m.extend(x,t.render),t},e.preSolveAll=function(l){for(var t=0;t<l.length;t+=1){var o=l[t],f=o.constraintImpulse;o.isStatic||f.x===0&&f.y===0&&f.angle===0||(o.position.x+=f.x,o.position.y+=f.y,o.angle+=f.angle)}},e.solveAll=function(l,t){for(var o=m.clamp(t/m._baseDelta,0,1),f=0;f<l.length;f+=1){var g=l[f],x=!g.bodyA||g.bodyA&&g.bodyA.isStatic,M=!g.bodyB||g.bodyB&&g.bodyB.isStatic;(x||M)&&e.solve(l[f],o)}for(f=0;f<l.length;f+=1)g=l[f],x=!g.bodyA||g.bodyA&&g.bodyA.isStatic,M=!g.bodyB||g.bodyB&&g.bodyB.isStatic,!x&&!M&&e.solve(l[f],o)},e.solve=function(l,t){var o=l.bodyA,f=l.bodyB,g=l.pointA,x=l.pointB;if(!(!o&&!f)){o&&!o.isStatic&&(r.rotate(g,o.angle-l.angleA,g),l.angleA=o.angle),f&&!f.isStatic&&(r.rotate(x,f.angle-l.angleB,x),l.angleB=f.angle);var M=g,E=x;if(o&&(M=r.add(o.position,g)),f&&(E=r.add(f.position,x)),!(!M||!E)){var T=r.sub(M,E),v=r.magnitude(T);v<e._minLength&&(v=e._minLength);var C=(v-l.length)/v,P=l.stiffness>=1||l.length===0,S=P?l.stiffness*t:l.stiffness*t*t,I=l.damping*t,w=r.mult(T,C*S),b=(o?o.inverseMass:0)+(f?f.inverseMass:0),A=(o?o.inverseInertia:0)+(f?f.inverseInertia:0),D=b+A,O,R,z,N,H;if(I>0){var q=r.create();z=r.div(T,v),H=r.sub(f&&r.sub(f.position,f.positionPrev)||q,o&&r.sub(o.position,o.positionPrev)||q),N=r.dot(z,H)}o&&!o.isStatic&&(R=o.inverseMass/b,o.constraintImpulse.x-=w.x*R,o.constraintImpulse.y-=w.y*R,o.position.x-=w.x*R,o.position.y-=w.y*R,I>0&&(o.positionPrev.x-=I*z.x*N*R,o.positionPrev.y-=I*z.y*N*R),O=r.cross(g,w)/D*e._torqueDampen*o.inverseInertia*(1-l.angularStiffness),o.constraintImpulse.angle-=O,o.angle-=O),f&&!f.isStatic&&(R=f.inverseMass/b,f.constraintImpulse.x+=w.x*R,f.constraintImpulse.y+=w.y*R,f.position.x+=w.x*R,f.position.y+=w.y*R,I>0&&(f.positionPrev.x+=I*z.x*N*R,f.positionPrev.y+=I*z.y*N*R),O=r.cross(x,w)/D*e._torqueDampen*f.inverseInertia*(1-l.angularStiffness),f.constraintImpulse.angle+=O,f.angle+=O)}}},e.postSolveAll=function(l){for(var t=0;t<l.length;t++){var o=l[t],f=o.constraintImpulse;if(!(o.isStatic||f.x===0&&f.y===0&&f.angle===0)){a.set(o,!1);for(var g=0;g<o.parts.length;g++){var x=o.parts[g];n.translate(x.vertices,f),g>0&&(x.position.x+=f.x,x.position.y+=f.y),f.angle!==0&&(n.rotate(x.vertices,f.angle,o.position),c.rotate(x.axes,f.angle),g>0&&r.rotateAbout(x.position,f.angle,o.position,x.position)),u.update(x.bounds,x.vertices,o.velocity)}f.angle*=e._warming,f.x*=e._warming,f.y*=e._warming}}},e.pointAWorld=function(l){return{x:(l.bodyA?l.bodyA.position.x:0)+(l.pointA?l.pointA.x:0),y:(l.bodyA?l.bodyA.position.y:0)+(l.pointA?l.pointA.y:0)}},e.pointBWorld=function(l){return{x:(l.bodyB?l.bodyB.position.x:0)+(l.pointB?l.pointB.x:0),y:(l.bodyB?l.bodyB.position.y:0)+(l.pointB?l.pointB.y:0)}}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(2),r=s(0);(function(){e.fromVertices=function(a){for(var u={},c=0;c<a.length;c++){var m=(c+1)%a.length,l=n.normalise({x:a[m].y-a[c].y,y:a[c].x-a[m].x}),t=l.y===0?1/0:l.x/l.y;t=t.toFixed(3).toString(),u[t]=l}return r.values(u)},e.rotate=function(a,u){if(u!==0)for(var c=Math.cos(u),m=Math.sin(u),l=0;l<a.length;l++){var t=a[l],o;o=t.x*c-t.y*m,t.y=t.x*m+t.y*c,t.x=o}}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(3),r=s(0),a=s(4),u=s(1),c=s(2);(function(){e.rectangle=function(m,l,t,o,f){f=f||{};var g={label:"Rectangle Body",position:{x:m,y:l},vertices:n.fromPath("L 0 0 L "+t+" 0 L "+t+" "+o+" L 0 "+o)};if(f.chamfer){var x=f.chamfer;g.vertices=n.chamfer(g.vertices,x.radius,x.quality,x.qualityMin,x.qualityMax),delete f.chamfer}return a.create(r.extend({},g,f))},e.trapezoid=function(m,l,t,o,f,g){g=g||{},f*=.5;var x=(1-f*2)*t,M=t*f,E=M+x,T=E+M,v;f<.5?v="L 0 0 L "+M+" "+-o+" L "+E+" "+-o+" L "+T+" 0":v="L 0 0 L "+E+" "+-o+" L "+T+" 0";var C={label:"Trapezoid Body",position:{x:m,y:l},vertices:n.fromPath(v)};if(g.chamfer){var P=g.chamfer;C.vertices=n.chamfer(C.vertices,P.radius,P.quality,P.qualityMin,P.qualityMax),delete g.chamfer}return a.create(r.extend({},C,g))},e.circle=function(m,l,t,o,f){o=o||{};var g={label:"Circle Body",circleRadius:t};f=f||25;var x=Math.ceil(Math.max(10,Math.min(f,t)));return x%2===1&&(x+=1),e.polygon(m,l,x,t,r.extend({},g,o))},e.polygon=function(m,l,t,o,f){if(f=f||{},t<3)return e.circle(m,l,o,f);for(var g=2*Math.PI/t,x="",M=g*.5,E=0;E<t;E+=1){var T=M+E*g,v=Math.cos(T)*o,C=Math.sin(T)*o;x+="L "+v.toFixed(3)+" "+C.toFixed(3)+" "}var P={label:"Polygon Body",position:{x:m,y:l},vertices:n.fromPath(x)};if(f.chamfer){var S=f.chamfer;P.vertices=n.chamfer(P.vertices,S.radius,S.quality,S.qualityMin,S.qualityMax),delete f.chamfer}return a.create(r.extend({},P,f))},e.fromVertices=function(m,l,t,o,f,g,x,M){var E=r.getDecomp(),T,v,C,P,S,I,w,b,A,D,O;for(T=!!(E&&E.quickDecomp),o=o||{},C=[],f=typeof f<"u"?f:!1,g=typeof g<"u"?g:.01,x=typeof x<"u"?x:10,M=typeof M<"u"?M:.01,r.isArray(t[0])||(t=[t]),D=0;D<t.length;D+=1)if(I=t[D],P=n.isConvex(I),S=!P,S&&!T&&r.warnOnce("Bodies.fromVertices: Install the 'poly-decomp' library and use Common.setDecomp or provide 'decomp' as a global to decompose concave vertices."),P||!T)P?I=n.clockwiseSort(I):I=n.hull(I),C.push({position:{x:m,y:l},vertices:I});else{var R=I.map(function(Z){return[Z.x,Z.y]});E.makeCCW(R),g!==!1&&E.removeCollinearPoints(R,g),M!==!1&&E.removeDuplicatePoints&&E.removeDuplicatePoints(R,M);var z=E.quickDecomp(R);for(w=0;w<z.length;w++){var N=z[w],H=N.map(function(Z){return{x:Z[0],y:Z[1]}});x>0&&n.area(H)<x||C.push({position:n.centre(H),vertices:H})}}for(w=0;w<C.length;w++)C[w]=a.create(r.extend(C[w],o));if(f){var q=5;for(w=0;w<C.length;w++){var J=C[w];for(b=w+1;b<C.length;b++){var _=C[b];if(u.overlaps(J.bounds,_.bounds)){var $=J.vertices,K=_.vertices;for(A=0;A<J.vertices.length;A++)for(O=0;O<_.vertices.length;O++){var Y=c.magnitudeSquared(c.sub($[(A+1)%$.length],K[O])),ne=c.magnitudeSquared(c.sub($[A],K[(O+1)%K.length]));Y<q&&ne<q&&($[A].isInternal=!0,K[O].isInternal=!0)}}}}}return C.length>1?(v=a.create(r.extend({parts:C.slice(0)},o)),a.setPosition(v,{x:m,y:l}),v):C[0]}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(0),r=s(8);(function(){e.create=function(a){var u={bodies:[],pairs:null};return n.extend(u,a)},e.setBodies=function(a,u){a.bodies=u.slice(0)},e.clear=function(a){a.bodies=[]},e.collisions=function(a){var u=[],c=a.pairs,m=a.bodies,l=m.length,t=e.canCollide,o=r.collides,f,g;for(m.sort(e._compareBoundsX),f=0;f<l;f++){var x=m[f],M=x.bounds,E=x.bounds.max.x,T=x.bounds.max.y,v=x.bounds.min.y,C=x.isStatic||x.isSleeping,P=x.parts.length,S=P===1;for(g=f+1;g<l;g++){var I=m[g],w=I.bounds;if(w.min.x>E)break;if(!(T<w.min.y||v>w.max.y)&&!(C&&(I.isStatic||I.isSleeping))&&t(x.collisionFilter,I.collisionFilter)){var b=I.parts.length;if(S&&b===1){var A=o(x,I,c);A&&u.push(A)}else for(var D=P>1?1:0,O=b>1?1:0,R=D;R<P;R++)for(var z=x.parts[R],M=z.bounds,N=O;N<b;N++){var H=I.parts[N],w=H.bounds;if(!(M.min.x>w.max.x||M.max.x<w.min.x||M.max.y<w.min.y||M.min.y>w.max.y)){var A=o(z,H,c);A&&u.push(A)}}}}}return u},e.canCollide=function(a,u){return a.group===u.group&&a.group!==0?a.group>0:(a.mask&u.category)!==0&&(u.mask&a.category)!==0},e._compareBoundsX=function(a,u){return a.bounds.min.x-u.bounds.min.x}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(0);(function(){e.create=function(r){var a={};return r||n.log("Mouse.create: element was undefined, defaulting to document.body","warn"),a.element=r||document.body,a.absolute={x:0,y:0},a.position={x:0,y:0},a.mousedownPosition={x:0,y:0},a.mouseupPosition={x:0,y:0},a.offset={x:0,y:0},a.scale={x:1,y:1},a.wheelDelta=0,a.button=-1,a.pixelRatio=parseInt(a.element.getAttribute("data-pixel-ratio"),10)||1,a.sourceEvents={mousemove:null,mousedown:null,mouseup:null,mousewheel:null},a.mousemove=function(u){var c=e._getRelativeMousePosition(u,a.element,a.pixelRatio),m=u.changedTouches;m&&(a.button=0,u.preventDefault()),a.absolute.x=c.x,a.absolute.y=c.y,a.position.x=a.absolute.x*a.scale.x+a.offset.x,a.position.y=a.absolute.y*a.scale.y+a.offset.y,a.sourceEvents.mousemove=u},a.mousedown=function(u){var c=e._getRelativeMousePosition(u,a.element,a.pixelRatio),m=u.changedTouches;m?(a.button=0,u.preventDefault()):a.button=u.button,a.absolute.x=c.x,a.absolute.y=c.y,a.position.x=a.absolute.x*a.scale.x+a.offset.x,a.position.y=a.absolute.y*a.scale.y+a.offset.y,a.mousedownPosition.x=a.position.x,a.mousedownPosition.y=a.position.y,a.sourceEvents.mousedown=u},a.mouseup=function(u){var c=e._getRelativeMousePosition(u,a.element,a.pixelRatio),m=u.changedTouches;m&&u.preventDefault(),a.button=-1,a.absolute.x=c.x,a.absolute.y=c.y,a.position.x=a.absolute.x*a.scale.x+a.offset.x,a.position.y=a.absolute.y*a.scale.y+a.offset.y,a.mouseupPosition.x=a.position.x,a.mouseupPosition.y=a.position.y,a.sourceEvents.mouseup=u},a.mousewheel=function(u){a.wheelDelta=Math.max(-1,Math.min(1,u.wheelDelta||-u.detail)),u.preventDefault()},e.setElement(a,a.element),a},e.setElement=function(r,a){r.element=a,a.addEventListener("mousemove",r.mousemove),a.addEventListener("mousedown",r.mousedown),a.addEventListener("mouseup",r.mouseup),a.addEventListener("mousewheel",r.mousewheel),a.addEventListener("DOMMouseScroll",r.mousewheel),a.addEventListener("touchmove",r.mousemove),a.addEventListener("touchstart",r.mousedown),a.addEventListener("touchend",r.mouseup)},e.clearSourceEvents=function(r){r.sourceEvents.mousemove=null,r.sourceEvents.mousedown=null,r.sourceEvents.mouseup=null,r.sourceEvents.mousewheel=null,r.wheelDelta=0},e.setOffset=function(r,a){r.offset.x=a.x,r.offset.y=a.y,r.position.x=r.absolute.x*r.scale.x+r.offset.x,r.position.y=r.absolute.y*r.scale.y+r.offset.y},e.setScale=function(r,a){r.scale.x=a.x,r.scale.y=a.y,r.position.x=r.absolute.x*r.scale.x+r.offset.x,r.position.y=r.absolute.y*r.scale.y+r.offset.y},e._getRelativeMousePosition=function(r,a,u){var c=a.getBoundingClientRect(),m=document.documentElement||document.body.parentNode||document.body,l=window.pageXOffset!==void 0?window.pageXOffset:m.scrollLeft,t=window.pageYOffset!==void 0?window.pageYOffset:m.scrollTop,o=r.changedTouches,f,g;return o?(f=o[0].pageX-c.left-l,g=o[0].pageY-c.top-t):(f=r.pageX-c.left-l,g=r.pageY-c.top-t),{x:f/(a.clientWidth/(a.width||a.clientWidth)*u),y:g/(a.clientHeight/(a.height||a.clientHeight)*u)}}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(0);(function(){e._registry={},e.register=function(r){if(e.isPlugin(r)||n.warn("Plugin.register:",e.toString(r),"does not implement all required fields."),r.name in e._registry){var a=e._registry[r.name],u=e.versionParse(r.version).number,c=e.versionParse(a.version).number;u>c?(n.warn("Plugin.register:",e.toString(a),"was upgraded to",e.toString(r)),e._registry[r.name]=r):u<c?n.warn("Plugin.register:",e.toString(a),"can not be downgraded to",e.toString(r)):r!==a&&n.warn("Plugin.register:",e.toString(r),"is already registered to different plugin object")}else e._registry[r.name]=r;return r},e.resolve=function(r){return e._registry[e.dependencyParse(r).name]},e.toString=function(r){return typeof r=="string"?r:(r.name||"anonymous")+"@"+(r.version||r.range||"0.0.0")},e.isPlugin=function(r){return r&&r.name&&r.version&&r.install},e.isUsed=function(r,a){return r.used.indexOf(a)>-1},e.isFor=function(r,a){var u=r.for&&e.dependencyParse(r.for);return!r.for||a.name===u.name&&e.versionSatisfies(a.version,u.range)},e.use=function(r,a){if(r.uses=(r.uses||[]).concat(a||[]),r.uses.length===0){n.warn("Plugin.use:",e.toString(r),"does not specify any dependencies to install.");return}for(var u=e.dependencies(r),c=n.topologicalSort(u),m=[],l=0;l<c.length;l+=1)if(c[l]!==r.name){var t=e.resolve(c[l]);if(!t){m.push("âŒ "+c[l]);continue}e.isUsed(r,t.name)||(e.isFor(t,r)||(n.warn("Plugin.use:",e.toString(t),"is for",t.for,"but installed on",e.toString(r)+"."),t._warned=!0),t.install?t.install(r):(n.warn("Plugin.use:",e.toString(t),"does not specify an install function."),t._warned=!0),t._warned?(m.push("ðŸ”¶ "+e.toString(t)),delete t._warned):m.push("âœ… "+e.toString(t)),r.used.push(t.name))}m.length>0&&n.info(m.join("  "))},e.dependencies=function(r,a){var u=e.dependencyParse(r),c=u.name;if(a=a||{},!(c in a)){r=e.resolve(r)||r,a[c]=n.map(r.uses||[],function(l){e.isPlugin(l)&&e.register(l);var t=e.dependencyParse(l),o=e.resolve(l);return o&&!e.versionSatisfies(o.version,t.range)?(n.warn("Plugin.dependencies:",e.toString(o),"does not satisfy",e.toString(t),"used by",e.toString(u)+"."),o._warned=!0,r._warned=!0):o||(n.warn("Plugin.dependencies:",e.toString(l),"used by",e.toString(u),"could not be resolved."),r._warned=!0),t.name});for(var m=0;m<a[c].length;m+=1)e.dependencies(a[c][m],a);return a}},e.dependencyParse=function(r){if(n.isString(r)){var a=/^[\w-]+(@(\*|[\^~]?\d+\.\d+\.\d+(-[0-9A-Za-z-+]+)?))?$/;return a.test(r)||n.warn("Plugin.dependencyParse:",r,"is not a valid dependency string."),{name:r.split("@")[0],range:r.split("@")[1]||"*"}}return{name:r.name,range:r.range||r.version}},e.versionParse=function(r){var a=/^(\*)|(\^|~|>=|>)?\s*((\d+)\.(\d+)\.(\d+))(-[0-9A-Za-z-+]+)?$/;a.test(r)||n.warn("Plugin.versionParse:",r,"is not a valid version or range.");var u=a.exec(r),c=Number(u[4]),m=Number(u[5]),l=Number(u[6]);return{isRange:!!(u[1]||u[2]),version:u[3],range:r,operator:u[1]||u[2]||"",major:c,minor:m,patch:l,parts:[c,m,l],prerelease:u[7],number:c*1e8+m*1e4+l}},e.versionSatisfies=function(r,a){a=a||"*";var u=e.versionParse(a),c=e.versionParse(r);if(u.isRange){if(u.operator==="*"||r==="*")return!0;if(u.operator===">")return c.number>u.number;if(u.operator===">=")return c.number>=u.number;if(u.operator==="~")return c.major===u.major&&c.minor===u.minor&&c.patch>=u.patch;if(u.operator==="^")return u.major>0?c.major===u.major&&c.number>=u.number:u.minor>0?c.minor===u.minor&&c.patch>=u.patch:c.patch===u.patch}return r===a||r==="*"}})()}),(function(d,p){var s={};d.exports=s,(function(){s.create=function(e){return{vertex:e,normalImpulse:0,tangentImpulse:0}}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(7),r=s(18),a=s(13),u=s(19),c=s(5),m=s(6),l=s(10),t=s(0),o=s(4);(function(){e.create=function(f){f=f||{};var g={positionIterations:6,velocityIterations:4,constraintIterations:2,enableSleeping:!1,events:[],plugin:{},gravity:{x:0,y:1,scale:.001},timing:{timestamp:0,timeScale:1,lastDelta:0,lastElapsed:0}},x=t.extend(g,f);return x.world=f.world||m.create({label:"World"}),x.pairs=f.pairs||u.create(),x.detector=f.detector||a.create(),x.grid={buckets:[]},x.world.gravity=x.gravity,x.broadphase=x.grid,x.metrics={},x},e.update=function(f,g){var x=t.now(),M=f.world,E=f.detector,T=f.pairs,v=f.timing,C=v.timestamp,P;g=typeof g<"u"?g:t._baseDelta,g*=v.timeScale,v.timestamp+=g,v.lastDelta=g;var S={timestamp:v.timestamp,delta:g};c.trigger(f,"beforeUpdate",S);var I=m.allBodies(M),w=m.allConstraints(M);for(M.isModified&&(a.setBodies(E,I),m.setModified(M,!1,!1,!0)),f.enableSleeping&&n.update(I,g),e._bodiesApplyGravity(I,f.gravity),g>0&&e._bodiesUpdate(I,g),l.preSolveAll(I),P=0;P<f.constraintIterations;P++)l.solveAll(w,g);l.postSolveAll(I),E.pairs=f.pairs;var b=a.collisions(E);u.update(T,b,C),f.enableSleeping&&n.afterCollisions(T.list),T.collisionStart.length>0&&c.trigger(f,"collisionStart",{pairs:T.collisionStart});var A=t.clamp(20/f.positionIterations,0,1);for(r.preSolvePosition(T.list),P=0;P<f.positionIterations;P++)r.solvePosition(T.list,g,A);for(r.postSolvePosition(I),l.preSolveAll(I),P=0;P<f.constraintIterations;P++)l.solveAll(w,g);for(l.postSolveAll(I),r.preSolveVelocity(T.list),P=0;P<f.velocityIterations;P++)r.solveVelocity(T.list,g);return e._bodiesUpdateVelocities(I),T.collisionActive.length>0&&c.trigger(f,"collisionActive",{pairs:T.collisionActive}),T.collisionEnd.length>0&&c.trigger(f,"collisionEnd",{pairs:T.collisionEnd}),e._bodiesClearForces(I),c.trigger(f,"afterUpdate",S),f.timing.lastElapsed=t.now()-x,f},e.merge=function(f,g){if(t.extend(f,g),g.world){f.world=g.world,e.clear(f);for(var x=m.allBodies(f.world),M=0;M<x.length;M++){var E=x[M];n.set(E,!1),E.id=t.nextId()}}},e.clear=function(f){u.clear(f.pairs),a.clear(f.detector)},e._bodiesClearForces=function(f){for(var g=f.length,x=0;x<g;x++){var M=f[x];M.force.x=0,M.force.y=0,M.torque=0}},e._bodiesApplyGravity=function(f,g){var x=typeof g.scale<"u"?g.scale:.001,M=f.length;if(!(g.x===0&&g.y===0||x===0))for(var E=0;E<M;E++){var T=f[E];T.isStatic||T.isSleeping||(T.force.y+=T.mass*g.y*x,T.force.x+=T.mass*g.x*x)}},e._bodiesUpdate=function(f,g){for(var x=f.length,M=0;M<x;M++){var E=f[M];E.isStatic||E.isSleeping||o.update(E,g)}},e._bodiesUpdateVelocities=function(f){for(var g=f.length,x=0;x<g;x++)o.updateVelocities(f[x])}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(3),r=s(0),a=s(1);(function(){e._restingThresh=2,e._restingThreshTangent=Math.sqrt(6),e._positionDampen=.9,e._positionWarming=.8,e._frictionNormalMultiplier=5,e._frictionMaxStatic=Number.MAX_VALUE,e.preSolvePosition=function(u){var c,m,l,t=u.length;for(c=0;c<t;c++)m=u[c],m.isActive&&(l=m.activeContacts.length,m.collision.parentA.totalContacts+=l,m.collision.parentB.totalContacts+=l)},e.solvePosition=function(u,c,m){var l,t,o,f,g,x,M,E,T=e._positionDampen*(m||1),v=r.clamp(c/r._baseDelta,0,1),C=u.length;for(l=0;l<C;l++)t=u[l],!(!t.isActive||t.isSensor)&&(o=t.collision,f=o.parentA,g=o.parentB,x=o.normal,t.separation=x.x*(g.positionImpulse.x+o.penetration.x-f.positionImpulse.x)+x.y*(g.positionImpulse.y+o.penetration.y-f.positionImpulse.y));for(l=0;l<C;l++)t=u[l],!(!t.isActive||t.isSensor)&&(o=t.collision,f=o.parentA,g=o.parentB,x=o.normal,E=t.separation-t.slop*v,(f.isStatic||g.isStatic)&&(E*=2),f.isStatic||f.isSleeping||(M=T/f.totalContacts,f.positionImpulse.x+=x.x*E*M,f.positionImpulse.y+=x.y*E*M),g.isStatic||g.isSleeping||(M=T/g.totalContacts,g.positionImpulse.x-=x.x*E*M,g.positionImpulse.y-=x.y*E*M))},e.postSolvePosition=function(u){for(var c=e._positionWarming,m=u.length,l=n.translate,t=a.update,o=0;o<m;o++){var f=u[o],g=f.positionImpulse,x=g.x,M=g.y,E=f.velocity;if(f.totalContacts=0,x!==0||M!==0){for(var T=0;T<f.parts.length;T++){var v=f.parts[T];l(v.vertices,g),t(v.bounds,v.vertices,E),v.position.x+=x,v.position.y+=M}f.positionPrev.x+=x,f.positionPrev.y+=M,x*E.x+M*E.y<0?(g.x=0,g.y=0):(g.x*=c,g.y*=c)}}},e.preSolveVelocity=function(u){var c=u.length,m,l;for(m=0;m<c;m++){var t=u[m];if(!(!t.isActive||t.isSensor)){var o=t.activeContacts,f=o.length,g=t.collision,x=g.parentA,M=g.parentB,E=g.normal,T=g.tangent;for(l=0;l<f;l++){var v=o[l],C=v.vertex,P=v.normalImpulse,S=v.tangentImpulse;if(P!==0||S!==0){var I=E.x*P+T.x*S,w=E.y*P+T.y*S;x.isStatic||x.isSleeping||(x.positionPrev.x+=I*x.inverseMass,x.positionPrev.y+=w*x.inverseMass,x.anglePrev+=x.inverseInertia*((C.x-x.position.x)*w-(C.y-x.position.y)*I)),M.isStatic||M.isSleeping||(M.positionPrev.x-=I*M.inverseMass,M.positionPrev.y-=w*M.inverseMass,M.anglePrev-=M.inverseInertia*((C.x-M.position.x)*w-(C.y-M.position.y)*I))}}}}},e.solveVelocity=function(u,c){var m=c/r._baseDelta,l=m*m,t=l*m,o=-e._restingThresh*m,f=e._restingThreshTangent,g=e._frictionNormalMultiplier*m,x=e._frictionMaxStatic,M=u.length,E,T,v,C;for(v=0;v<M;v++){var P=u[v];if(!(!P.isActive||P.isSensor)){var S=P.collision,I=S.parentA,w=S.parentB,b=I.velocity,A=w.velocity,D=S.normal.x,O=S.normal.y,R=S.tangent.x,z=S.tangent.y,N=P.activeContacts,H=N.length,q=1/H,J=I.inverseMass+w.inverseMass,_=P.friction*P.frictionStatic*g;for(b.x=I.position.x-I.positionPrev.x,b.y=I.position.y-I.positionPrev.y,A.x=w.position.x-w.positionPrev.x,A.y=w.position.y-w.positionPrev.y,I.angularVelocity=I.angle-I.anglePrev,w.angularVelocity=w.angle-w.anglePrev,C=0;C<H;C++){var $=N[C],K=$.vertex,Y=K.x-I.position.x,ne=K.y-I.position.y,Z=K.x-w.position.x,ie=K.y-w.position.y,ee=b.x-ne*I.angularVelocity,He=b.y+Y*I.angularVelocity,$e=A.x-ie*w.angularVelocity,Ve=A.y+Z*w.angularVelocity,Ie=ee-$e,Ee=He-Ve,Pe=D*Ie+O*Ee,ae=R*Ie+z*Ee,Te=P.separation+Pe,Me=Math.min(Te,1);Me=Te<0?0:Me;var Be=Me*_;ae<-Be||ae>Be?(T=ae>0?ae:-ae,E=P.friction*(ae>0?1:-1)*t,E<-T?E=-T:E>T&&(E=T)):(E=ae,T=x);var Ae=Y*O-ne*D,be=Z*O-ie*D,Le=q/(J+I.inverseInertia*Ae*Ae+w.inverseInertia*be*be),ge=(1+P.restitution)*Pe*Le;if(E*=Le,Pe<o)$.normalImpulse=0;else{var Ue=$.normalImpulse;$.normalImpulse+=ge,$.normalImpulse>0&&($.normalImpulse=0),ge=$.normalImpulse-Ue}if(ae<-f||ae>f)$.tangentImpulse=0;else{var Ge=$.tangentImpulse;$.tangentImpulse+=E,$.tangentImpulse<-T&&($.tangentImpulse=-T),$.tangentImpulse>T&&($.tangentImpulse=T),E=$.tangentImpulse-Ge}var pe=D*ge+R*E,ve=O*ge+z*E;I.isStatic||I.isSleeping||(I.positionPrev.x+=pe*I.inverseMass,I.positionPrev.y+=ve*I.inverseMass,I.anglePrev+=(Y*ve-ne*pe)*I.inverseInertia),w.isStatic||w.isSleeping||(w.positionPrev.x-=pe*w.inverseMass,w.positionPrev.y-=ve*w.inverseMass,w.anglePrev-=(Z*ve-ie*pe)*w.inverseInertia)}}}}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(9),r=s(0);(function(){e.create=function(a){return r.extend({table:{},list:[],collisionStart:[],collisionActive:[],collisionEnd:[]},a)},e.update=function(a,u,c){var m=a.list,l=m.length,t=a.table,o=u.length,f=a.collisionStart,g=a.collisionEnd,x=a.collisionActive,M,E,T,v;for(f.length=0,g.length=0,x.length=0,v=0;v<l;v++)m[v].confirmedActive=!1;for(v=0;v<o;v++)M=u[v],T=M.pair,T?(T.isActive?x.push(T):f.push(T),n.update(T,M,c),T.confirmedActive=!0):(T=n.create(M,c),t[T.id]=T,f.push(T),m.push(T));var C=[];for(l=m.length,v=0;v<l;v++)T=m[v],T.confirmedActive||(n.setActive(T,!1,c),g.push(T),!T.collision.bodyA.isSleeping&&!T.collision.bodyB.isSleeping&&C.push(v));for(v=0;v<C.length;v++)E=C[v]-v,T=m[E],m.splice(E,1),delete t[T.id]},e.clear=function(a){return a.table={},a.list.length=0,a.collisionStart.length=0,a.collisionActive.length=0,a.collisionEnd.length=0,a}})()}),(function(d,p,s){var e=d.exports=s(21);e.Axes=s(11),e.Bodies=s(12),e.Body=s(4),e.Bounds=s(1),e.Collision=s(8),e.Common=s(0),e.Composite=s(6),e.Composites=s(22),e.Constraint=s(10),e.Contact=s(16),e.Detector=s(13),e.Engine=s(17),e.Events=s(5),e.Grid=s(23),e.Mouse=s(14),e.MouseConstraint=s(24),e.Pair=s(9),e.Pairs=s(19),e.Plugin=s(15),e.Query=s(25),e.Render=s(26),e.Resolver=s(18),e.Runner=s(27),e.SAT=s(28),e.Sleeping=s(7),e.Svg=s(29),e.Vector=s(2),e.Vertices=s(3),e.World=s(30),e.Engine.run=e.Runner.run,e.Common.deprecated(e.Engine,"run","Engine.run âž¤ use Matter.Runner.run(engine) instead")}),(function(d,p,s){var e={};d.exports=e;var n=s(15),r=s(0);(function(){e.name="matter-js",e.version="0.19.0",e.uses=[],e.used=[],e.use=function(){n.use(e,Array.prototype.slice.call(arguments))},e.before=function(a,u){return a=a.replace(/^Matter./,""),r.chainPathBefore(e,a,u)},e.after=function(a,u){return a=a.replace(/^Matter./,""),r.chainPathAfter(e,a,u)}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(6),r=s(10),a=s(0),u=s(4),c=s(12),m=a.deprecated;(function(){e.stack=function(l,t,o,f,g,x,M){for(var E=n.create({label:"Stack"}),T=l,v=t,C,P=0,S=0;S<f;S++){for(var I=0,w=0;w<o;w++){var b=M(T,v,w,S,C,P);if(b){var A=b.bounds.max.y-b.bounds.min.y,D=b.bounds.max.x-b.bounds.min.x;A>I&&(I=A),u.translate(b,{x:D*.5,y:A*.5}),T=b.bounds.max.x+g,n.addBody(E,b),C=b,P+=1}else T+=g}v+=I+x,T=l}return E},e.chain=function(l,t,o,f,g,x){for(var M=l.bodies,E=1;E<M.length;E++){var T=M[E-1],v=M[E],C=T.bounds.max.y-T.bounds.min.y,P=T.bounds.max.x-T.bounds.min.x,S=v.bounds.max.y-v.bounds.min.y,I=v.bounds.max.x-v.bounds.min.x,w={bodyA:T,pointA:{x:P*t,y:C*o},bodyB:v,pointB:{x:I*f,y:S*g}},b=a.extend(w,x);n.addConstraint(l,r.create(b))}return l.label+=" Chain",l},e.mesh=function(l,t,o,f,g){var x=l.bodies,M,E,T,v,C;for(M=0;M<o;M++){for(E=1;E<t;E++)T=x[E-1+M*t],v=x[E+M*t],n.addConstraint(l,r.create(a.extend({bodyA:T,bodyB:v},g)));if(M>0)for(E=0;E<t;E++)T=x[E+(M-1)*t],v=x[E+M*t],n.addConstraint(l,r.create(a.extend({bodyA:T,bodyB:v},g))),f&&E>0&&(C=x[E-1+(M-1)*t],n.addConstraint(l,r.create(a.extend({bodyA:C,bodyB:v},g)))),f&&E<t-1&&(C=x[E+1+(M-1)*t],n.addConstraint(l,r.create(a.extend({bodyA:C,bodyB:v},g))))}return l.label+=" Mesh",l},e.pyramid=function(l,t,o,f,g,x,M){return e.stack(l,t,o,f,g,x,function(E,T,v,C,P,S){var I=Math.min(f,Math.ceil(o/2)),w=P?P.bounds.max.x-P.bounds.min.x:0;if(!(C>I)){C=I-C;var b=C,A=o-1-C;if(!(v<b||v>A)){S===1&&u.translate(P,{x:(v+(o%2===1?1:-1))*w,y:0});var D=P?v*w:0;return M(l+D+v*g,T,v,C,P,S)}}})},e.newtonsCradle=function(l,t,o,f,g){for(var x=n.create({label:"Newtons Cradle"}),M=0;M<o;M++){var E=1.9,T=c.circle(l+M*(f*E),t+g,f,{inertia:1/0,restitution:1,friction:0,frictionAir:1e-4,slop:1}),v=r.create({pointA:{x:l+M*(f*E),y:t},bodyB:T});n.addBody(x,T),n.addConstraint(x,v)}return x},m(e,"newtonsCradle","Composites.newtonsCradle âž¤ moved to newtonsCradle example"),e.car=function(l,t,o,f,g){var x=u.nextGroup(!0),M=20,E=-o*.5+M,T=o*.5-M,v=0,C=n.create({label:"Car"}),P=c.rectangle(l,t,o,f,{collisionFilter:{group:x},chamfer:{radius:f*.5},density:2e-4}),S=c.circle(l+E,t+v,g,{collisionFilter:{group:x},friction:.8}),I=c.circle(l+T,t+v,g,{collisionFilter:{group:x},friction:.8}),w=r.create({bodyB:P,pointB:{x:E,y:v},bodyA:S,stiffness:1,length:0}),b=r.create({bodyB:P,pointB:{x:T,y:v},bodyA:I,stiffness:1,length:0});return n.addBody(C,P),n.addBody(C,S),n.addBody(C,I),n.addConstraint(C,w),n.addConstraint(C,b),C},m(e,"car","Composites.car âž¤ moved to car example"),e.softBody=function(l,t,o,f,g,x,M,E,T,v){T=a.extend({inertia:1/0},T),v=a.extend({stiffness:.2,render:{type:"line",anchors:!1}},v);var C=e.stack(l,t,o,f,g,x,function(P,S){return c.circle(P,S,E,T)});return e.mesh(C,o,f,M,v),C.label="Soft Body",C},m(e,"softBody","Composites.softBody âž¤ moved to softBody and cloth examples")})()}),(function(d,p,s){var e={};d.exports=e;var n=s(9),r=s(0),a=r.deprecated;(function(){e.create=function(u){var c={buckets:{},pairs:{},pairsList:[],bucketWidth:48,bucketHeight:48};return r.extend(c,u)},e.update=function(u,c,m,l){var t,o,f,g=m.world,x=u.buckets,M,E,T=!1;for(t=0;t<c.length;t++){var v=c[t];if(!(v.isSleeping&&!l)&&!(g.bounds&&(v.bounds.max.x<g.bounds.min.x||v.bounds.min.x>g.bounds.max.x||v.bounds.max.y<g.bounds.min.y||v.bounds.min.y>g.bounds.max.y))){var C=e._getRegion(u,v);if(!v.region||C.id!==v.region.id||l){(!v.region||l)&&(v.region=C);var P=e._regionUnion(C,v.region);for(o=P.startCol;o<=P.endCol;o++)for(f=P.startRow;f<=P.endRow;f++){E=e._getBucketId(o,f),M=x[E];var S=o>=C.startCol&&o<=C.endCol&&f>=C.startRow&&f<=C.endRow,I=o>=v.region.startCol&&o<=v.region.endCol&&f>=v.region.startRow&&f<=v.region.endRow;!S&&I&&I&&M&&e._bucketRemoveBody(u,M,v),(v.region===C||S&&!I||l)&&(M||(M=e._createBucket(x,E)),e._bucketAddBody(u,M,v))}v.region=C,T=!0}}}T&&(u.pairsList=e._createActivePairsList(u))},a(e,"update","Grid.update âž¤ replaced by Matter.Detector"),e.clear=function(u){u.buckets={},u.pairs={},u.pairsList=[]},a(e,"clear","Grid.clear âž¤ replaced by Matter.Detector"),e._regionUnion=function(u,c){var m=Math.min(u.startCol,c.startCol),l=Math.max(u.endCol,c.endCol),t=Math.min(u.startRow,c.startRow),o=Math.max(u.endRow,c.endRow);return e._createRegion(m,l,t,o)},e._getRegion=function(u,c){var m=c.bounds,l=Math.floor(m.min.x/u.bucketWidth),t=Math.floor(m.max.x/u.bucketWidth),o=Math.floor(m.min.y/u.bucketHeight),f=Math.floor(m.max.y/u.bucketHeight);return e._createRegion(l,t,o,f)},e._createRegion=function(u,c,m,l){return{id:u+","+c+","+m+","+l,startCol:u,endCol:c,startRow:m,endRow:l}},e._getBucketId=function(u,c){return"C"+u+"R"+c},e._createBucket=function(u,c){var m=u[c]=[];return m},e._bucketAddBody=function(u,c,m){var l=u.pairs,t=n.id,o=c.length,f;for(f=0;f<o;f++){var g=c[f];if(!(m.id===g.id||m.isStatic&&g.isStatic)){var x=t(m,g),M=l[x];M?M[2]+=1:l[x]=[m,g,1]}}c.push(m)},e._bucketRemoveBody=function(u,c,m){var l=u.pairs,t=n.id,o;c.splice(r.indexOf(c,m),1);var f=c.length;for(o=0;o<f;o++){var g=l[t(m,c[o])];g&&(g[2]-=1)}},e._createActivePairsList=function(u){var c,m=u.pairs,l=r.keys(m),t=l.length,o=[],f;for(f=0;f<t;f++)c=m[l[f]],c[2]>0?o.push(c):delete m[l[f]];return o}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(3),r=s(7),a=s(14),u=s(5),c=s(13),m=s(10),l=s(6),t=s(0),o=s(1);(function(){e.create=function(f,g){var x=(f?f.mouse:null)||(g?g.mouse:null);x||(f&&f.render&&f.render.canvas?x=a.create(f.render.canvas):g&&g.element?x=a.create(g.element):(x=a.create(),t.warn("MouseConstraint.create: options.mouse was undefined, options.element was undefined, may not function as expected")));var M=m.create({label:"Mouse Constraint",pointA:x.position,pointB:{x:0,y:0},length:.01,stiffness:.1,angularStiffness:1,render:{strokeStyle:"#90EE90",lineWidth:3}}),E={type:"mouseConstraint",mouse:x,element:null,body:null,constraint:M,collisionFilter:{category:1,mask:4294967295,group:0}},T=t.extend(E,g);return u.on(f,"beforeUpdate",function(){var v=l.allBodies(f.world);e.update(T,v),e._triggerEvents(T)}),T},e.update=function(f,g){var x=f.mouse,M=f.constraint,E=f.body;if(x.button===0){if(M.bodyB)r.set(M.bodyB,!1),M.pointA=x.position;else for(var T=0;T<g.length;T++)if(E=g[T],o.contains(E.bounds,x.position)&&c.canCollide(E.collisionFilter,f.collisionFilter))for(var v=E.parts.length>1?1:0;v<E.parts.length;v++){var C=E.parts[v];if(n.contains(C.vertices,x.position)){M.pointA=x.position,M.bodyB=f.body=E,M.pointB={x:x.position.x-E.position.x,y:x.position.y-E.position.y},M.angleB=E.angle,r.set(E,!1),u.trigger(f,"startdrag",{mouse:x,body:E});break}}}else M.bodyB=f.body=null,M.pointB=null,E&&u.trigger(f,"enddrag",{mouse:x,body:E})},e._triggerEvents=function(f){var g=f.mouse,x=g.sourceEvents;x.mousemove&&u.trigger(f,"mousemove",{mouse:g}),x.mousedown&&u.trigger(f,"mousedown",{mouse:g}),x.mouseup&&u.trigger(f,"mouseup",{mouse:g}),a.clearSourceEvents(g)}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(2),r=s(8),a=s(1),u=s(12),c=s(3);(function(){e.collides=function(m,l){for(var t=[],o=l.length,f=m.bounds,g=r.collides,x=a.overlaps,M=0;M<o;M++){var E=l[M],T=E.parts.length,v=T===1?0:1;if(x(E.bounds,f))for(var C=v;C<T;C++){var P=E.parts[C];if(x(P.bounds,f)){var S=g(P,m);if(S){t.push(S);break}}}}return t},e.ray=function(m,l,t,o){o=o||1e-100;for(var f=n.angle(l,t),g=n.magnitude(n.sub(l,t)),x=(t.x+l.x)*.5,M=(t.y+l.y)*.5,E=u.rectangle(x,M,g,o,{angle:f}),T=e.collides(E,m),v=0;v<T.length;v+=1){var C=T[v];C.body=C.bodyB=C.bodyA}return T},e.region=function(m,l,t){for(var o=[],f=0;f<m.length;f++){var g=m[f],x=a.overlaps(g.bounds,l);(x&&!t||!x&&t)&&o.push(g)}return o},e.point=function(m,l){for(var t=[],o=0;o<m.length;o++){var f=m[o];if(a.contains(f.bounds,l))for(var g=f.parts.length===1?0:1;g<f.parts.length;g++){var x=f.parts[g];if(a.contains(x.bounds,l)&&c.contains(x.vertices,l)){t.push(f);break}}}return t}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(4),r=s(0),a=s(6),u=s(1),c=s(5),m=s(2),l=s(14);(function(){var t,o;typeof window<"u"&&(t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(v){window.setTimeout(function(){v(r.now())},1e3/60)},o=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame),e._goodFps=30,e._goodDelta=1e3/60,e.create=function(v){var C={engine:null,element:null,canvas:null,mouse:null,frameRequestId:null,timing:{historySize:60,delta:0,deltaHistory:[],lastTime:0,lastTimestamp:0,lastElapsed:0,timestampElapsed:0,timestampElapsedHistory:[],engineDeltaHistory:[],engineElapsedHistory:[],elapsedHistory:[]},options:{width:800,height:600,pixelRatio:1,background:"#14151f",wireframeBackground:"#14151f",hasBounds:!!v.bounds,enabled:!0,wireframes:!0,showSleeping:!0,showDebug:!1,showStats:!1,showPerformance:!1,showBounds:!1,showVelocity:!1,showCollisions:!1,showSeparations:!1,showAxes:!1,showPositions:!1,showAngleIndicator:!1,showIds:!1,showVertexNumbers:!1,showConvexHulls:!1,showInternalEdges:!1,showMousePosition:!1}},P=r.extend(C,v);return P.canvas&&(P.canvas.width=P.options.width||P.canvas.width,P.canvas.height=P.options.height||P.canvas.height),P.mouse=v.mouse,P.engine=v.engine,P.canvas=P.canvas||x(P.options.width,P.options.height),P.context=P.canvas.getContext("2d"),P.textures={},P.bounds=P.bounds||{min:{x:0,y:0},max:{x:P.canvas.width,y:P.canvas.height}},P.controller=e,P.options.showBroadphase=!1,P.options.pixelRatio!==1&&e.setPixelRatio(P,P.options.pixelRatio),r.isElement(P.element)&&P.element.appendChild(P.canvas),P},e.run=function(v){(function C(P){v.frameRequestId=t(C),f(v,P),e.world(v,P),(v.options.showStats||v.options.showDebug)&&e.stats(v,v.context,P),(v.options.showPerformance||v.options.showDebug)&&e.performance(v,v.context,P)})()},e.stop=function(v){o(v.frameRequestId)},e.setPixelRatio=function(v,C){var P=v.options,S=v.canvas;C==="auto"&&(C=M(S)),P.pixelRatio=C,S.setAttribute("data-pixel-ratio",C),S.width=P.width*C,S.height=P.height*C,S.style.width=P.width+"px",S.style.height=P.height+"px"},e.lookAt=function(v,C,P,S){S=typeof S<"u"?S:!0,C=r.isArray(C)?C:[C],P=P||{x:0,y:0};for(var I={min:{x:1/0,y:1/0},max:{x:-1/0,y:-1/0}},w=0;w<C.length;w+=1){var b=C[w],A=b.bounds?b.bounds.min:b.min||b.position||b,D=b.bounds?b.bounds.max:b.max||b.position||b;A&&D&&(A.x<I.min.x&&(I.min.x=A.x),D.x>I.max.x&&(I.max.x=D.x),A.y<I.min.y&&(I.min.y=A.y),D.y>I.max.y&&(I.max.y=D.y))}var O=I.max.x-I.min.x+2*P.x,R=I.max.y-I.min.y+2*P.y,z=v.canvas.height,N=v.canvas.width,H=N/z,q=O/R,J=1,_=1;q>H?_=q/H:J=H/q,v.options.hasBounds=!0,v.bounds.min.x=I.min.x,v.bounds.max.x=I.min.x+O*J,v.bounds.min.y=I.min.y,v.bounds.max.y=I.min.y+R*_,S&&(v.bounds.min.x+=O*.5-O*J*.5,v.bounds.max.x+=O*.5-O*J*.5,v.bounds.min.y+=R*.5-R*_*.5,v.bounds.max.y+=R*.5-R*_*.5),v.bounds.min.x-=P.x,v.bounds.max.x-=P.x,v.bounds.min.y-=P.y,v.bounds.max.y-=P.y,v.mouse&&(l.setScale(v.mouse,{x:(v.bounds.max.x-v.bounds.min.x)/v.canvas.width,y:(v.bounds.max.y-v.bounds.min.y)/v.canvas.height}),l.setOffset(v.mouse,v.bounds.min))},e.startViewTransform=function(v){var C=v.bounds.max.x-v.bounds.min.x,P=v.bounds.max.y-v.bounds.min.y,S=C/v.options.width,I=P/v.options.height;v.context.setTransform(v.options.pixelRatio/S,0,0,v.options.pixelRatio/I,0,0),v.context.translate(-v.bounds.min.x,-v.bounds.min.y)},e.endViewTransform=function(v){v.context.setTransform(v.options.pixelRatio,0,0,v.options.pixelRatio,0,0)},e.world=function(v,C){var P=r.now(),S=v.engine,I=S.world,w=v.canvas,b=v.context,A=v.options,D=v.timing,O=a.allBodies(I),R=a.allConstraints(I),z=A.wireframes?A.wireframeBackground:A.background,N=[],H=[],q,J={timestamp:S.timing.timestamp};if(c.trigger(v,"beforeRender",J),v.currentBackground!==z&&T(v,z),b.globalCompositeOperation="source-in",b.fillStyle="transparent",b.fillRect(0,0,w.width,w.height),b.globalCompositeOperation="source-over",A.hasBounds){for(q=0;q<O.length;q++){var _=O[q];u.overlaps(_.bounds,v.bounds)&&N.push(_)}for(q=0;q<R.length;q++){var $=R[q],K=$.bodyA,Y=$.bodyB,ne=$.pointA,Z=$.pointB;K&&(ne=m.add(K.position,$.pointA)),Y&&(Z=m.add(Y.position,$.pointB)),!(!ne||!Z)&&(u.contains(v.bounds,ne)||u.contains(v.bounds,Z))&&H.push($)}e.startViewTransform(v),v.mouse&&(l.setScale(v.mouse,{x:(v.bounds.max.x-v.bounds.min.x)/v.options.width,y:(v.bounds.max.y-v.bounds.min.y)/v.options.height}),l.setOffset(v.mouse,v.bounds.min))}else H=R,N=O,v.options.pixelRatio!==1&&v.context.setTransform(v.options.pixelRatio,0,0,v.options.pixelRatio,0,0);!A.wireframes||S.enableSleeping&&A.showSleeping?e.bodies(v,N,b):(A.showConvexHulls&&e.bodyConvexHulls(v,N,b),e.bodyWireframes(v,N,b)),A.showBounds&&e.bodyBounds(v,N,b),(A.showAxes||A.showAngleIndicator)&&e.bodyAxes(v,N,b),A.showPositions&&e.bodyPositions(v,N,b),A.showVelocity&&e.bodyVelocity(v,N,b),A.showIds&&e.bodyIds(v,N,b),A.showSeparations&&e.separations(v,S.pairs.list,b),A.showCollisions&&e.collisions(v,S.pairs.list,b),A.showVertexNumbers&&e.vertexNumbers(v,N,b),A.showMousePosition&&e.mousePosition(v,v.mouse,b),e.constraints(H,b),A.hasBounds&&e.endViewTransform(v),c.trigger(v,"afterRender",J),D.lastElapsed=r.now()-P},e.stats=function(v,C,P){for(var S=v.engine,I=S.world,w=a.allBodies(I),b=0,A=55,D=44,O=0,R=0,z=0;z<w.length;z+=1)b+=w[z].parts.length;var N={Part:b,Body:w.length,Cons:a.allConstraints(I).length,Comp:a.allComposites(I).length,Pair:S.pairs.list.length};C.fillStyle="#0e0f19",C.fillRect(O,R,A*5.5,D),C.font="12px Arial",C.textBaseline="top",C.textAlign="right";for(var H in N){var q=N[H];C.fillStyle="#aaa",C.fillText(H,O+A,R+8),C.fillStyle="#eee",C.fillText(q,O+A,R+26),O+=A}},e.performance=function(v,C){var P=v.engine,S=v.timing,I=S.deltaHistory,w=S.elapsedHistory,b=S.timestampElapsedHistory,A=S.engineDeltaHistory,D=S.engineElapsedHistory,O=P.timing.lastDelta,R=g(I),z=g(w),N=g(A),H=g(D),q=g(b),J=q/R||0,_=1e3/R||0,$=4,K=12,Y=60,ne=34,Z=10,ie=69;C.fillStyle="#0e0f19",C.fillRect(0,50,K*4+Y*5+22,ne),e.status(C,Z,ie,Y,$,I.length,Math.round(_)+" fps",_/e._goodFps,function(ee){return I[ee]/R-1}),e.status(C,Z+K+Y,ie,Y,$,A.length,O.toFixed(2)+" dt",e._goodDelta/O,function(ee){return A[ee]/N-1}),e.status(C,Z+(K+Y)*2,ie,Y,$,D.length,H.toFixed(2)+" ut",1-H/e._goodFps,function(ee){return D[ee]/H-1}),e.status(C,Z+(K+Y)*3,ie,Y,$,w.length,z.toFixed(2)+" rt",1-z/e._goodFps,function(ee){return w[ee]/z-1}),e.status(C,Z+(K+Y)*4,ie,Y,$,b.length,J.toFixed(2)+" x",J*J*J,function(ee){return(b[ee]/I[ee]/J||0)-1})},e.status=function(v,C,P,S,I,w,b,A,D){v.strokeStyle="#888",v.fillStyle="#444",v.lineWidth=1,v.fillRect(C,P+7,S,1),v.beginPath(),v.moveTo(C,P+7-I*r.clamp(.4*D(0),-2,2));for(var O=0;O<S;O+=1)v.lineTo(C+O,P+7-(O<w?I*r.clamp(.4*D(O),-2,2):0));v.stroke(),v.fillStyle="hsl("+r.clamp(25+95*A,0,120)+",100%,60%)",v.fillRect(C,P-7,4,4),v.font="12px Arial",v.textBaseline="middle",v.textAlign="right",v.fillStyle="#eee",v.fillText(b,C+S,P-5)},e.constraints=function(v,C){for(var P=C,S=0;S<v.length;S++){var I=v[S];if(!(!I.render.visible||!I.pointA||!I.pointB)){var w=I.bodyA,b=I.bodyB,A,D;if(w?A=m.add(w.position,I.pointA):A=I.pointA,I.render.type==="pin")P.beginPath(),P.arc(A.x,A.y,3,0,2*Math.PI),P.closePath();else{if(b?D=m.add(b.position,I.pointB):D=I.pointB,P.beginPath(),P.moveTo(A.x,A.y),I.render.type==="spring")for(var O=m.sub(D,A),R=m.perp(m.normalise(O)),z=Math.ceil(r.clamp(I.length/5,12,20)),N,H=1;H<z;H+=1)N=H%2===0?1:-1,P.lineTo(A.x+O.x*(H/z)+R.x*N*4,A.y+O.y*(H/z)+R.y*N*4);P.lineTo(D.x,D.y)}I.render.lineWidth&&(P.lineWidth=I.render.lineWidth,P.strokeStyle=I.render.strokeStyle,P.stroke()),I.render.anchors&&(P.fillStyle=I.render.strokeStyle,P.beginPath(),P.arc(A.x,A.y,3,0,2*Math.PI),P.arc(D.x,D.y,3,0,2*Math.PI),P.closePath(),P.fill())}}},e.bodies=function(v,C,P){var S=P;v.engine;var I=v.options,w=I.showInternalEdges||!I.wireframes,b,A,D,O;for(D=0;D<C.length;D++)if(b=C[D],!!b.render.visible){for(O=b.parts.length>1?1:0;O<b.parts.length;O++)if(A=b.parts[O],!!A.render.visible){if(I.showSleeping&&b.isSleeping?S.globalAlpha=.5*A.render.opacity:A.render.opacity!==1&&(S.globalAlpha=A.render.opacity),A.render.sprite&&A.render.sprite.texture&&!I.wireframes){var R=A.render.sprite,z=E(v,R.texture);S.translate(A.position.x,A.position.y),S.rotate(A.angle),S.drawImage(z,z.width*-R.xOffset*R.xScale,z.height*-R.yOffset*R.yScale,z.width*R.xScale,z.height*R.yScale),S.rotate(-A.angle),S.translate(-A.position.x,-A.position.y)}else{if(A.circleRadius)S.beginPath(),S.arc(A.position.x,A.position.y,A.circleRadius,0,2*Math.PI);else{S.beginPath(),S.moveTo(A.vertices[0].x,A.vertices[0].y);for(var N=1;N<A.vertices.length;N++)!A.vertices[N-1].isInternal||w?S.lineTo(A.vertices[N].x,A.vertices[N].y):S.moveTo(A.vertices[N].x,A.vertices[N].y),A.vertices[N].isInternal&&!w&&S.moveTo(A.vertices[(N+1)%A.vertices.length].x,A.vertices[(N+1)%A.vertices.length].y);S.lineTo(A.vertices[0].x,A.vertices[0].y),S.closePath()}I.wireframes?(S.lineWidth=1,S.strokeStyle="#bbb",S.stroke()):(S.fillStyle=A.render.fillStyle,A.render.lineWidth&&(S.lineWidth=A.render.lineWidth,S.strokeStyle=A.render.strokeStyle,S.stroke()),S.fill())}S.globalAlpha=1}}},e.bodyWireframes=function(v,C,P){var S=P,I=v.options.showInternalEdges,w,b,A,D,O;for(S.beginPath(),A=0;A<C.length;A++)if(w=C[A],!!w.render.visible)for(O=w.parts.length>1?1:0;O<w.parts.length;O++){for(b=w.parts[O],S.moveTo(b.vertices[0].x,b.vertices[0].y),D=1;D<b.vertices.length;D++)!b.vertices[D-1].isInternal||I?S.lineTo(b.vertices[D].x,b.vertices[D].y):S.moveTo(b.vertices[D].x,b.vertices[D].y),b.vertices[D].isInternal&&!I&&S.moveTo(b.vertices[(D+1)%b.vertices.length].x,b.vertices[(D+1)%b.vertices.length].y);S.lineTo(b.vertices[0].x,b.vertices[0].y)}S.lineWidth=1,S.strokeStyle="#bbb",S.stroke()},e.bodyConvexHulls=function(v,C,P){var S=P,I,w,b;for(S.beginPath(),w=0;w<C.length;w++)if(I=C[w],!(!I.render.visible||I.parts.length===1)){for(S.moveTo(I.vertices[0].x,I.vertices[0].y),b=1;b<I.vertices.length;b++)S.lineTo(I.vertices[b].x,I.vertices[b].y);S.lineTo(I.vertices[0].x,I.vertices[0].y)}S.lineWidth=1,S.strokeStyle="rgba(255,255,255,0.2)",S.stroke()},e.vertexNumbers=function(v,C,P){var S=P,I,w,b;for(I=0;I<C.length;I++){var A=C[I].parts;for(b=A.length>1?1:0;b<A.length;b++){var D=A[b];for(w=0;w<D.vertices.length;w++)S.fillStyle="rgba(255,255,255,0.2)",S.fillText(I+"_"+w,D.position.x+(D.vertices[w].x-D.position.x)*.8,D.position.y+(D.vertices[w].y-D.position.y)*.8)}}},e.mousePosition=function(v,C,P){var S=P;S.fillStyle="rgba(255,255,255,0.8)",S.fillText(C.position.x+"  "+C.position.y,C.position.x+5,C.position.y-5)},e.bodyBounds=function(v,C,P){var S=P;v.engine;var I=v.options;S.beginPath();for(var w=0;w<C.length;w++){var b=C[w];if(b.render.visible)for(var A=C[w].parts,D=A.length>1?1:0;D<A.length;D++){var O=A[D];S.rect(O.bounds.min.x,O.bounds.min.y,O.bounds.max.x-O.bounds.min.x,O.bounds.max.y-O.bounds.min.y)}}I.wireframes?S.strokeStyle="rgba(255,255,255,0.08)":S.strokeStyle="rgba(0,0,0,0.1)",S.lineWidth=1,S.stroke()},e.bodyAxes=function(v,C,P){var S=P;v.engine;var I=v.options,w,b,A,D;for(S.beginPath(),b=0;b<C.length;b++){var O=C[b],R=O.parts;if(O.render.visible)if(I.showAxes)for(A=R.length>1?1:0;A<R.length;A++)for(w=R[A],D=0;D<w.axes.length;D++){var z=w.axes[D];S.moveTo(w.position.x,w.position.y),S.lineTo(w.position.x+z.x*20,w.position.y+z.y*20)}else for(A=R.length>1?1:0;A<R.length;A++)for(w=R[A],D=0;D<w.axes.length;D++)S.moveTo(w.position.x,w.position.y),S.lineTo((w.vertices[0].x+w.vertices[w.vertices.length-1].x)/2,(w.vertices[0].y+w.vertices[w.vertices.length-1].y)/2)}I.wireframes?(S.strokeStyle="indianred",S.lineWidth=1):(S.strokeStyle="rgba(255, 255, 255, 0.4)",S.globalCompositeOperation="overlay",S.lineWidth=2),S.stroke(),S.globalCompositeOperation="source-over"},e.bodyPositions=function(v,C,P){var S=P;v.engine;var I=v.options,w,b,A,D;for(S.beginPath(),A=0;A<C.length;A++)if(w=C[A],!!w.render.visible)for(D=0;D<w.parts.length;D++)b=w.parts[D],S.arc(b.position.x,b.position.y,3,0,2*Math.PI,!1),S.closePath();for(I.wireframes?S.fillStyle="indianred":S.fillStyle="rgba(0,0,0,0.5)",S.fill(),S.beginPath(),A=0;A<C.length;A++)w=C[A],w.render.visible&&(S.arc(w.positionPrev.x,w.positionPrev.y,2,0,2*Math.PI,!1),S.closePath());S.fillStyle="rgba(255,165,0,0.8)",S.fill()},e.bodyVelocity=function(v,C,P){var S=P;S.beginPath();for(var I=0;I<C.length;I++){var w=C[I];if(w.render.visible){var b=n.getVelocity(w);S.moveTo(w.position.x,w.position.y),S.lineTo(w.position.x+b.x,w.position.y+b.y)}}S.lineWidth=3,S.strokeStyle="cornflowerblue",S.stroke()},e.bodyIds=function(v,C,P){var S=P,I,w;for(I=0;I<C.length;I++)if(C[I].render.visible){var b=C[I].parts;for(w=b.length>1?1:0;w<b.length;w++){var A=b[w];S.font="12px Arial",S.fillStyle="rgba(255,255,255,0.5)",S.fillText(A.id,A.position.x+10,A.position.y-10)}}},e.collisions=function(v,C,P){var S=P,I=v.options,w,b,A,D;for(S.beginPath(),A=0;A<C.length;A++)if(w=C[A],!!w.isActive)for(b=w.collision,D=0;D<w.activeContacts.length;D++){var O=w.activeContacts[D],R=O.vertex;S.rect(R.x-1.5,R.y-1.5,3.5,3.5)}for(I.wireframes?S.fillStyle="rgba(255,255,255,0.7)":S.fillStyle="orange",S.fill(),S.beginPath(),A=0;A<C.length;A++)if(w=C[A],!!w.isActive&&(b=w.collision,w.activeContacts.length>0)){var z=w.activeContacts[0].vertex.x,N=w.activeContacts[0].vertex.y;w.activeContacts.length===2&&(z=(w.activeContacts[0].vertex.x+w.activeContacts[1].vertex.x)/2,N=(w.activeContacts[0].vertex.y+w.activeContacts[1].vertex.y)/2),b.bodyB===b.supports[0].body||b.bodyA.isStatic===!0?S.moveTo(z-b.normal.x*8,N-b.normal.y*8):S.moveTo(z+b.normal.x*8,N+b.normal.y*8),S.lineTo(z,N)}I.wireframes?S.strokeStyle="rgba(255,165,0,0.7)":S.strokeStyle="orange",S.lineWidth=1,S.stroke()},e.separations=function(v,C,P){var S=P,I=v.options,w,b,A,D,O;for(S.beginPath(),O=0;O<C.length;O++)if(w=C[O],!!w.isActive){b=w.collision,A=b.bodyA,D=b.bodyB;var R=1;!D.isStatic&&!A.isStatic&&(R=.5),D.isStatic&&(R=0),S.moveTo(D.position.x,D.position.y),S.lineTo(D.position.x-b.penetration.x*R,D.position.y-b.penetration.y*R),R=1,!D.isStatic&&!A.isStatic&&(R=.5),A.isStatic&&(R=0),S.moveTo(A.position.x,A.position.y),S.lineTo(A.position.x+b.penetration.x*R,A.position.y+b.penetration.y*R)}I.wireframes?S.strokeStyle="rgba(255,165,0,0.5)":S.strokeStyle="orange",S.stroke()},e.inspector=function(v,C){v.engine;var P=v.selected,S=v.render,I=S.options,w;if(I.hasBounds){var b=S.bounds.max.x-S.bounds.min.x,A=S.bounds.max.y-S.bounds.min.y,D=b/S.options.width,O=A/S.options.height;C.scale(1/D,1/O),C.translate(-S.bounds.min.x,-S.bounds.min.y)}for(var R=0;R<P.length;R++){var z=P[R].data;switch(C.translate(.5,.5),C.lineWidth=1,C.strokeStyle="rgba(255,165,0,0.9)",C.setLineDash([1,2]),z.type){case"body":w=z.bounds,C.beginPath(),C.rect(Math.floor(w.min.x-3),Math.floor(w.min.y-3),Math.floor(w.max.x-w.min.x+6),Math.floor(w.max.y-w.min.y+6)),C.closePath(),C.stroke();break;case"constraint":var N=z.pointA;z.bodyA&&(N=z.pointB),C.beginPath(),C.arc(N.x,N.y,10,0,2*Math.PI),C.closePath(),C.stroke();break}C.setLineDash([]),C.translate(-.5,-.5)}v.selectStart!==null&&(C.translate(.5,.5),C.lineWidth=1,C.strokeStyle="rgba(255,165,0,0.6)",C.fillStyle="rgba(255,165,0,0.1)",w=v.selectBounds,C.beginPath(),C.rect(Math.floor(w.min.x),Math.floor(w.min.y),Math.floor(w.max.x-w.min.x),Math.floor(w.max.y-w.min.y)),C.closePath(),C.stroke(),C.fill(),C.translate(-.5,-.5)),I.hasBounds&&C.setTransform(1,0,0,1,0,0)};var f=function(v,C){var P=v.engine,S=v.timing,I=S.historySize,w=P.timing.timestamp;S.delta=C-S.lastTime||e._goodDelta,S.lastTime=C,S.timestampElapsed=w-S.lastTimestamp||0,S.lastTimestamp=w,S.deltaHistory.unshift(S.delta),S.deltaHistory.length=Math.min(S.deltaHistory.length,I),S.engineDeltaHistory.unshift(P.timing.lastDelta),S.engineDeltaHistory.length=Math.min(S.engineDeltaHistory.length,I),S.timestampElapsedHistory.unshift(S.timestampElapsed),S.timestampElapsedHistory.length=Math.min(S.timestampElapsedHistory.length,I),S.engineElapsedHistory.unshift(P.timing.lastElapsed),S.engineElapsedHistory.length=Math.min(S.engineElapsedHistory.length,I),S.elapsedHistory.unshift(S.lastElapsed),S.elapsedHistory.length=Math.min(S.elapsedHistory.length,I)},g=function(v){for(var C=0,P=0;P<v.length;P+=1)C+=v[P];return C/v.length||0},x=function(v,C){var P=document.createElement("canvas");return P.width=v,P.height=C,P.oncontextmenu=function(){return!1},P.onselectstart=function(){return!1},P},M=function(v){var C=v.getContext("2d"),P=window.devicePixelRatio||1,S=C.webkitBackingStorePixelRatio||C.mozBackingStorePixelRatio||C.msBackingStorePixelRatio||C.oBackingStorePixelRatio||C.backingStorePixelRatio||1;return P/S},E=function(v,C){var P=v.textures[C];return P||(P=v.textures[C]=new Image,P.src=C,P)},T=function(v,C){var P=C;/(jpg|gif|png)$/.test(C)&&(P="url("+C+")"),v.canvas.style.background=P,v.canvas.style.backgroundSize="contain",v.currentBackground=C}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(5),r=s(17),a=s(0);(function(){var u,c;if(typeof window<"u"&&(u=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame,c=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.msCancelAnimationFrame),!u){var m;u=function(l){m=setTimeout(function(){l(a.now())},1e3/60)},c=function(){clearTimeout(m)}}e.create=function(l){var t={fps:60,deltaSampleSize:60,counterTimestamp:0,frameCounter:0,deltaHistory:[],timePrev:null,frameRequestId:null,isFixed:!1,enabled:!0},o=a.extend(t,l);return o.delta=o.delta||1e3/o.fps,o.deltaMin=o.deltaMin||1e3/o.fps,o.deltaMax=o.deltaMax||1e3/(o.fps*.5),o.fps=1e3/o.delta,o},e.run=function(l,t){return typeof l.positionIterations<"u"&&(t=l,l=e.create()),(function o(f){l.frameRequestId=u(o),f&&l.enabled&&e.tick(l,t,f)})(),l},e.tick=function(l,t,o){var f=t.timing,g;l.isFixed?g=l.delta:(g=o-l.timePrev||l.delta,l.timePrev=o,l.deltaHistory.push(g),l.deltaHistory=l.deltaHistory.slice(-l.deltaSampleSize),g=Math.min.apply(null,l.deltaHistory),g=g<l.deltaMin?l.deltaMin:g,g=g>l.deltaMax?l.deltaMax:g,l.delta=g);var x={timestamp:f.timestamp};n.trigger(l,"beforeTick",x),l.frameCounter+=1,o-l.counterTimestamp>=1e3&&(l.fps=l.frameCounter*((o-l.counterTimestamp)/1e3),l.counterTimestamp=o,l.frameCounter=0),n.trigger(l,"tick",x),n.trigger(l,"beforeUpdate",x),r.update(t,g),n.trigger(l,"afterUpdate",x),n.trigger(l,"afterTick",x)},e.stop=function(l){c(l.frameRequestId)},e.start=function(l,t){e.run(l,t)}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(8),r=s(0),a=r.deprecated;(function(){e.collides=function(u,c){return n.collides(u,c)},a(e,"collides","SAT.collides âž¤ replaced by Collision.collides")})()}),(function(d,p,s){var e={};d.exports=e,s(1);var n=s(0);(function(){e.pathToVertices=function(r,a){typeof window<"u"&&!("SVGPathSeg"in window)&&n.warn("Svg.pathToVertices: SVGPathSeg not defined, a polyfill is required.");var u,c,m,l,t,o,f,g,x,M,E=[],T,v,C=0,P=0,S=0;a=a||15;var I=function(b,A,D){var O=D%2===1&&D>1;if(!x||b!=x.x||A!=x.y){x&&O?(T=x.x,v=x.y):(T=0,v=0);var R={x:T+b,y:v+A};(O||!x)&&(x=R),E.push(R),P=T+b,S=v+A}},w=function(b){var A=b.pathSegTypeAsLetter.toUpperCase();if(A!=="Z"){switch(A){case"M":case"L":case"T":case"C":case"S":case"Q":P=b.x,S=b.y;break;case"H":P=b.x;break;case"V":S=b.y;break}I(P,S,b.pathSegType)}};for(e._svgPathToAbsolute(r),m=r.getTotalLength(),o=[],u=0;u<r.pathSegList.numberOfItems;u+=1)o.push(r.pathSegList.getItem(u));for(f=o.concat();C<m;){if(M=r.getPathSegAtLength(C),t=o[M],t!=g){for(;f.length&&f[0]!=t;)w(f.shift());g=t}switch(t.pathSegTypeAsLetter.toUpperCase()){case"C":case"T":case"S":case"Q":case"A":l=r.getPointAtLength(C),I(l.x,l.y,0);break}C+=a}for(u=0,c=f.length;u<c;++u)w(f[u]);return E},e._svgPathToAbsolute=function(r){for(var a,u,c,m,l,t,o=r.pathSegList,f=0,g=0,x=o.numberOfItems,M=0;M<x;++M){var E=o.getItem(M),T=E.pathSegTypeAsLetter;if(/[MLHVCSQTA]/.test(T))"x"in E&&(f=E.x),"y"in E&&(g=E.y);else switch("x1"in E&&(c=f+E.x1),"x2"in E&&(l=f+E.x2),"y1"in E&&(m=g+E.y1),"y2"in E&&(t=g+E.y2),"x"in E&&(f+=E.x),"y"in E&&(g+=E.y),T){case"m":o.replaceItem(r.createSVGPathSegMovetoAbs(f,g),M);break;case"l":o.replaceItem(r.createSVGPathSegLinetoAbs(f,g),M);break;case"h":o.replaceItem(r.createSVGPathSegLinetoHorizontalAbs(f),M);break;case"v":o.replaceItem(r.createSVGPathSegLinetoVerticalAbs(g),M);break;case"c":o.replaceItem(r.createSVGPathSegCurvetoCubicAbs(f,g,c,m,l,t),M);break;case"s":o.replaceItem(r.createSVGPathSegCurvetoCubicSmoothAbs(f,g,l,t),M);break;case"q":o.replaceItem(r.createSVGPathSegCurvetoQuadraticAbs(f,g,c,m),M);break;case"t":o.replaceItem(r.createSVGPathSegCurvetoQuadraticSmoothAbs(f,g),M);break;case"a":o.replaceItem(r.createSVGPathSegArcAbs(f,g,E.r1,E.r2,E.angle,E.largeArcFlag,E.sweepFlag),M);break;case"z":case"Z":f=a,g=u;break}(T=="M"||T=="m")&&(a=f,u=g)}}})()}),(function(d,p,s){var e={};d.exports=e;var n=s(6);s(0),(function(){e.create=n.create,e.add=n.add,e.remove=n.remove,e.clear=n.clear,e.addComposite=n.addComposite,e.addBody=n.addBody,e.addConstraint=n.addConstraint})()})])})})(Se)),Se.exports}var Ze=Ye();const V=Xe(Ze),ye=2,xe=3,ke=10,Ke=15;function je(i,h,d,p,s,e){const n=Math.max(0,Math.min(e,p/2,s/2));i.moveTo(h+n,d),i.lineTo(h+p-n,d),i.arcTo(h+p,d,h+p,d+n,n),i.lineTo(h+p,d+s-n),i.arcTo(h+p,d+s,h+p-n,d+s,n),i.lineTo(h+n,d+s),i.arcTo(h,d+s,h,d+s-n,n),i.lineTo(h,d+n),i.arcTo(h,d,h+n,d,n),i.closePath()}const F={engine:null,render:null,world:null,runner:null,isInitialized:!1,isRunning:!1,currentMode:"sand",currentSegments:k.SAND_COLORS.length,renderMaskHandler:null,init:function(i,h,d,p={}){const s=p.mode||F.currentMode||"sand",e=Math.max(1,p.segments||(s==="sand"?k.SAND_COLORS.length:1));if(F.isInitialized){const r=F.render&&(F.render.options.width!==h||F.render.options.height!==d),a=F.currentMode!==s||F.currentSegments!==e;r&&F.render&&(console.log(`Resizing physics renderer to ${h}x${d}`),F.render.bounds.max.x=h,F.render.bounds.max.y=d,F.render.options.width=h,F.render.options.height=d,F.render.canvas.width=h,F.render.canvas.height=d),(r||a)&&(F.currentMode=s,F.currentSegments=e,F.updateWallPositions(h,d)),F.configureRenderMask(),F.start();return}if(console.log(`Initializing Physics Engine (${s}): ${h}x${d}`),!i||isNaN(h)||isNaN(d)||h<=0||d<=0){console.error("Cannot initialize Physics: Invalid canvas or dimensions.");return}const n={enableSleeping:!0,positionIterations:8,velocityIterations:6};F.engine=V.Engine.create(n),F.world=F.engine.world,F.engine.world.gravity.y=.7,F.render=V.Render.create({element:i.parentNode,canvas:i,engine:F.engine,options:{width:h,height:d,wireframes:!1,background:"transparent",showSleeping:!1,pixelRatio:window.devicePixelRatio||1}}),F.currentMode=s,F.currentSegments=e,F.createWalls(h,d,s,e),F.configureRenderMask(),F.runner=V.Runner.create(),V.Runner.run(F.runner,F.engine),V.Render.run(F.render),F.isInitialized=!0,F.isRunning=!0,console.log("Physics engine initialized and running.")},createWalls:function(i,h,d=F.currentMode,p=F.currentSegments){if(!F.world)return;const s=V.Composite.allBodies(F.world).filter(a=>a.isStatic);s.length>0&&V.World.remove(F.world,s);const e=15,n={isStatic:!0,friction:.6,restitution:.1,render:{visible:!1}},r=[];if(r.push(V.Bodies.rectangle(i/2,h+e/2,i+e*2,e,n)),r.push(V.Bodies.rectangle(-e/2,h/2,e,h+e*2,n)),r.push(V.Bodies.rectangle(i+e/2,h/2,e,h+e*2,n)),d==="sand"){const a=Math.max(1,p),u=i/a;for(let c=1;c<a;c++){const m=c*u;r.push(V.Bodies.rectangle(m,h/2,e,h+e*2,n))}}V.World.add(F.world,r)},updateWallPositions:function(i,h){F.createWalls(i,h,F.currentMode,F.currentSegments)},addParticle:function(i,h){if(!F.isInitialized||!F.engine||!F.world||!F.render?.options?.width||F.currentMode!=="sand")return!1;const d=Math.max(1,F.currentSegments||k.SAND_COLORS.length);if(i<0||i>=d)return!1;const p=F.render.options.width/d,s=y.preferences?.sandParticleSize||5,e=15,n=s*.5,r=i*p,a=r+e/2+s+n,u=r+p-e/2-s-n;if(a>=u)return!1;const c=a+Math.random()*(u-a),m=s+4,l=V.Bodies.polygon(c,m,6,s,{restitution:.15,friction:.7,frictionAir:.01,density:.01,render:{fillStyle:h},sleepThreshold:60});return V.Body.setVelocity(l,{x:(Math.random()-.5)*.1,y:Math.random()*.1}),V.Body.setAngularVelocity(l,(Math.random()-.5)*.01),V.World.add(F.world,l),!0},addWaterParticle:function(i="#4aa8ff"){if(!F.isInitialized||!F.engine||!F.world||!F.render?.options?.width||F.currentMode!=="water")return!1;const h=F.render.options.width,d=Math.max(2,(y.preferences?.sandParticleSize||5)*.8),p=15,s=d*.25,e=p/2+d+s,n=h-p/2-d-s;if(e>=n)return!1;const r=e+Math.random()*(n-e),a=-d*2,u=V.Bodies.circle(r,a,d,{restitution:.03,friction:.01,frictionStatic:.02,frictionAir:.01,density:8e-4,render:{fillStyle:i},sleepThreshold:120});return V.Body.setVelocity(u,{x:(Math.random()-.5)*.08,y:Math.random()*.06}),V.World.add(F.world,u),!0},getSegmentTopYs:function(){if(!F.world||!F.render?.options?.width)return null;const i=Math.max(1,F.currentSegments||k.SAND_COLORS.length),h=F.render.options.width/i,d=Array(i).fill(1/0);return V.Composite.allBodies(F.world).filter(s=>!s.isStatic).forEach(s=>{const e=s.position?.x;if(typeof e!="number"||Number.isNaN(e))return;const n=Math.max(0,Math.min(i-1,Math.floor(e/h))),r=s.bounds?.min?.y;typeof r=="number"&&!Number.isNaN(r)&&r<d[n]&&(d[n]=r)}),d},getTopY:function(){if(!F.world)return null;const i=V.Composite.allBodies(F.world).filter(d=>!d.isStatic);if(i.length===0)return 1/0;let h=1/0;return i.forEach(d=>{const p=d.bounds?.min?.y;typeof p=="number"&&!Number.isNaN(p)&&p<h&&(h=p)}),h},clearDynamicBodies:function(){if(!F.world)return;const h=V.Composite.allBodies(F.world).filter(d=>!d.isStatic);h.length>0&&V.World.remove(F.world,h)},configureRenderMask:function(){F.render&&(F.renderMaskHandler&&(V.Events.off(F.render,"afterRender",F.renderMaskHandler),F.renderMaskHandler=null),F.currentMode==="sand"&&(F.renderMaskHandler=()=>{F.applyRoundedSegmentMask()},V.Events.on(F.render,"afterRender",F.renderMaskHandler)))},applyRoundedSegmentMask:function(){if(!F.render?.context||!F.render?.options)return;const i=F.render.context,h=F.render.options.width,d=F.render.options.height,p=Math.max(1,F.currentSegments||k.SAND_COLORS.length),e=(Math.max(1,h-ye*2)-ke*(p-1))/p,n=Math.max(1,d-ye*2-xe*2),r=ye+xe;i.save(),i.globalCompositeOperation="destination-in",i.beginPath();for(let a=0;a<p;a++){const u=ye+a*(e+ke)+xe,c=Math.max(1,e-xe*2),m=Math.min(Ke,c/2,n/2);je(i,u,r,c,n,m)}i.fillStyle="#ffffff",i.fill(),i.restore()},stop:function(){F.isRunning&&(F.runner&&V.Runner.stop(F.runner),F.render&&V.Render.stop(F.render),F.isRunning=!1)},start:function(){F.isRunning||!F.isInitialized||(F.render&&V.Render.run(F.render),F.runner&&F.engine?(V.Runner.run(F.runner,F.engine),F.isRunning=!0):console.error("Cannot start physics, not initialized."))},destroy:function(){console.log("Destroying physics engine..."),F.stop(),F.render&&F.renderMaskHandler&&(V.Events.off(F.render,"afterRender",F.renderMaskHandler),F.renderMaskHandler=null),F.world&&V.World.clear(F.world,!1),F.engine&&V.Engine.clear(F.engine),F.engine=null,F.world=null,F.render=null,F.runner=null,F.isInitialized=!1,F.isRunning=!1,F.currentMode="sand",F.currentSegments=k.SAND_COLORS.length,console.log("Physics engine destroyed.")}},de=k.SAND_COLORS.length,he=2,Re=10,me=3,_e=220,Oe=320,Ne=1150,et=6.5,tt=18,nt=.18,rt=15;function j(i,h,d){return Math.max(h,Math.min(d,i))}function we(i,h={r:74,g:168,b:255}){if(typeof i!="string")return h;const d=i.trim().replace("#",""),p=d.length===3?d.split("").map(s=>`${s}${s}`).join(""):d;return/^[0-9a-fA-F]{6}$/.test(p)?{r:parseInt(p.slice(0,2),16),g:parseInt(p.slice(2,4),16),b:parseInt(p.slice(4,6),16)}:h}function se(i,h){return`rgba(${i.r}, ${i.g}, ${i.b}, ${h})`}function oe(i,h){return{r:j(Math.round(i.r+h),0,255),g:j(Math.round(i.g+h),0,255),b:j(Math.round(i.b+h),0,255)}}function ze(i,h){return oe(i,-h)}function st(i){const h=Math.max(14,Math.round(i/6));return Array.from({length:h},()=>({offset:0,velocity:0}))}function Ce(i,h){return j(i.fillUnits/Math.max(1,h),0,1)}function We(i,h){const d=Ce(i,h);return i.yBottom-i.height*d}function it(i,h,d){const p=i.surfacePoints,s=Ce(i,h),e=We(i,h);if(p.length===0||s<=0)return i.yBottom;const n=j(d/Math.max(1,i.width),0,1)*(p.length-1),r=Math.floor(n),a=Math.min(p.length-1,r+1),u=n-r,c=p[r].offset,m=p[a].offset;return e+(c+(m-c)*u)}function at(i){i.surfacePoints.forEach(h=>{h.offset=0,h.velocity=0})}function ot(i,h,d,p,s,e){const n=Math.max(0,Math.min(e,p/2,s/2));i.moveTo(h+n,d),i.lineTo(h+p-n,d),i.arcTo(h+p,d,h+p,d+n,n),i.lineTo(h+p,d+s-n),i.arcTo(h+p,d+s,h+p-n,d+s,n),i.lineTo(h+n,d+s),i.arcTo(h,d+s,h,d+s-n,n),i.lineTo(h,d+n),i.arcTo(h,d,h+n,d,n),i.closePath()}function lt(i,h,d){const p=Math.sqrt(h.vx*h.vx+h.vy*h.vy),s=j(p/420,0,1),e=Math.sin((h.x+h.y)*.07)*.05,n=h.radius*j(.95-s*.22+e,.55,1.05),r=h.radius*(1.25+s*.95),a=Math.atan2(h.vy,h.vx)-Math.PI/2;i.save(),i.translate(h.x,h.y),i.rotate(a);const u=i.createLinearGradient(0,-r,0,r);u.addColorStop(0,se(oe(d,45),.9)),u.addColorStop(.55,se(oe(d,12),.95)),u.addColorStop(1,se(ze(d,32),.88)),i.beginPath(),i.moveTo(0,-r*1.05),i.bezierCurveTo(n*.95,-r*.7,n*1.2,r*.2,0,r),i.bezierCurveTo(-n*1.2,r*.2,-n*.95,-r*.7,0,-r*1.05),i.closePath(),i.fillStyle=u,i.fill(),i.beginPath(),i.ellipse(-n*.18,-r*.2,n*.22,r*.2,0,0,Math.PI*2),i.fillStyle=se(oe(d,110),.45),i.fill(),s>.18&&(i.beginPath(),i.moveTo(0,-r*1.02),i.lineTo(0,-r*(1.35+s*.35)),i.strokeStyle=se(oe(d,70),.35),i.lineWidth=Math.max(.6,h.radius*.22),i.lineCap="round",i.stroke()),i.restore()}function ct(i,h,d){const p=Math.sqrt(h.vx*h.vx+h.vy*h.vy),s=j(p/280,0,1),e=Math.atan2(h.vy,h.vx),n=j(h.life/h.maxLife,0,1),r=h.radius*(1+s*.9),a=h.radius*(1-s*.35);i.save(),i.translate(h.x,h.y),i.rotate(e),i.beginPath(),i.ellipse(0,0,r,Math.max(.6,a),0,0,Math.PI*2),i.fillStyle=se(oe(d,55),n*.9),i.fill(),i.restore()}const L={canvas:null,ctx:null,width:0,height:0,dpr:1,bars:[],droplets:[],splashParticles:[],isInitialized:!1,isRunning:!1,rafId:null,lastFrameMs:0,barCapacity:120,dropletRadius:3,maxDroplets:_e,colors:[...k.SAND_COLORS],frameClockMs:0,init:function(i,h,d,p={}){if(!i||!Number.isFinite(h)||!Number.isFinite(d)||h<=0||d<=0){console.error("WaterBars.init called with invalid canvas or dimensions.");return}if(L.isInitialized&&L.canvas!==i&&L.destroy(),L.canvas=i,L.ctx=i.getContext("2d",{alpha:!0}),!L.ctx){console.error("WaterBars could not acquire 2D context.");return}const s=Array.isArray(p.colors)&&p.colors.length>0?p.colors.slice(0,de):[...k.SAND_COLORS];L.colors=s,p.capacityPerBar!==void 0&&L.setCapacity(p.capacityPerBar),p.particleRadius!==void 0&&L.setParticleRadius(p.particleRadius),L.resize(h,d),L.isInitialized=!0,L.renderOnce()},resize:function(i,h){if(!L.canvas||!L.ctx||!Number.isFinite(i)||!Number.isFinite(h)||i<=0||h<=0)return;const d=L.bars.map(p=>p.fillUnits||0);L.width=Math.max(1,Math.floor(i)),L.height=Math.max(1,Math.floor(h)),L.dpr=Math.min(window.devicePixelRatio||1,2),L.canvas.width=Math.floor(L.width*L.dpr),L.canvas.height=Math.floor(L.height*L.dpr),L.canvas.style.width=`${L.width}px`,L.canvas.style.height=`${L.height}px`,L.ctx.setTransform(L.dpr,0,0,L.dpr,0,0),L.rebuildBars(d)},rebuildBars:function(i=[]){L.droplets=[],L.splashParticles=[],L.bars=[];const h=Math.max(20,L.width-he*2),d=Math.max(20,L.height-he*2),p=Math.max(8,(h-Re*(de-1))/de),s=he,e=he+me,n=L.height-he-me,r=Math.max(8,d-me*2);for(let a=0;a<de;a++){const u=s+a*(p+Re)+me,c=Math.max(4,p-me*2),m=j(Number(i[a])||0,0,L.barCapacity),l={index:a,x:u,width:c,yTop:e,yBottom:n,height:r,cornerRadius:Math.min(rt,c/2,r/2),colorHex:L.colors[a]||k.SAND_COLORS[a]||"#4aa8ff",fillUnits:m,surfacePoints:st(c)};L.bars.push(l)}},reset:function(){L.droplets=[],L.splashParticles=[],L.bars.forEach(i=>{i.fillUnits=0,at(i)}),L.renderOnce()},setCapacity:function(i){const h=Number(i);L.barCapacity=Number.isFinite(h)?Math.max(1,Math.floor(h)):120,L.bars.forEach(d=>{d.fillUnits=j(d.fillUnits,0,L.barCapacity)})},setParticleRadius:function(i){const h=Number(i);Number.isFinite(h)&&(L.dropletRadius=j(h,1.6,12))},setColors:function(i){!Array.isArray(i)||i.length===0||(L.colors=i.slice(0,de),L.bars.forEach((h,d)=>{h.colorHex=L.colors[d]||h.colorHex}))},getTotalCapacity:function(){return L.barCapacity*L.bars.length},getTotalFillUnits:function(){return L.bars.length===0?0:L.bars.reduce((i,h)=>i+h.fillUnits,0)},getPendingDropletCount:function(){return L.droplets.length},getPendingForBar:function(i){return L.droplets.reduce((h,d)=>h+(d.barIndex===i?1:0),0)},getBarProjectedRemaining:function(i){if(i<0||i>=L.bars.length)return 0;const h=L.bars[i],d=L.getPendingForBar(i);return Math.max(0,L.barCapacity-h.fillUnits-d)},findBestBarIndex:function(i=-1){if(L.bars.length===0)return-1;if(i>=0&&i<L.bars.length&&L.getBarProjectedRemaining(i)>0)return i;let h=-1,d=0;for(let p=0;p<L.bars.length;p++){const s=L.getBarProjectedRemaining(p);s>d&&(d=s,h=p)}return h},addDroplet:function(i,h){if(!L.isInitialized||!L.ctx||i<0||i>=L.bars.length||L.droplets.length>=L.maxDroplets)return!1;const d=L.bars[i],p=j(L.dropletRadius,1.6,Math.max(2.2,d.width*.48)),s=d.x+p,e=d.x+d.width-p,n=e>s?s+Math.random()*(e-s):d.x+d.width*.5;return L.droplets.push({barIndex:i,colorHex:h||d.colorHex,radius:p,x:n,y:d.yTop+p+1,vx:(Math.random()-.5)*22,vy:24+Math.random()*52}),!0},createSplash:function(i,h,d,p,s){if(L.splashParticles.length>=Oe)return;const e=Math.min(7,3+Math.floor(p/120));for(let n=0;n<e&&!(L.splashParticles.length>=Oe);n++){const r=70+Math.random()*130+p*.1,a=-Math.PI/2+(Math.random()-.5)*1.2;L.splashParticles.push({barIndex:i.index,x:h,y:d-1,vx:Math.cos(a)*r,vy:Math.sin(a)*r,radius:1+Math.random()*1.8,life:.18+Math.random()*.28,maxLife:.46,colorHex:s})}},disturbSurface:function(i,h,d){const p=i.surfacePoints;if(!p||p.length===0)return;const s=j((h-i.x)/Math.max(1,i.width),0,1),e=Math.round(s*(p.length-1)),n=j(d*.16,10,200);for(let r=Math.max(0,e-2);r<=Math.min(p.length-1,e+2);r++){const u=1-Math.abs(r-e)/3;p[r].velocity+=n*Math.max(0,u)}},updateDroplets:function(i){if(L.droplets.length!==0)for(let h=L.droplets.length-1;h>=0;h--){const d=L.droplets[h],p=L.bars[d.barIndex];if(!p){L.droplets.splice(h,1);continue}d.vy+=Ne*i,d.vx*=Math.max(0,1-i*1.8),d.x+=d.vx*i,d.y+=d.vy*i;const s=p.x+d.radius,e=p.x+p.width-d.radius;d.x<s?(d.x=s,d.vx*=-.3):d.x>e&&(d.x=e,d.vx*=-.3);const n=it(p,L.barCapacity,d.x-p.x);if(d.y+d.radius>=n){p.fillUnits=j(p.fillUnits+1,0,L.barCapacity),L.disturbSurface(p,d.x,d.vy),L.createSplash(p,d.x,n,d.vy,d.colorHex||p.colorHex),L.droplets.splice(h,1);continue}d.y-d.radius>p.yBottom+26&&L.droplets.splice(h,1)}},updateSplashParticles:function(i){if(L.splashParticles.length!==0)for(let h=L.splashParticles.length-1;h>=0;h--){const d=L.splashParticles[h];d.vy+=Ne*.74*i,d.vx*=Math.max(0,1-i*.9),d.x+=d.vx*i,d.y+=d.vy*i,d.life-=i,(d.life<=0||d.y>L.height+16)&&L.splashParticles.splice(h,1)}},updateSurface:function(i){const h=Math.min(.05,i);L.bars.forEach(d=>{const p=d.surfacePoints;if(!p||p.length===0)return;const s=p.map(u=>u.offset),e=d.height*nt,r=Ce(d,L.barCapacity)>.02?Math.sin(L.frameClockMs*.0019+d.index*.85)*d.height*6e-4:0;for(let u=0;u<p.length;u++){const c=p[u],m=s[u>0?u-1:u],l=s[u<p.length-1?u+1:u],t=m+l-2*s[u],o=-34*s[u],f=tt*t;c.velocity+=(o+f)*h,c.velocity*=Math.max(0,1-et*h),c.offset+=c.velocity*h,c.offset=j(c.offset,-e,e)}const a=Math.floor(p.length/2);p[a].velocity+=r})},isNearTop:function(){return L.bars.length===0?!1:L.bars.every(i=>i.fillUnits>=L.barCapacity)},ensureSizeFromCanvas:function(){if(!L.canvas)return;const i=Math.max(1,Math.floor(L.canvas.clientWidth||0)),h=Math.max(1,Math.floor(L.canvas.clientHeight||0));(i!==L.width||h!==L.height)&&L.resize(i,h)},start:function(){!L.isInitialized||L.isRunning||(L.isRunning=!0,L.lastFrameMs=performance.now(),L.rafId=requestAnimationFrame(L.tick))},stop:function(){L.isRunning&&(L.isRunning=!1,L.rafId&&(cancelAnimationFrame(L.rafId),L.rafId=null),L.lastFrameMs=0)},tick:function(i){if(!L.isRunning)return;const h=j((i-L.lastFrameMs)/1e3,.001,.05);L.lastFrameMs=i,L.frameClockMs=i,L.ensureSizeFromCanvas(),L.updateDroplets(h),L.updateSplashParticles(h),L.updateSurface(h),L.renderOnce(),L.rafId=requestAnimationFrame(L.tick)},renderOnce:function(){if(!L.ctx)return;const i=L.ctx;i.clearRect(0,0,L.width,L.height);const h=Array.from({length:L.bars.length},()=>[]),d=Array.from({length:L.bars.length},()=>[]);L.droplets.forEach(p=>{p.barIndex>=0&&p.barIndex<h.length&&h[p.barIndex].push(p)}),L.splashParticles.forEach(p=>{p.barIndex>=0&&p.barIndex<d.length&&d[p.barIndex].push(p)}),L.bars.forEach(p=>{if(i.save(),i.beginPath(),ot(i,p.x,p.yTop,p.width,p.height,p.cornerRadius),i.clip(),Ce(p,L.barCapacity)>0){const e=we(p.colorHex),n=oe(e,38),r=oe(e,10),a=ze(e,28),u=We(p,L.barCapacity),c=i.createLinearGradient(0,p.yTop,0,p.yBottom);c.addColorStop(0,se(n,.78)),c.addColorStop(.48,se(r,.84)),c.addColorStop(1,se(a,.93)),i.beginPath(),i.moveTo(p.x,p.yBottom),i.lineTo(p.x,u+p.surfacePoints[0].offset);for(let m=1;m<p.surfacePoints.length;m++){const l=p.x+m/(p.surfacePoints.length-1)*p.width,t=u+p.surfacePoints[m].offset;i.lineTo(l,t)}i.lineTo(p.x+p.width,p.yBottom),i.closePath(),i.fillStyle=c,i.fill(),i.beginPath();for(let m=0;m<p.surfacePoints.length;m++){const l=p.x+m/(p.surfacePoints.length-1)*p.width,t=u+p.surfacePoints[m].offset;m===0?i.moveTo(l,t):i.lineTo(l,t)}i.lineWidth=1.7,i.strokeStyle=se(oe(e,85),.7),i.stroke()}d[p.index].forEach(e=>{const n=we(e.colorHex);ct(i,e,n)}),h[p.index].forEach(e=>{const n=we(e.colorHex);lt(i,e,n)}),i.restore()})},destroy:function(){L.stop(),L.bars=[],L.droplets=[],L.splashParticles=[],L.canvas=null,L.ctx=null,L.width=0,L.height=0,L.isInitialized=!1}},W={update:function(i){y.preferences.showScheduleCircles?W.renderScheduleCircles():B.scheduleCirclesDisplayEl&&(B.scheduleCirclesDisplayEl.innerHTML="")},renderScheduleCircles:function(){if(!y.preferences.showScheduleCircles||!B.scheduleCirclesDisplayEl){B.scheduleCirclesDisplayEl&&(B.scheduleCirclesDisplayEl.innerHTML="");return}const i=le(),h=G.getCurrentPeriodInfo(i),d=y.getActiveColourScheme(),p=(y.schedule||[]).map((n,r)=>({...n,originalIndex:r})).filter(n=>n.showCircles);if(p.length===0){B.scheduleCirclesDisplayEl.innerHTML="";return}let s=-1;h&&(s=p.findIndex(n=>n.originalIndex===h.index));let e="";for(let n=0;n<p.length;n++){const r=s>=n,a=r?"â—":"â—‹",u=`schedule-circle-symbol ${r?"active":"inactive"}`,c=r?d.text:"#555";e+=`<span class="${u}" style="color: ${c};">${a}</span>`}B.scheduleCirclesDisplayEl.innerHTML=e},setupPhysicsSandBars:function(i){if(W.stopPhysicsCheckInterval(),L.stop(),L.reset(),F.clearDynamicBodies(),k.physicsParticlesAdded=0,k.totalParticlesForPeriod=0,!y.preferences.showSandBars||!B.sandBarsCanvas||!B.sandBarsContainerEl){F.stop();return}const h=y.preferences?.sandHeight||150,d=y.preferences?.sandWidth||80;B.sandBarsContainerEl.style.height=`${h}px`,B.sandBarsContainerEl.style.width=`${d}%`,requestAnimationFrame(()=>{const p=B.sandBarsContainerEl.offsetWidth,s=B.sandBarsContainerEl.offsetHeight;if(p<=0||s<=0){console.warn("Sand bars container has zero dimensions after rAF. Aborting physics setup."),F.stop();return}const e=y.preferences?.sandParticleSize||5,n=3*Math.sqrt(3)/2*e*e,r=p/k.SAND_COLORS.length,u=Math.max(0,r-15-e*.25),c=Math.max(0,s-e*.2),m=u*c,l=.94;k.visualMaxParticlesPerSegment=Math.max(10,Math.floor(m*l/n)),k.totalParticlesForPeriod=k.visualMaxParticlesPerSegment*k.SAND_COLORS.length,console.log(`Est. Max Particles Per Segment (Hex): ${k.visualMaxParticlesPerSegment}, Total Target: ${k.totalParticlesForPeriod}, Particle Area: ${n.toFixed(2)}`),F.init(B.sandBarsCanvas,p,s,{mode:"sand",segments:k.SAND_COLORS.length}),F.start(),W.handleColorSchemeChange();const t=i||G.getCurrentPeriodInfo(le());t?t.end.getTime()-t.start.getTime()>0?(W.checkAndAddParticles(),k.physicsCheckIntervalId=setInterval(W.checkAndAddParticles,k.physicsCheckIntervalMs)):(console.log("Period duration is zero or negative, stopping sand physics."),F.stop()):(console.log("No current period found, stopping sand physics."),F.stop())})},setupPhysicsWaterFill:function(i){if(W.stopPhysicsCheckInterval(),F.clearDynamicBodies(),F.stop(),k.physicsParticlesAdded=0,k.totalParticlesForPeriod=0,!y.preferences.showWaterFill||!B.waterFillCanvas||!B.waterFillContainerEl){L.stop(),L.reset();return}const h=y.preferences?.sandHeight||150,d=y.preferences?.sandWidth||80;B.waterFillContainerEl.style.height=`${h}px`,B.waterFillContainerEl.style.width=`${d}%`,requestAnimationFrame(()=>{const p=B.waterFillContainerEl.offsetWidth,s=B.waterFillContainerEl.offsetHeight;if(p<=0||s<=0){console.warn("Water fill container has zero dimensions after rAF. Aborting physics setup."),L.stop();return}const e=k.SAND_COLORS.length,n=Math.max(2,(y.preferences?.sandParticleSize||5)*.75),r=Math.PI*n*n,a=8,u=10,c=Math.max(20,p-a*2),m=Math.max(20,s-8),l=Math.max(6,(c-u*(e-1))/e),t=.7;k.visualMaxParticlesPerSegment=Math.max(30,Math.floor(l*m*t/r)),k.totalParticlesForPeriod=k.visualMaxParticlesPerSegment*e,console.log(`Est. Max Water Droplets Per Segment: ${k.visualMaxParticlesPerSegment}, Total Target: ${k.totalParticlesForPeriod}, Particle Area: ${r.toFixed(2)}`),L.init(B.waterFillCanvas,p,s,{colors:k.SAND_COLORS,capacityPerBar:k.visualMaxParticlesPerSegment,particleRadius:n}),L.setCapacity(k.visualMaxParticlesPerSegment),L.setParticleRadius(n),L.reset(),L.start(),W.handleColorSchemeChange();const o=i||G.getCurrentPeriodInfo(le());o?o.end.getTime()-o.start.getTime()>0?(W.checkAndAddWaterParticles(),k.physicsCheckIntervalId=setInterval(W.checkAndAddWaterParticles,k.physicsCheckIntervalMs)):console.log("Period duration is zero or negative, showing empty water bars."):console.log("No current period found, showing empty water bars.")})},isSandBarsNearTop:function(){if(!F.isInitialized||!F.isRunning)return!1;const i=F.getSegmentTopYs();if(!i||i.length!==k.SAND_COLORS.length)return!1;const h=y.preferences?.sandParticleSize||5,d=Math.max(2,h*1.2);return i.every(p=>Number.isFinite(p)&&p<=d)},isWaterNearTop:function(){return L.isNearTop()},checkAndAddParticles:function(){if(!y.preferences.showSandBars||!F.isRunning||k.totalParticlesForPeriod<=0){W.stopPhysicsCheckInterval();return}const i=le(),h=G.getCurrentPeriodInfo(i);if(!h){W.stopPhysicsCheckInterval();return}const d=h.start.getTime(),s=h.end.getTime()-d;if(s<=0){W.stopPhysicsCheckInterval();return}if(W.isSandBarsNearTop()){W.stopPhysicsCheckInterval();return}const n=Math.max(0,i.getTime()-d),r=Math.min(1,n/s),a=Math.floor(r*k.totalParticlesForPeriod),u=Math.ceil(k.totalParticlesForPeriod*1.35);let c=a;r>=.9&&c<=k.physicsParticlesAdded&&(c=Math.min(u,k.physicsParticlesAdded+6)),c=Math.min(c,u);const m=c-k.physicsParticlesAdded;if(m<=0)return;const l=6;for(let t=0;t<Math.min(m,l)&&!(k.physicsParticlesAdded>=u);++t){const o=s/k.SAND_COLORS.length,f=k.physicsParticlesAdded;let g;if(f<k.totalParticlesForPeriod){const x=(f+.5)/k.totalParticlesForPeriod*s;g=Math.min(k.SAND_COLORS.length-1,Math.floor(x/o))}else g=f%k.SAND_COLORS.length;if(g>=0)if(F.addParticle(g,k.SAND_COLORS[g]))k.physicsParticlesAdded++;else break}k.physicsParticlesAdded>=u&&W.stopPhysicsCheckInterval()},checkAndAddWaterParticles:function(){if(!y.preferences.showWaterFill||!L.isRunning||k.totalParticlesForPeriod<=0){W.stopPhysicsCheckInterval();return}const i=le(),h=G.getCurrentPeriodInfo(i);if(!h){W.stopPhysicsCheckInterval();return}const d=h.start.getTime(),s=h.end.getTime()-d;if(s<=0){W.stopPhysicsCheckInterval();return}const e=Math.max(1,L.getTotalCapacity()||k.totalParticlesForPeriod);k.totalParticlesForPeriod=e;const n=L.getTotalFillUnits(),r=L.getPendingDropletCount(),a=n+r;if(k.physicsParticlesAdded=a,W.isWaterNearTop()&&r===0){W.stopPhysicsCheckInterval();return}const u=Math.max(0,i.getTime()-d),c=Math.min(1,u/s),m=Math.floor(c*e),l=Math.ceil(e*1.6),t=Math.max(0,e-n);let o=m;c>=.9&&(o=Math.max(o,Math.min(e,n+Math.ceil(t*.35)))),c>=.97&&(o=Math.max(o,Math.min(e,n+Math.ceil(t*.75)))),c>=.995&&(o=Math.max(o,e)),c>=.9&&o<=a&&t>0&&(o=Math.min(l,a+Math.min(18,t*2))),o=Math.min(o,l);const f=o-a;if(f<=0)return;let g=5;c>=.9&&(g=10),c>=.97&&(g=18),c>=.995&&(g=28);for(let M=0;M<Math.min(f,g);++M){const E=a+M;if(E>=l)break;const T=s/k.SAND_COLORS.length,v=E;let C;if(v<e){const S=(v+.5)/e*s;C=Math.min(k.SAND_COLORS.length-1,Math.floor(S/T))}else C=v%k.SAND_COLORS.length;const P=L.findBestBarIndex(C);if(P>=0){if(!L.addDroplet(P,k.SAND_COLORS[P]))break}else break}const x=L.getPendingDropletCount();W.isWaterNearTop()&&x===0&&W.stopPhysicsCheckInterval()},stopPhysicsCheckInterval:function(){k.physicsCheckIntervalId&&(clearInterval(k.physicsCheckIntervalId),k.physicsCheckIntervalId=null)},handlePeriodChange:function(i){if(y.preferences.showSandBars){W.setupPhysicsSandBars(i);return}if(y.preferences.showWaterFill){W.setupPhysicsWaterFill(i);return}W.stopPhysicsCheckInterval(),L.stop(),L.reset(),F.clearDynamicBodies(),F.stop()},handleDisplayToggle:function(){const i=G.getCurrentPeriodInfo(le());if(y.preferences.showSandBars){W.setupPhysicsSandBars(i);return}if(y.preferences.showWaterFill){W.setupPhysicsWaterFill(i);return}W.stopPhysicsCheckInterval(),L.stop(),L.reset(),F.clearDynamicBodies(),F.stop()},handleColorSchemeChange:function(){const i=y.getActiveColourScheme().text||"#FFFFFF";document.querySelectorAll(".sand-bar-outline-segment, .water-fill-outline-segment").forEach(h=>{h.style.borderColor=i}),y.preferences.showScheduleCircles&&W.renderScheduleCircles()}},ce={update:function(){const i=y.preferences;if(!B.clockDisplayArea){console.warn("DOM cache not ready in Layout.update");return}[{el:B.dateEl,pref:"showDate"},{el:B.scheduleCirclesDisplayEl,pref:"showScheduleCircles"},{el:B.timeEl,pref:"showTime"}].forEach(n=>{n.el?.classList.toggle("element-hidden",!i[n.pref])});const d=i.showScheduleLabel||i.showProgressBar||i.showSandBars||i.showWaterFill;B.periodContainerEl?.classList.toggle("element-hidden",!d),d?B.periodLabelEl?.classList.toggle("element-hidden",!i.showScheduleLabel):B.periodLabelEl?.classList.add("element-hidden");const p=i.showProgressBar&&!i.showSandBars&&!i.showWaterFill,s=i.showSandBars,e=i.showWaterFill;B.progressBarEl?.classList.toggle("element-hidden",!p),B.sandBarsContainerEl?.classList.toggle("element-hidden",!s),B.waterFillContainerEl?.classList.toggle("element-hidden",!e),B.sandBarsCanvas&&(B.sandBarsCanvas.style.display=s?"block":"none"),B.waterFillCanvas&&(B.waterFillCanvas.style.display=e?"block":"none"),ce.applyFontAndSizePreferences()},applyFontAndSizePreferences:function(){const i=y.preferences;y.getActiveColourScheme(),B.clockDisplayArea&&(i.showDate&&B.dateEl&&(B.dateEl.style.fontSize=i.dateFontSize+"px"),i.showTime&&B.timeEl&&(B.timeEl.style.fontSize=i.timeFontSize+"px"),i.showScheduleLabel&&B.periodLabelEl&&(B.periodLabelEl.style.fontSize=i.scheduleLabelFontSize+"px"),i.showProgressBar&&!i.showSandBars&&!i.showWaterFill&&(B.timeLeftEl&&(B.timeLeftEl.style.fontSize=i.timeLeftFontSize+"px"),B.progressBarEl&&(B.progressBarEl.style.height=i.progressBarHeight+"px")),document.body.style.fontFamily=i.fontFamily,i.showScheduleCircles&&B.scheduleCirclesDisplayEl&&W.renderScheduleCircles())}},U={attachListeners:function(){B.addScheduleRowBtn?.addEventListener("click",U.addRow),B.deleteScheduleRowBtn?.addEventListener("click",U.deleteRow)},renderTable:function(){const i=B.scheduleTableBody;if(!i){console.error("Schedule table body not found");return}i.innerHTML="",y.normalizeScheduleContinuity(),(y.schedule||[]).forEach((d,p)=>{const s=document.createElement("tr");s.dataset.index=p,s.setAttribute("draggable","true"),p===k.selectedScheduleRowIndex&&s.classList.add("selected"),s.appendChild(U.createDragCell()),s.appendChild(U.createLabelCell(d,p)),s.appendChild(U.createTimeCell(d,p,"start")),s.appendChild(U.createTimeCell(d,p,"end")),s.appendChild(U.createSchemeCell(d,p)),s.appendChild(U.createAlertCell(d,p)),s.appendChild(U.createCirclesCell(d,p)),s.addEventListener("click",U.handleRowClick),s.addEventListener("dragstart",U.handleDragStart),s.addEventListener("dragover",U.handleDragOver),s.addEventListener("dragleave",U.handleDragLeave),s.addEventListener("drop",U.handleDrop),s.addEventListener("dragend",U.handleDragEnd),i.appendChild(s)}),i.removeEventListener("dragleave",U.handleTableDragLeave),i.addEventListener("dragleave",U.handleTableDragLeave)},createDragCell:function(){const i=document.createElement("td");return i.innerHTML="â˜°",i.className="drag-handle",i.title="Drag to reorder",i},createLabelCell:function(i,h){const d=document.createElement("td"),p=document.createElement("input");return p.type="text",p.value=i.label||"",p.placeholder="Period Label",p.addEventListener("change",function(){y.schedule&&y.schedule[h]&&(y.schedule[h].label=this.value,y.save(),G.update())}),d.appendChild(p),d},createTimeCell:function(i,h,d){const p=document.createElement("td"),s=document.createElement("input");if(s.type="time",d==="end"){const e=U.isEndLocked(h);s.value=U.getEffectiveEndValue(h,i),e?(s.readOnly=!0,s.classList.add("locked-time"),s.title="Locked to the next row's Start time"):s.addEventListener("change",function(){y.schedule&&y.schedule[h]&&(y.schedule[h].end=this.value,y.save(),G.update())})}else s.value=i.start||"00:00",s.addEventListener("change",function(){y.schedule&&y.schedule[h]&&(y.schedule[h].start=this.value,y.normalizeScheduleContinuity(),y.save(),U.renderTable(),G.update())});return p.appendChild(s),p},isEndLocked:function(i){return i>=0&&i<y.schedule.length-1},getEffectiveEndValue:function(i,h){return U.isEndLocked(i)?y.schedule[i+1]?.start||h?.end||"00:00":h?.end||"23:59"},createSchemeCell:function(i,h){const d=document.createElement("td"),p=document.createElement("div");p.className="scheme-swatch";const s=y.preferences?.colourSchemes||[],e=s.find(n=>n.id===i.colourSchemeId)||s.find(n=>n.id===1)||s[0];return p.style.backgroundColor=e?e.background:"#ff00ff",p.style.borderColor=e?e.text:"#ffffff",p.title=`Scheme: ${e?e.name:"Unknown"} (ID: ${i.colourSchemeId}). Click to cycle.`,p.addEventListener("click",n=>{n.stopPropagation(),U.cycleSchemeForRow(h)}),d.appendChild(p),d},createAlertCell:function(i,h){const d=document.createElement("td"),p=document.createElement("button"),s=y.alerts[h]?.colour?.enabled||!1;return p.innerHTML=s?"ðŸ”´":"ðŸŸ¢",p.title=`Visual Alert: ${s?"Enabled":"Disabled"}. Click to edit.`,p.className="alert-edit-btn",p.addEventListener("click",e=>{e.stopPropagation(),Q.openModal(h)}),d.appendChild(p),d.style.textAlign="center",d},createCirclesCell:function(i,h){const d=document.createElement("td"),p=document.createElement("input");return p.type="checkbox",p.checked=i.showCircles||!1,p.title="Show this period in the Schedule Circles display",p.addEventListener("change",function(s){s.stopPropagation(),y.schedule&&y.schedule[h]&&(y.schedule[h].showCircles=this.checked,y.save(),W.renderScheduleCircles())}),d.appendChild(p),d.style.textAlign="center",d},handleRowClick:function(i){const h=parseInt(this.dataset.index,10);if(i.target.tagName==="INPUT"||i.target.tagName==="BUTTON"||i.target.classList.contains("scheme-swatch")||i.target.classList.contains("drag-handle")){if(this.classList.contains("selected")){k.selectedScheduleRowIndex=h;return}}else{const d=B.scheduleTableBody?.querySelector("tr.selected");d&&d.classList.remove("selected"),this.classList.add("selected"),k.selectedScheduleRowIndex=h}},cycleSchemeForRow:function(i){if(!y.schedule||i<0||i>=y.schedule.length)return;const h=y.schedule[i].colourSchemeId||1,d=y.preferences?.colourSchemes||[];if(d.length===0)return;let s=(d.findIndex(e=>e.id===h)+1)%d.length;y.schedule[i].colourSchemeId=d[s]?.id||d[0]?.id||1,y.save(),U.renderTable(),G.update()},addRow:function(){const i=k.selectedScheduleRowIndex===null||k.selectedScheduleRowIndex<0||k.selectedScheduleRowIndex>=y.schedule.length?y.schedule.length:k.selectedScheduleRowIndex+1,h=y.schedule[i],d=y.schedule[i-1],p=h?.start||d?.start||"00:00",s=h?.start||d?.end||"23:59",e={label:"New Period",start:p,end:s,colourSchemeId:1,showCircles:!1};y.schedule.splice(i,0,e);const n={};Object.keys(y.alerts).forEach(r=>{const a=parseInt(r,10);n[a>=i?a+1:a]=y.alerts[r]}),y.alerts=n,y.normalizeScheduleContinuity(),k.selectedScheduleRowIndex=i,U.renderTable(),y.save(),G.update()},deleteRow:function(){const i=k.selectedScheduleRowIndex;if(i!==null&&i>=0&&i<y.schedule.length){if(confirm(`Delete row "${y.schedule[i].label}"?`)){y.schedule.splice(i,1),delete y.alerts[i];const h={};Object.keys(y.alerts).forEach(d=>{const p=parseInt(d,10);h[p>i?p-1:p]=y.alerts[d]}),y.alerts=h,y.normalizeScheduleContinuity(),k.selectedScheduleRowIndex=null,U.renderTable(),y.save(),G.update()}}else X.showButtonFeedback(B.deleteScheduleRowBtn,"Select Row First!",2e3)},handleDragStart:function(i){if(k.dragStartIndex=parseInt(this.dataset.index,10),!isNaN(k.dragStartIndex)&&(i.dataTransfer.effectAllowed="move",i.dataTransfer.setData("text/plain",k.dragStartIndex),this.classList.add("dragging"),!this.classList.contains("selected"))){const h=B.scheduleTableBody?.querySelector("tr.selected");h&&h.classList.remove("selected"),this.classList.add("selected"),k.selectedScheduleRowIndex=k.dragStartIndex}},handleDragOver:function(i){i.preventDefault(),i.dataTransfer.dropEffect="move",this.classList.add("drag-over")},handleDragLeave:function(i){this.classList.remove("drag-over")},handleDrop:function(i){i.preventDefault(),this.classList.remove("drag-over");const h=parseInt(this.dataset.index,10),d=k.dragStartIndex;if(d!==null&&!isNaN(h)&&d!==h){const p=y.schedule.splice(d,1)[0];y.schedule.splice(h,0,p);const s=y.alerts[d],e={};Object.keys(y.alerts).forEach(n=>{const r=parseInt(n,10);if(r===d)return;let a=r;d<r&&h>=r?a--:d>r&&h<=r&&a++,e[a]=y.alerts[n]}),s&&(e[h]=s),y.alerts=e,y.normalizeScheduleContinuity(),k.selectedScheduleRowIndex=h,U.renderTable(),y.save(),G.update()}k.dragStartIndex=null},handleDragEnd:function(i){this.classList.remove("dragging"),document.querySelectorAll("#schedule-table tbody tr.drag-over").forEach(h=>{h.classList.remove("drag-over")}),k.dragStartIndex=null},handleTableDragLeave:function(i){B.scheduleTableBody&&!B.scheduleTableBody.contains(i.relatedTarget)&&document.querySelectorAll("#schedule-table tbody tr.drag-over").forEach(h=>{h.classList.remove("drag-over")})}},Q={attachListeners:function(){B.alertModal?.addEventListener("click",i=>{(i.target===B.alertModal||B.closeModalBtn&&i.target===B.closeModalBtn)&&Q.closeModal()})},openModal:function(i){if(i===null||i<0||!y.schedule||i>=y.schedule.length)return;const h=y.schedule[i]?.label||`Row ${i+1}`;B.alertModalTitle&&(B.alertModalTitle.textContent=`Visual Alert Settings for "${h}"`),Q.renderModalForm(i),B.alertModal&&(B.alertModal.style.display="block")},closeModal:function(){B.alertModal&&(B.alertModal.style.display="none"),B.alertModalBody&&(B.alertModalBody.innerHTML="")},renderModalForm:function(i){if(!B.alertModalBody||!y.schedule||i>=y.schedule.length)return;const h=y.defaultPreferences?.defaultAlertSettings?.colour||{},d=y.alerts[i]?.colour||{},p={...h,...d},s=p.durationMs||h.durationMs||1500,e=p.intervalMs||h.intervalMs||500,n=s/1e3,r=!!y.alerts[i]?.colour;B.alertModalBody.innerHTML=`
            <div class="alert-settings-form" data-index="${i}">
            <label><input type="checkbox" id="alert-colour-enabled" ${p.enabled?"checked":""}> Enable Visual Alert</label><hr>
            <label>Flash Background Colour: <input type="color" id="alert-bg-color" value="${p.background}"></label>
            <label>Flash Text Colour: <input type="color" id="alert-label-color" value="${p.text}"></label>
            <label>Flash Duration (s): <input type="number" id="alert-flash-duration-sec" min="0.5" max="10" step="0.1" value="${n.toFixed(1)}"></label>
            <label>Flash Interval (ms): <input type="number" id="alert-flash-interval" min="100" max="2000" step="50" value="${e}"></label>
            <div class="button-group">
                <button id="save-alert" data-option="colour">Save Visual Alert</button>
                <button id="preview-alert" data-option="colour">Preview Flash</button>
                <button id="remove-alert" data-option="colour" ${r?"":"disabled"}>${p.enabled?"Disable Alert":r?"Remove Custom Settings":"Using Defaults"}</button>
            </div>
            <div class="feedback-message" style="display: none;"></div></div>`;const a=B.alertModalBody.querySelector(".alert-settings-form");a?.querySelector("#alert-colour-enabled")?.addEventListener("change",Q.handleModalEnableToggle),a?.querySelector("#save-alert")?.addEventListener("click",Q.handleModalSave),a?.querySelector("#preview-alert")?.addEventListener("click",Q.handleModalPreview),a?.querySelector("#remove-alert")?.addEventListener("click",Q.handleModalRemove),Q.updateModalControlsState(a,p.enabled,r)},handleModalEnableToggle:function(i){const h=i.target.closest(".alert-settings-form"),d=i.target.checked,p=parseInt(h.dataset.index,10);Q.updateModalControlsState(h,d,!!y.alerts[p]?.colour)},updateModalControlsState:function(i,h,d){if(!i)return;const p=i.querySelectorAll('input[type="color"], input[type="number"]'),s=i.querySelector("#preview-alert"),e=i.querySelector("#remove-alert");p.forEach(n=>n.disabled=!h),s&&(s.disabled=!h),e&&(e.disabled=!d,e.textContent=h?"Disable Alert":d?"Remove Custom Settings":"Using Defaults")},handleModalSave:function(){const i=this.closest(".alert-settings-form");if(!i)return;const h=parseInt(i.dataset.index,10);if(isNaN(h))return;const d=i.querySelector("#alert-colour-enabled"),p=i.querySelector("#alert-flash-duration-sec"),s=i.querySelector("#alert-flash-interval"),e=i.querySelector("#alert-bg-color"),n=i.querySelector("#alert-label-color");if(i.querySelector(".feedback-message"),!d||!p||!s||!e||!n){console.error("Modal form elements not found for saving.");return}y.alerts[h]||(y.alerts[h]={});const r=y.defaultPreferences?.defaultAlertSettings?.colour||{},a=r.durationMs||1500,u=r.intervalMs||500;let c=parseFloat(p.value);c=isNaN(c)?a/1e3:Math.max(.5,Math.min(10,c));let m=parseInt(s.value,10);m=isNaN(m)?u:Math.max(100,Math.min(2e3,m));let l={enabled:d.checked,background:e.value||r.background||"#ff0000",text:n.value||r.text||"#ffffff",durationMs:Math.round(c*1e3),intervalMs:m};y.alerts[h].colour=l,y.save(),U.renderTable(),X.showButtonFeedback(this,"Saved!"),setTimeout(Q.closeModal,1600)},handleModalPreview:function(){const i=this.closest(".alert-settings-form");if(!i)return;const h=i.querySelector("#alert-colour-enabled"),d=i.querySelector(".feedback-message");if(!h||!h.checked){X.showFeedback(d,"Enable the alert first to preview.",!1);return}const p=parseFloat(i.querySelector("#alert-flash-duration-sec")?.value),s=parseInt(i.querySelector("#alert-flash-interval")?.value,10);if(isNaN(p)||isNaN(s)){X.showFeedback(d,"Invalid duration or interval value.",!1);return}let e={enabled:!0,background:i.querySelector("#alert-bg-color")?.value||"#ff0000",text:i.querySelector("#alert-label-color")?.value||"#ffffff",durationMs:Math.round(p*1e3),intervalMs:s};Q.triggerVisualAlert(e),X.showFeedback(d,"Previewing flash...",!0)},handleModalRemove:function(){const i=this.closest(".alert-settings-form");if(!i)return;const h=parseInt(i.dataset.index,10),d=i.querySelector("#alert-colour-enabled"),p=i.querySelector(".feedback-message");isNaN(h)||h>=y.schedule.length||(y.alerts[h]?.colour?d.checked?(d.checked=!1,Q.updateModalControlsState(i,!1,!0),X.showFeedback(p,"Alert disabled. Click Save to confirm.",!0)):confirm(`Remove custom visual alert settings for "${y.schedule[h].label}"? It will revert to defaults.`)&&(delete y.alerts[h].colour,Object.keys(y.alerts[h]).length===0&&delete y.alerts[h],y.save(),U.renderTable(),Q.closeModal()):(X.showFeedback(p,"No custom settings to remove. Using defaults.",!0),this&&(this.disabled=!0,this.textContent="Using Defaults")))},triggerVisualAlert:function(i){Q.clearVisualAlert();const{background:h,text:d,durationMs:p,intervalMs:s}=i,e=y.getActiveColourScheme();k.originalBodyStyles={background:document.body.style.backgroundColor,color:document.body.style.color,timeColor:B.timeEl?.style.color||"",dateColor:B.dateEl?.style.color||"",labelColor:B.periodLabelEl?.style.color||"",progressColor:B.progressEl?.style.backgroundColor||"",timeLeftColor:B.timeLeftEl?.style.color||""};let n=!1;const r=()=>{n=!n;const a=n?h:e.background,u=n?d:e.text;document.body.style.backgroundColor=a,document.body.style.color=u,B.timeEl&&y.preferences.showTime&&(B.timeEl.style.color=u),B.dateEl&&y.preferences.showDate&&(B.dateEl.style.color=u),B.periodLabelEl&&y.preferences.showScheduleLabel&&(B.periodLabelEl.style.color=u),B.progressEl&&y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill&&(B.progressEl.style.backgroundColor=u),B.timeLeftEl&&y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill&&(B.timeLeftEl.style.color=u),B.scheduleCirclesDisplayEl&&y.preferences.showScheduleCircles&&B.scheduleCirclesDisplayEl.querySelectorAll(".schedule-circle-symbol.active").forEach(c=>c.style.color=u)};r(),k.activeVisualAlertInterval=setInterval(r,s),k.activeVisualAlertTimeout=setTimeout(()=>{Q.clearVisualAlert(),Q.restoreOriginalStyles(e)},p)},clearVisualAlert:function(){clearTimeout(k.activeVisualAlertTimeout),clearInterval(k.activeVisualAlertInterval),k.activeVisualAlertInterval=null,k.activeVisualAlertTimeout=null},restoreOriginalStyles:function(i=null){const h=i||y.getActiveColourScheme();document.body.style.backgroundColor=h.background,document.body.style.color=h.text,B.timeEl&&y.preferences.showTime&&(B.timeEl.style.color=h.text),B.dateEl&&y.preferences.showDate&&(B.dateEl.style.color=h.text),B.periodLabelEl&&y.preferences.showScheduleLabel&&(B.periodLabelEl.style.color=h.text),B.progressEl&&y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill&&(B.progressEl.style.backgroundColor=h.text),B.timeLeftEl&&y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill&&(B.timeLeftEl.style.color=h.text),y.preferences.showScheduleCircles&&W.renderScheduleCircles()}},G={updateIntervalId:null,start:function(){G.updateIntervalId&&clearInterval(G.updateIntervalId),G.updateIntervalId=setInterval(G.update,1e3),G.update(),console.log("Clock started.")},stop:function(){G.updateIntervalId&&(clearInterval(G.updateIntervalId),G.updateIntervalId=null,console.log("Clock stopped."))},getCurrentPeriodInfo:function(i){if(!y.schedule||y.schedule.length===0)return null;for(let h=0;h<y.schedule.length;h++){const d=y.schedule[h];if(!(!d||typeof d.start!="string"||typeof d.end!="string"))try{const p=X.getTodayTime(d.start),s=X.getTodayTime(d.end);let e=new Date(s.getTime()),n=!1;s.getTime()<=p.getTime()&&(n=!0,s.getHours()===0&&s.getMinutes()===0&&s.getSeconds()===0?(e=X.getTodayTime(d.start),e.setDate(e.getDate()+1),e.setHours(0,0,0,0)):e.setDate(e.getDate()+1));let r=!1;if(n){const a=new Date(p);a.setHours(24,0,0,0);const u=new Date(p);u.setDate(u.getDate()+1),u.setHours(0,0,0,0),(i>=p&&i<a||i>=u&&i<e)&&(r=!0)}else i>=p&&i<e&&(r=!0);if(!r&&(d.end==="23:59"||d.end==="23:59:59")){const a=new Date(p);a.setHours(23,59,59,999),i>=p&&i<=a&&(r=!0,e=a)}if(r)return{label:d.label,start:p,end:e,index:h}}catch(p){console.error("Error processing period:",d?.label,d?.start,d?.end,p)}}return null},update:function(){if(!y||!ce||!Q||!W||!k||!B){console.error("Core modules not available in Clock.update");return}const i=le(),h=y.getActiveColourScheme();ce.update(),k.activeVisualAlertInterval||Q.restoreOriginalStyles(h),y.preferences.showTime&&B.timeEl&&(B.timeEl.textContent=X.formatTime(i)),y.preferences.showDate&&B.dateEl&&(B.dateEl.textContent=X.formatDate(i)),W.update(i);const d=G.getCurrentPeriodInfo(i),p=d?d.index:null;p!==k.currentPeriodIndex&&(k.currentPeriodLabel=d?d.label:null,k.currentPeriodIndex=p,d&&y.alerts[d.index]?.colour?.enabled?Q.triggerVisualAlert(y.alerts[d.index].colour):k.activeVisualAlertInterval&&(Q.clearVisualAlert(),Q.restoreOriginalStyles()),W.handlePeriodChange(d)),G.updatePeriodDisplay(i,d)},updatePeriodDisplay:function(i,h){if(B.periodLabelEl)if(h)if(y.preferences.showScheduleLabel?B.periodLabelEl.textContent=h.label:B.periodLabelEl.textContent="",y.preferences.showProgressBar&&!y.preferences.showSandBars&&!y.preferences.showWaterFill){if(B.progressEl&&B.progressBarEl&&B.timeLeftEl){const d=h.start.getTime(),p=h.end.getTime(),s=i.getTime(),e=p-d,n=Math.max(0,s-d);if(e>0){const r=Math.min(100,Math.max(0,n/e*100));B.progressEl.style.width=r+"%";const a=B.progressBarEl.offsetWidth,u=B.timeLeftEl.offsetWidth>0?B.timeLeftEl.offsetWidth:60;let c=r/100*a-u/2;c=Math.max(0,Math.min(a-u,c)),B.timeLeftEl.style.left=c+"px";const m=Math.max(0,p-s),l=Math.floor(m/1e3),t=Math.floor(l/60),o=l%60;B.timeLeftEl.textContent=`${t}:${o<10?"0"+o:o}`}else{B.progressEl.style.width=s>=d?"100%":"0%",B.timeLeftEl.textContent="0:00";const r=B.progressBarEl.offsetWidth,a=B.timeLeftEl.offsetWidth>0?B.timeLeftEl.offsetWidth:60;B.timeLeftEl.style.left=`${r-a}px`}}}else B.progressEl&&(B.progressEl.style.width="0%"),B.timeLeftEl&&(B.timeLeftEl.textContent="");else B.periodLabelEl&&(B.periodLabelEl.textContent=""),B.progressEl&&y.preferences.showProgressBar&&(B.progressEl.style.width="0%"),B.timeLeftEl&&y.preferences.showProgressBar&&(B.timeLeftEl.textContent="")}},ft=new Set(["Atkinson Hyperlegible Next","Arial","Helvetica","Times New Roman","Courier New","Verdana","Tahoma","Trebuchet MS","Georgia","Palatino","Garamond","Comic Sans MS","Impact","Lucida Console","Digital-7","OCR A Std","Monaco"]),y={schedule:[{label:"Before",start:"00:00",end:"08:50",colourSchemeId:1,showCircles:!1},{label:"Period 1",start:"08:50",end:"10:05",colourSchemeId:1,showCircles:!0},{label:"Break",start:"10:05",end:"10:15",colourSchemeId:2,showCircles:!1},{label:"Period 2",start:"10:15",end:"11:30",colourSchemeId:1,showCircles:!0},{label:"Lunch",start:"11:30",end:"12:20",colourSchemeId:2,showCircles:!1},{label:"Period 3",start:"12:20",end:"13:35",colourSchemeId:1,showCircles:!0},{label:"Break",start:"13:35",end:"13:45",colourSchemeId:2,showCircles:!1},{label:"Period 4",start:"13:45",end:"15:00",colourSchemeId:1,showCircles:!0},{label:"After",start:"15:00",end:"23:59",colourSchemeId:1,showCircles:!1}],preferences:{},alerts:{},defaultPreferences:{fontFamily:"Atkinson Hyperlegible Next",dateFontSize:64,timeFontSize:200,scheduleLabelFontSize:48,timeLeftFontSize:40,progressBarHeight:120,timeOffsetMs:0,showDate:!0,showTime:!0,showScheduleLabel:!0,showProgressBar:!0,showScheduleCircles:!1,showSandBars:!1,showWaterFill:!1,sandWidth:80,sandHeight:150,sandParticleSize:5,colourSchemes:[{id:1,name:"Default Dark",background:"#000000",text:"#FFFFFF"},{id:2,name:"Default Light",background:"#F0F0F0",text:"#000000"}],defaultAlertSettings:{colour:{enabled:!1,background:"#ff0000",text:"#ffffff",durationMs:1500,intervalMs:500}}},normalizeScheduleContinuity:function(){if(!Array.isArray(y.schedule)||y.schedule.length===0)return;for(let d=0;d<y.schedule.length-1;d++){const p=y.schedule[d],s=y.schedule[d+1];!p||!s||(typeof s.start=="string"&&s.start.length>0?p.end=s.start:(typeof p.end!="string"||p.end.length===0)&&(p.end="00:00"))}const i=y.schedule.length-1,h=y.schedule[i];h&&(typeof h.end!="string"||h.end.length===0)&&(h.end="23:59")},load:function(){y.preferences=JSON.parse(JSON.stringify(y.defaultPreferences));const i=JSON.parse(JSON.stringify(y.schedule));y.alerts={};const h=localStorage.getItem("clockSchedule");let d=!1;if(h)try{const e=JSON.parse(h);Array.isArray(e)&&e.length>0&&(y.schedule=e.map(n=>({label:n.label||"Unnamed",start:n.start||"00:00",end:n.end||"00:00",colourSchemeId:n.colourSchemeId||1,showCircles:typeof n.showCircles=="boolean"?n.showCircles:!1})),d=!0)}catch(e){console.error("Error parsing saved schedule.",e)}d||(y.schedule=i),y.normalizeScheduleContinuity();const p=localStorage.getItem("clockPreferences");if(p)try{const e=JSON.parse(p);if(typeof e=="object"&&e!==null){const n={...JSON.parse(JSON.stringify(y.defaultPreferences)),...e,defaultAlertSettings:{colour:{...y.defaultPreferences.defaultAlertSettings.colour,...e.defaultAlertSettings?.colour||{}}},colourSchemes:e.colourSchemes&&Array.isArray(e.colourSchemes)&&e.colourSchemes.length>0?e.colourSchemes.map(r=>({id:r.id||Date.now()+Math.random(),name:r.name||"Unnamed Scheme",background:r.background||"#000000",text:r.text||"#FFFFFF"})):y.defaultPreferences.colourSchemes};for(const r of["showDate","showTime","showScheduleLabel","showProgressBar","showScheduleCircles","showSandBars","showWaterFill"])typeof n[r]!="boolean"&&(n[r]=y.defaultPreferences[r]);for(const r of["dateFontSize","timeFontSize","scheduleLabelFontSize","timeLeftFontSize","progressBarHeight","sandWidth","sandHeight","sandParticleSize"])n[r]=Number(n[r])||y.defaultPreferences[r];n.timeOffsetMs=Number(n.timeOffsetMs)||0,n.fontFamily==="Atkinson Hyperlegible"&&(n.fontFamily="Atkinson Hyperlegible Next"),ft.has(n.fontFamily)||(n.fontFamily=y.defaultPreferences.fontFamily),n.showSandBars&&n.showWaterFill&&(n.showWaterFill=!1),n.showProgressBar&&(n.showSandBars||n.showWaterFill)&&(n.showProgressBar=!1),n.sandWidth=Math.max(10,Math.min(100,n.sandWidth)),n.sandHeight=Math.max(50,Math.min(800,n.sandHeight)),n.sandParticleSize=Math.max(1,Math.min(20,n.sandParticleSize)),y.preferences=n}}catch(e){console.error("Error parsing saved preferences.",e)}const s=localStorage.getItem("clockAlerts");if(s)try{const e=JSON.parse(s);typeof e=="object"&&e!==null&&(y.alerts=e,Object.keys(y.alerts).forEach(n=>{y.alerts[n]?.noise&&delete y.alerts[n].noise,y.alerts[n]&&typeof y.alerts[n]=="object"&&Object.keys(y.alerts[n]).length===0&&delete y.alerts[n]}))}catch(e){console.error("Error parsing saved alerts settings.",e)}console.log("Settings loaded")},save:function(){try{y.normalizeScheduleContinuity(),y.preferences.hasOwnProperty("sandDropInterval")&&delete y.preferences.sandDropInterval;const i={};Object.keys(y.alerts).forEach(d=>{y.alerts[d]&&typeof y.alerts[d]=="object"&&Object.keys(y.alerts[d]).length>0&&(i[d]=y.alerts[d])});const h=y.schedule.map(d=>({label:d.label,start:d.start,end:d.end,colourSchemeId:d.colourSchemeId,showCircles:d.showCircles}));localStorage.setItem("clockSchedule",JSON.stringify(h)),localStorage.setItem("clockPreferences",JSON.stringify(y.preferences)),localStorage.setItem("clockAlerts",JSON.stringify(i))}catch(i){console.error("Error saving settings:",i)}},getActiveColourScheme:function(){const i=le(),h=typeof G<"u"?G.getCurrentPeriodInfo(i):null;let d=1;if(h&&h.index!==void 0&&y.schedule[h.index]){const e=y.schedule[h.index];e.colourSchemeId&&(d=e.colourSchemeId)}const p=y.preferences?.colourSchemes||y.defaultPreferences.colourSchemes;let s=p.find(e=>e.id===d);return s||(s=p.find(e=>e.id===1)),s||(s=p[0]),s||{id:0,name:"Error",background:"#ff00ff",text:"#000000"}}},re={attachListeners:function(){B.colorSchemeContentContainer?.addEventListener("click",re.handleContentClick),B.colorSchemeContentContainer?.addEventListener("input",re.handleContentInput)},renderTabs:function(){const i=B.colorSchemeTabsContainer,h=B.colorSchemeContentContainer;if(!i||!h)return;i.innerHTML="",(y.preferences?.colourSchemes||[]).forEach((e,n)=>{const r=document.createElement("button");r.className="colour-tab",r.textContent=e.name||`Scheme ${e.id}`,r.dataset.id=e.id,r.dataset.index=n,r.addEventListener("click",function(){i.querySelectorAll(".colour-tab.active").forEach(a=>a.classList.remove("active")),this.classList.add("active"),re.renderContent(n)}),i.appendChild(r)});const p=document.createElement("button");p.className="colour-tab add-colour",p.textContent="+",p.title="Add New Colour Scheme",p.addEventListener("click",re.addScheme),i.appendChild(p);const s=i.querySelector(".colour-tab:not(.add-colour)");s?s.click():h.innerHTML="<p>No colour schemes defined. Click '+' to add one.</p>"},renderContent:function(i){const h=B.colorSchemeContentContainer,d=y.preferences?.colourSchemes||[];if(!h||i<0||i>=d.length)return;const p=d[i];if(!p)return;const s=d.length>1&&p.id!==1&&p.id!==2,e=`
            <button
                id="delete-scheme-${i}"
                data-index="${i}"
                ${s?"":'disabled title="Cannot delete default schemes or the last remaining scheme"'}>
                Delete Scheme
            </button>`;h.innerHTML=`
          <div class="colour-scheme-form">
            <label>Scheme Name: <input type="text" id="scheme-name-${i}" value="${p.name||""}"></label>
            <label>Background Colour: <input type="color" id="scheme-bg-color-${i}" value="${p.background||"#000000"}"></label>
            <label>Main Text Colour (Date, Time, Label, Progress, Active Circles): <input type="color" id="scheme-text-color-${i}" value="${p.text||"#ffffff"}"></label>
            <button id="save-scheme-settings-${i}" data-index="${i}">Save Scheme</button>
            ${s?e:""}
             <div class="feedback-message" style="display: none;"></div>
           </div>`},handleContentInput:function(i){const h=i.target,d=h.closest(".colour-scheme-form");if(!d||!h.id||!(h.id.startsWith("scheme-name")||h.id.startsWith("scheme-bg-color")||h.id.startsWith("scheme-text-color")))return;const p=d.querySelector('button[id^="save-scheme-settings"]');if(!p)return;const s=parseInt(p.dataset.index,10);if(!isNaN(s)&&s>=0&&s<y.preferences.colourSchemes.length){const e=y.preferences.colourSchemes[s];h.id.startsWith("scheme-name")&&(e.name=h.value),h.id.startsWith("scheme-bg-color")&&(e.background=h.value),h.id.startsWith("scheme-text-color")&&(e.text=h.value);const n=B.colorSchemeTabsContainer?.querySelector(`.colour-tab[data-index="${s}"]`);n&&h.id.startsWith("scheme-name")&&(n.textContent=h.value||`Scheme ${e.id}`),G.update()}},handleContentClick:function(i){const h=i.target;if(h.tagName!=="BUTTON"||!h.id||!h.closest(".colour-scheme-form"))return;const d=parseInt(h.dataset.index,10);if(h.closest(".colour-scheme-form")?.querySelector(".feedback-message"),!isNaN(d))if(h.id.startsWith("save-scheme-settings")){y.save(),X.showButtonFeedback(h,"Saved!");const p=B.colorSchemeTabsContainer?.querySelector(`.colour-tab[data-index="${d}"]`);p&&!p.classList.contains("active")&&(B.colorSchemeTabsContainer?.querySelectorAll(".colour-tab.active").forEach(s=>s.classList.remove("active")),p.classList.add("active"))}else h.id.startsWith("delete-scheme")&&re.deleteScheme(d,h)},addScheme:function(){const i=(y.preferences.colourSchemes.reduce((p,s)=>Math.max(p,s.id||0),0)||0)+1,h={id:i,name:"New Scheme "+i,background:"#222222",text:"#EEEEEE"};y.preferences.colourSchemes.push(h),y.save(),re.renderTabs(),B.colorSchemeTabsContainer?.querySelector(`.colour-tab[data-id="${i}"]`)?.click()},deleteScheme:function(i,h){const d=y.preferences.colourSchemes;if(i<0||i>=d.length)return;const p=d[i];if(d.length>1&&p.id!==1&&p.id!==2){if(confirm(`Delete scheme "${p.name||`Scheme ${i+1}`}"? Periods using it will revert to Scheme 1.`)){const e=p.id;d.splice(i,1),y.schedule.forEach(n=>{n.colourSchemeId===e&&(n.colourSchemeId=1)}),y.save(),U.renderTable(),re.renderTabs(),G.update()}}else alert("Cannot delete default schemes or the last remaining scheme.")},resetDefaults:function(){confirm("Reset ALL Colour Schemes to the defaults? This cannot be undone.")&&(y.preferences.colourSchemes=JSON.parse(JSON.stringify(y.defaultPreferences.colourSchemes)),y.schedule.forEach(i=>i.colourSchemeId=1),y.save(),U.renderTable(),re.renderTabs(),G.update(),X.showButtonFeedback(B.resetSchemesBtn,"Reset!"))}},ue={attachListeners:function(){B.fontSelect?.addEventListener("input",function(){y.preferences&&(y.preferences.fontFamily=this.value,ce.applyFontAndSizePreferences(),y.save())}),document.querySelectorAll(".number-input-wrapper").forEach(i=>{const h=i.querySelector('input[type="number"]'),d=i.querySelector(".num-btn.minus"),p=i.querySelector(".num-btn.plus");if(!h||!h.dataset||!h.dataset.pref||!d||!p)return;const s=h.dataset.pref;let e=null,n=null;const r=500,a=100;if(!y.preferences||!y.defaultPreferences||!y.preferences.hasOwnProperty(s)){console.warn(`Preference key "${s}" not found in settings for input ${h.id}`);return}const u=t=>{if(!y.preferences.hasOwnProperty(s))return;parseInt(h.step);const o=h.min?parseInt(h.min,10):-1/0,f=h.max?parseInt(h.max,10):1/0;let g=parseInt(t,10);g=isNaN(g)?y.defaultPreferences[s]:Math.max(o,Math.min(f,g)),y.preferences[s]!==g&&(y.preferences[s]=g,h.value=g,ce.applyFontAndSizePreferences(),["sandWidth","sandHeight","sandParticleSize"].includes(s)&&(console.log(`Physics fill pref changed (${s}), triggering physics setup...`),requestAnimationFrame(()=>{W.handleDisplayToggle()})),y.save())},c=t=>{u(parseInt(h.value,10)+t),m(),n=setTimeout(()=>{e=setInterval(()=>{u(parseInt(h.value,10)+t)},a)},r)},m=()=>{clearTimeout(n),clearInterval(e),n=e=null};h.addEventListener("change",()=>u(h.value)),d.addEventListener("mousedown",()=>c(-(parseInt(h.step)||1))),p.addEventListener("mousedown",()=>c(parseInt(h.step)||1)),["mouseup","mouseleave","blur","touchend","touchcancel"].forEach(t=>{d.addEventListener(t,m),p.addEventListener(t,m)})}),B.displayElementsChecklist?.querySelectorAll('input[type="checkbox"]').forEach(i=>{i.addEventListener("change",ue.handleDisplayToggleChange)}),B.resetAppearanceBtn?.addEventListener("click",ue.resetFontAndSizeDefaults),B.resetSchemesBtn?.addEventListener("click",re.resetDefaults),document.getElementById("reset-sandbar-defaults")?.addEventListener("click",ue.resetSandBarDefaults)},handleDisplayToggleChange:function(){const i=this.dataset.pref;if(!i||!y.preferences||!y.preferences.hasOwnProperty(i))return;y.preferences[i]=this.checked;const h=B.displayElementsChecklist?.querySelector("#pref-show-progress-bar"),d=B.displayElementsChecklist?.querySelector("#pref-show-sand-bars"),p=B.displayElementsChecklist?.querySelector("#pref-show-water-fill"),s=()=>{y.preferences.showProgressBar&&(y.preferences.showProgressBar=!1,h&&(h.checked=!1))},e=()=>{y.preferences.showSandBars&&(y.preferences.showSandBars=!1,d&&(d.checked=!1))},n=()=>{y.preferences.showWaterFill&&(y.preferences.showWaterFill=!1,p&&(p.checked=!1))};i==="showSandBars"&&this.checked?(s(),n()):i==="showWaterFill"&&this.checked?(s(),e()):i==="showProgressBar"&&this.checked&&(e(),n()),document.getElementById("sand-bar-options")?.classList.toggle("element-hidden",!(y.preferences.showSandBars||y.preferences.showWaterFill)),ce.update(),W.handleDisplayToggle(),y.save()},updateInputs:function(){if(!y.preferences)return;B.fontSelect&&(B.fontSelect.value=y.preferences.fontFamily),B.dateFontSizeInput&&(B.dateFontSizeInput.value=y.preferences.dateFontSize),B.timeFontSizeInput&&(B.timeFontSizeInput.value=y.preferences.timeFontSize),B.labelFontSizeInput&&(B.labelFontSizeInput.value=y.preferences.scheduleLabelFontSize),B.timeLeftFontSizeInput&&(B.timeLeftFontSizeInput.value=y.preferences.timeLeftFontSize),B.progressHeightInput&&(B.progressHeightInput.value=y.preferences.progressBarHeight),B.displayElementsChecklist?.querySelectorAll('input[type="checkbox"]').forEach(h=>{const d=h.dataset.pref;d&&y.preferences.hasOwnProperty(d)&&(h.checked=y.preferences[d])});const i=document.getElementById("sand-bar-options");if(i){i.classList.toggle("element-hidden",!(y.preferences.showSandBars||y.preferences.showWaterFill));const h=i.querySelector("#pref-sand-width"),d=i.querySelector("#pref-sand-height"),p=i.querySelector("#pref-sand-particle-size");h&&(h.value=y.preferences.sandWidth),d&&(d.value=y.preferences.sandHeight),p&&(p.value=y.preferences.sandParticleSize)}},resetFontAndSizeDefaults:function(){if(confirm("Reset Font & Size settings to defaults?")){if(!y.preferences||!y.defaultPreferences)return;y.preferences.fontFamily=y.defaultPreferences.fontFamily,y.preferences.dateFontSize=y.defaultPreferences.dateFontSize,y.preferences.timeFontSize=y.defaultPreferences.timeFontSize,y.preferences.scheduleLabelFontSize=y.defaultPreferences.scheduleLabelFontSize,y.preferences.timeLeftFontSize=y.defaultPreferences.timeLeftFontSize,y.preferences.progressBarHeight=y.defaultPreferences.progressBarHeight,ue.updateInputs(),ce.applyFontAndSizePreferences(),y.save(),X.showButtonFeedback(B.resetAppearanceBtn,"Reset!")}},resetSandBarDefaults:function(){if(confirm("Reset Physics Fill settings to defaults?")){if(!y.preferences||!y.defaultPreferences)return;y.preferences.sandWidth=y.defaultPreferences.sandWidth,y.preferences.sandHeight=y.defaultPreferences.sandHeight,y.preferences.sandParticleSize=y.defaultPreferences.sandParticleSize,ue.updateInputs(),(y.preferences.showSandBars||y.preferences.showWaterFill)&&requestAnimationFrame(()=>{W.handleDisplayToggle()}),y.save(),X.showButtonFeedback(document.getElementById("reset-sandbar-defaults"),"Reset!")}}},te={attachListeners:function(){B.syncToBellBtn?.addEventListener("click",te.syncToNearestBell),B.resetOffsetBtn?.addEventListener("click",te.resetOffset),te.addManualOffsetListener(B.offsetMinDownBtn,-6e4),te.addManualOffsetListener(B.offsetMinUpBtn,6e4),te.addManualOffsetListener(B.offsetSecDownBtn,-1e3),te.addManualOffsetListener(B.offsetSecUpBtn,1e3)},addManualOffsetListener:function(i,h){i&&i.addEventListener("click",()=>te.adjustOffset(h))},adjustOffset:function(i){typeof y.preferences.timeOffsetMs!="number"&&(y.preferences.timeOffsetMs=0),y.preferences.timeOffsetMs+=i,te.updateOffsetDisplay(),G.update(),y.save()},resetOffset:function(){y.preferences.timeOffsetMs!==0?(y.preferences.timeOffsetMs=0,te.updateOffsetDisplay(),G.update(),y.save(),X.showButtonFeedback(B.resetOffsetBtn,"Offset Reset!",1500)):X.showButtonFeedback(B.resetOffsetBtn,"Already Zero!",1e3)},syncToNearestBell:function(){if(!y.schedule||y.schedule.length===0){X.showButtonFeedback(B.syncToBellBtn,"Add Schedule First!",2e3);return}const h=new Date().getTime();let d=1/0,p=null;if(y.schedule.forEach(s=>{if(!(!s||!s.start||!s.end||!/^\d{2}:\d{2}$/.test(s.start)||!/^\d{2}:\d{2}$/.test(s.end)))try{const e=X.getTodayTime(s.start),n=X.getTodayTime(s.end),r=e.getTime(),a=n.getTime();let u=Math.abs(r-h);if(u<d&&(d=u,p=e),!y.schedule.some(m=>m.start===s.end)){let m=Math.abs(a-h);m<d&&(d=m,p=n)}}catch(e){console.error("Sync error parsing time for period:",s.label,e)}}),p!==null){const s=p.getTime()-h;y.preferences.timeOffsetMs=s,te.updateOffsetDisplay(),G.update(),y.save(),X.showButtonFeedback(B.syncToBellBtn,"Synced!")}else X.showButtonFeedback(B.syncToBellBtn,"No Valid Times!",2e3)},updateOffsetDisplay:function(){const i=Number(y.preferences?.timeOffsetMs)||0,h=Math.round(i/1e3),d=h>=0?"+":"-",p=Math.abs(h),s=Math.floor(p/60),e=p%60,n=e<10?"0"+e:e,r=`${d}${s}m ${n}s`;B.currentOffsetDisplay&&(B.currentOffsetDisplay.textContent=r)}},fe={init:function(){console.log("Classroom Clock Initializing..."),Je(),y.load(),ue.updateInputs(),re.renderTabs(),U.renderTable(),te.updateOffsetDisplay(),ue.attachListeners(),re.attachListeners(),U.attachListeners(),Q.attachListeners(),te.attachListeners(),fe.attachGlobalListeners(),ce.update(),W.handleDisplayToggle(),G.start(),console.log("Classroom Clock Initialized.")},attachGlobalListeners:function(){B.menuToggle?.addEventListener("click",()=>{const i=B.settingsMenu?.classList.toggle("open");B.menuToggle&&(B.menuToggle.innerHTML=i?"â–²":"â–¼")}),B.menuResizer?.addEventListener("mousedown",fe.handleResizeMouseDown),document.addEventListener("mousemove",fe.handleResizeMouseMove),document.addEventListener("mouseup",fe.handleResizeMouseUp),document.addEventListener("mouseleave",fe.handleResizeMouseUp),B.tabsContainer?.querySelectorAll(".tab-button").forEach(i=>{i.addEventListener("click",fe.handleTabClick)})},handleTabClick:function(){if(!B.tabsContainer||!B.tabContentsContainer)return;B.tabsContainer.querySelectorAll(".tab-button.active").forEach(h=>h.classList.remove("active")),B.tabContentsContainer.querySelectorAll(".tab-content.active").forEach(h=>h.classList.remove("active")),this.classList.add("active");const i=this.getAttribute("data-tab");if(i){const h=B.tabContentsContainer.querySelector(`#${i}`);h&&h.classList.add("active")}},handleResizeMouseDown:function(i){k.isResizingMenu=!0,document.body.style.cursor="ew-resize",document.body.style.userSelect="none",document.body.style.setProperty("-webkit-user-select","none")},handleResizeMouseMove:function(i){if(!k.isResizingMenu||!B.settingsMenu)return;const h=window.innerWidth-i.clientX,d=400,p=Math.min(950,window.innerWidth-50);h>=d&&h<=p&&(B.settingsMenu.style.width=h+"px")},handleResizeMouseUp:function(i){k.isResizingMenu&&(k.isResizingMenu=!1,document.body.style.cursor="default",document.body.style.userSelect="",document.body.style.removeProperty("-webkit-user-select"))}};document.addEventListener("DOMContentLoaded",fe.init);
